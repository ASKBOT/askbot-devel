{"id":"askbot-master-0ae","title":"Audit task file: markdown-mathjax-implementation-v2.md","description":"Analyze tasks/markdown-mathjax-implementation-v2.md - ACTIVE mathjax spec using Stack Exchange approach. This is the current implementation plan.","notes":"## Audit Instructions\n\n**Before starting:**\n1. Read `tasks/markdown-upgrade-status.md` to understand the document structure and current state\n\n**When completing this audit:**\n1. **Add findings to this bd issue** using `bd comments add \u003cissue-id\u003e` with key observations\n2. **Edit ONLY your relevant section** in `tasks/markdown-upgrade-status.md` - do NOT overwrite the entire file\n3. **Reference this issue ID** (e.g., `askbot-master-xxx`) in the status file where you add findings\n4. **Update the Audit Trail table** at the bottom - change your row status from `pending` to `done`\n5. When complete, close this issue with `bd close \u003cissue-id\u003e`\n\n**Important:** Use the Edit tool to modify specific sections. Do not use Write to replace the whole file.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:16:43.563925-03:00","created_by":"devop","updated_at":"2026-01-10T18:49:54.680205-03:00","closed_at":"2026-01-10T18:49:54.680205-03:00","close_reason":"Closed","labels":["audit","task-file"],"dependencies":[{"issue_id":"askbot-master-0ae","depends_on_id":"askbot-master-1c0","type":"blocks","created_at":"2026-01-10T14:25:12.189046-03:00","created_by":"devop"}],"comments":[{"id":1,"issue_id":"askbot-master-0ae","author":"devop","text":"## Audit Findings for markdown-mathjax-implementation-v2.md\n\n**Overall Assessment:** IMPLEMENTED - Document served its purpose as a planning document. Implementation is complete and commit-ready.\n\n### Document Status vs Reality\n| Aspect | Document Claims | Actual State |\n|--------|----------------|--------------|\n| Status | 'Proposed' | IMPLEMENTED (commit-ready) |\n| Next Steps | 'Ready for implementation' | Implementation DONE |\n\n### Architecture Evolution\nDocument proposes 4-phase approach. Actual implementation uses 7 phases:\n\n| Doc Phase | Actual Phase | Function | Notes |\n|-----------|--------------|----------|-------|\n| - | Phase 1 | protect_code_dollars() | NOT in document |\n| Phase 1 | Phase 2 | extract_math() | ✅ Matches |\n| Phase 2 | Phase 3 | escape_dollars() | ✅ Matches |\n| Phase 3 | Phase 4 | md.render() | ✅ Matches |\n| - | Phase 5 | restore_code_dollars() | NOT in document |\n| Phase 4 | Phase 6 | restore_math() | ✅ Matches |\n| - | Phase 7 | sanitize_html() | NOT in document |\n\nThe 'detilde' approach IS mentioned in doc (line 70-71, 254-262) but not as separate phase.\n\n### File Location Accuracy\n| Document Location | Actual Location | Match |\n|-------------------|-----------------|-------|\n| askbot/utils/markdown_plugins/math_extract.py | Same | ✅ |\n| askbot/utils/markdown_plugins/dollar_escape.py | Same | ✅ |\n| askbot/tests/test_markdown_dollar_escape.py | askbot/tests/test_markdown_mathjax.py | ❌ |\n\n### Code Examples vs Actual (Line Counts)\n| File | Document (stubs) | Actual |\n|------|-----------------|--------|\n| math_extract.py | ~70 lines (with TODOs) | 337 lines |\n| dollar_escape.py | ~30 lines | 42 lines |\n| Tests | ~75 lines | 386 lines |\n\n### What Document Got Right\n1. ✅ Token-based extraction approach (Stack Exchange style)\n2. ✅ Server-side dollar escape (\\$ → \u0026dollar;)\n3. ✅ restore_math() implementation (matches line-for-line)\n4. ✅ escape_dollars() implementation (simple replace)\n5. ✅ MATH_SPLIT regex pattern (identical)\n6. ✅ Edge cases analysis (all documented in tests)\n7. ✅ No FOUC problem (server-side rendering)\n\n### What Document Missed\n1. ❌ protect_code_dollars() as separate Phase 1\n2. ❌ restore_code_dollars() as separate Phase 5\n3. ❌ Explicit sanitize_html() Phase 7\n4. ❌ Test file naming (mathjax not dollar_escape)\n\n### JavaScript Section (Future Phase 2)\n- Document's JS examples are placeholders for future work\n- Still valid as Phase 2 frontend migration spec\n- NOT implemented yet (correct per status doc section 3.1)\n\n### Relationship to Other Documents\n- Supersedes: background-for-escaped-delimiters-mathjax.md (correctly stated)\n- Supersedes: markdown-upgrade-mathjax-support.md (implicit, not stated)\n- Used by: Section 2.1 of status document references this approach\n\n### Verdict\n**PLANNING DOCUMENT - SERVED ITS PURPOSE**\n- Core algorithm predictions accurate\n- Phase structure evolved during implementation\n- Should be marked as 'Implemented' not 'Proposed'","created_at":"2026-01-10T21:44:59Z"},{"id":2,"issue_id":"askbot-master-0ae","author":"devop","text":"## CORRECTION: Deeper Analysis Findings\n\n### Phase Structure Correction\n\nMy initial analysis was imprecise. The document has TWO phase descriptions:\n\n1. **Lines 139-173: Conceptual '4-Phase' overview** (simplified for understanding)\n2. **Lines 303-334: Code example with 6 phases** (actual implementation spec)\n\n**Document Code Example (6 phases):**\n- Phase 1: protect_code_dollars()\n- Phase 2: extract_math()\n- Phase 3: escape_dollars()\n- Phase 4: md.render()\n- Phase 5: restore_math()\n- Phase 6: sanitize_html()\n\n**Actual Implementation (7 phases):**\n- Phase 1: protect_code_dollars()\n- Phase 2: extract_math()\n- Phase 3: escape_dollars()\n- Phase 4: md.render()\n- **Phase 5: restore_code_dollars() ← MISSING FROM DOCUMENT**\n- Phase 6: restore_math()\n- Phase 7: sanitize_html()\n\nThe `restore_code_dollars()` function (reverses ~D → $) is NOT in the document code example (lines 303-334). This is a bug in the document spec.\n\n### Test Coverage Analysis\n\n| Document Proposed Test | Actual Test | Status |\n|------------------------|-------------|--------|\n| test_simple_escaped_dollar | line 135 | ✅ |\n| test_escaped_dollar_with_math | line 144 | ✅ |\n| test_escaped_display_delimiter | line 153 | ✅ |\n| test_math_with_latex_dollar | line 162, 176 | ✅ |\n| test_multiple_escaped_dollars | line 214 | ✅ |\n| test_complex_integration | line 232 | ✅ |\n| test_python_js_parity | N/A | ❌ (Phase 2) |\n\n**Additional Tests NOT in Document:** 24 more tests implemented (utility tests, extraction tests, edge cases, MathJax disabled tests)\n\n**Total:** Document specifies 7 tests, actual has 31 tests (4.4x more)\n\n### Edge Cases: Document vs Tests\n\n| Document Edge Case | Tested | Test Name |\n|--------------------|--------|-----------|\n| Double backslash \\\\$ | ❌ | NOT TESTED |\n| Triple backslash \\\\\\$ | ❌ | NOT TESTED |\n| Math in code spans | ✅ | test_code_span_protection |\n| URL with dollar | ✅ | test_url_with_dollar |\n| Escaped dollar in math | ✅ | test_math_with_latex_dollar |\n\n**UNTESTED EDGE CASES from document lines 470-488:** Double/triple backslash handling is documented as 'undefined behavior' but not tested.\n\n### Document Typo (Line 45)\n\nDocument shows:\n```\nOutput: \"\u003cp\u003eThe price is \\$100 and @@0@@ here\u003c/p\u003e\"\n```\n\nShould be:\n```\nOutput: \"\u003cp\u003eThe price is \\$100 and $x = 5$ here\u003c/p\u003e\"\n```\n\nThe output after replaceMath() should show restored math, not tokens.\n\n### Regex Comparison\n\n| Source | Pattern Fragment | Purpose |\n|--------|------------------|---------|\n| Stack Exchange (line 60) | \\\\\\[\\\\{}$] | Matches \\[, \\{, \\}, \\$ |\n| Document/Actual (line 207) | \\\\\\[\\[\\]] | Matches only \\[, \\] |\n\nThis is INTENTIONAL - we handle \\$ differently (via escape_dollars) and don't need \\{, \\} in split.\n\n### User Documentation (Lines 538-561)\n\nDocument includes help text for editor:\n```markdown\n## Writing Literal Dollar Signs\nWhen MathJax is enabled, use \\$ for literal dollars...\n```\n\n**Status:** NOT IMPLEMENTED - No help text added to editor UI.\n**Recommendation:** Add to Phase 2 or create separate issue.\n\n### Known Missing Delimiter Support\n\nDocument line 77 shows MathJax supports \\\\( and \\\\):\n```javascript\ninlineMath: [['$','$'], ['\\\\\\(','\\\\\\)']]\n```\n\nBut MATH_SPLIT regex doesn't match \\\\( or \\\\).\n**Already documented in status file as known limitation.**","created_at":"2026-01-10T21:48:50Z"}]}
{"id":"askbot-master-0ix","title":"Editor help panel - Responsive overflow (Phase 3)","description":"Add responsive overflow handling so tabs that don't fit appear in a dropdown menu.\n\n## Requirements\n- When horizontal space is insufficient, overflow tabs go into a dropdown\n- Dropdown appears to the right of the visible tabs\n- Dropdown dynamically updates on window resize\n- Keyboard accessible (Tab, Enter, Escape)\n\n## Styling Guidelines (MUST FOLLOW)\nReuse existing CSS variables and classes from askbot/media/sass/:\n\n**Dropdown trigger**: Use `--wmd-button-size`, `--action-link-color` for \"...\" button\n**Dropdown menu**: Use `.js-toolbar-dropdown-menu` pattern:\n  - `--toolbar-dropdown-menu-border`\n  - `--toolbar-dropdown-menu-border-radius`\n  - `--toolbar-dropdown-menu-box-shadow`\n  - `--toolbar-dropdown-menu-padding` (0.3625rem 0)\n  - `--toolbar-dropdown-menu-item-padding` (0.25rem 0.75rem)\n  - `--toolbar-dropdown-menu-item-hover-bg` (neutral-40)\n**Z-index**: Use `10000` for dropdown overlay\n**Active indicator**: Use `--font-weight-bold` for active item in dropdown\n\nReference files:\n- askbot/media/sass/components/toolbar_dropdown_menu.scss (dropdown pattern)\n- askbot/media/sass/variables.scss\n\n## Implementation\n- Create OverflowDropdown.svelte component\n- Use ResizeObserver in TabBar.svelte to measure available width\n- Calculate which tabs fit, move remainder to dropdown\n- Handle click-outside to close dropdown\n\n## Acceptance Criteria\n- [ ] Narrow viewport shows dropdown with overflow tabs\n- [ ] Wide viewport shows all tabs inline\n- [ ] Resizing window updates overflow dynamically\n- [ ] Keyboard navigation works (Tab, Enter, Escape)\n- [ ] Active tab in overflow shows visual indicator on dropdown trigger\n- [ ] Styling uses existing CSS variables (no hardcoded colors/sizes)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T19:10:36.226411-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-12T21:34:30.255447-03:00","closed_at":"2026-01-12T21:34:30.255447-03:00","close_reason":"Closed","dependencies":[{"issue_id":"askbot-master-0ix","depends_on_id":"askbot-master-frb","type":"blocks","created_at":"2026-01-12T19:11:04.071478-03:00","created_by":"Evgeny Fadeev"}]}
{"id":"askbot-master-0m9","title":"Commit legacy tasks/*.md files for reference","description":"Commit all .md files in tasks/ directory to preserve project history before removing the directory.\n\nFiles to commit:\n- tasks/markdown-upgrade-status.md (current consolidated status)\n- tasks/MD-summary.md\n- tasks/background-for-escaped-delimiters-mathjax.md\n- Any other .md files in tasks/\n\nCommit message should indicate these are archived reference documents being preserved before migration to bd tracking.\n\nThis preserves the planning history and decision rationale in git.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T20:34:30.299691-03:00","created_by":"devop","updated_at":"2026-01-10T20:46:51.665934-03:00","closed_at":"2026-01-10T20:46:51.665934-03:00","close_reason":"Closed"}
{"id":"askbot-master-0pk","title":"Audit task file: markdown-upgrade-assessment.md","description":"Analyze tasks/markdown-upgrade-assessment.md - Initial research, library comparisons, decision rationale. Document key decisions made.","notes":"## Audit Instructions\n\n**Before starting:**\n1. Read `tasks/markdown-upgrade-status.md` to understand the document structure and current state\n\n**When completing this audit:**\n1. **Add findings to this bd issue** using `bd comments add \u003cissue-id\u003e` with key observations\n2. **Edit ONLY your relevant section** in `tasks/markdown-upgrade-status.md` - do NOT overwrite the entire file\n3. **Reference this issue ID** (e.g., `askbot-master-xxx`) in the status file where you add findings\n4. **Update the Audit Trail table** at the bottom - change your row status from `pending` to `done`\n5. When complete, close this issue with `bd close \u003cissue-id\u003e`\n\n**Important:** Use the Edit tool to modify specific sections. Do not use Write to replace the whole file.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:16:27.004025-03:00","created_by":"devop","updated_at":"2026-01-10T17:50:54.129448-03:00","closed_at":"2026-01-10T17:50:54.129448-03:00","close_reason":"Closed","labels":["audit","task-file"],"dependencies":[{"issue_id":"askbot-master-0pk","depends_on_id":"askbot-master-uga","type":"blocks","created_at":"2026-01-10T14:25:11.884391-03:00","created_by":"devop"}],"comments":[{"id":3,"issue_id":"askbot-master-0pk","author":"devop","text":"## Audit Findings: markdown-upgrade-assessment.md\n\n**Document Type:** Initial research, library comparisons, decision rationale, implementation roadmap\n\n### Key Decisions Made (and their status)\n\n| Decision | Rationale | Status |\n|----------|-----------|--------|\n| Use markdown-it (not MyST) | Familiar syntax, lighter, pure markdown-it ecosystem | ✅ Followed |\n| Conservative approach (not aggressive) | Production content requires careful testing | ✅ Followed |\n| Write custom video plugin | No official Python port exists | ✅ DONE (video_embed.py) |\n| Write custom link patterns plugin | Need AUTO_LINK_PATTERNS support | ✅ DONE (link_patterns.py) |\n| Code-friendly mode via disable('emphasis') | When MATHJAX or CODE_FRIENDLY enabled | ⚠️ DONE but buggy |\n| Keep Showdown temporarily | Phase 2 migration | ✅ Showdown still present |\n| Upgrade to 4.0.0 + mdit-py-plugins | Latest versions | ✅ DONE |\n\n### Extracted Actionable Items (18 checkboxes)\n\n**Phase 1 Backend (6 items):**\n- [x] `askbot/__init__.py` - Update dependencies → DONE (commit 4)\n- [x] `askbot_requirements.txt` - Update requirements → DONE (commit 4)\n- [x] `askbot/utils/markup.py` - Enhanced converter → DONE (commits 4-6)\n- [x] `video_embed.py` - New plugin → DONE (commit 4)\n- [x] `link_patterns.py` - New plugin → DONE (commit 4)\n- [x] `askbot/tests/test_markup.py` - Add tests → DONE (commits 4-6)\n\n**Phase 2 Frontend (4 items):**\n- [ ] `markdown_javascript.html` - Update script includes\n- [ ] `askbot_converter.js` - Rewrite for markdown-it\n- [ ] `askbot/media/markdown_it/` - Add libraries\n- [ ] Download and vendor markdown-it plugins\n\n**Phase 3 Testing (4 items):**\n- [ ] Create migration test script\n- [ ] Test all existing posts\n- [ ] Visual regression testing\n- [ ] Update user documentation\n\n**Recommended Approach Checklist (9 items):**\n- [x] Upgrade Python to markdown-it-py 4.0.0 + mdit-py-plugins\n- [x] Keep Showdown on frontend temporarily\n- [x] Write Python video + link patterns plugins\n- [ ] Test with existing content using management command\n- [ ] Create migration script to test all posts\n- [ ] Migrate frontend to markdown-it.js\n- [ ] Write JS equivalents of custom plugins\n- [ ] Run side-by-side comparison testing\n- [ ] Deploy when output matches 99%+\n\n### Document Accuracy Assessment\n\n**OUTDATED Information:**\n\n| Line | Claims | Reality |\n|------|--------|---------|\n| 6 | \"markdown-it-py==2.2.0 (should upgrade to 4.0.0)\" | 4.0.0 installed |\n| 7 | \"Using 'gfm-like' preset\" | Changed to 'commonmark' (commit 5) |\n| 8 | \"Missing implementations for video, link patterns, code-friendly\" | All implemented |\n| 68-69 | \"mdit-py-plugins==0.4.2\" | Actually 0.5.0 |\n| 76 | \"linkify-it-py==2.0.2\" | Built into markdown-it-py |\n\n**ACCURATE Information:**\n- Feature availability matrix (lines 29-38) ✅\n- MyST alternative analysis (lines 401-427) ✅\n- Migration risks (lines 429-434) ✅\n- Testing strategy (lines 460-466) ✅\n- References (lines 490-496) ✅\n\n### Implementation Comparison\n\n**Document's video_embed.py example (lines 195-265) vs actual:**\n- Actual implementation is more complete (140 lines vs 70 in example)\n- Adds Dailymotion support (not in example)\n- Adds video ID validation (not in example)\n- Adds loading=\"lazy\" attribute (not in example)\n\n**Document's link_patterns.py example (lines 272-365) vs actual:**\n- Actual implementation is more robust (219 lines vs 93 in example)\n- Better overlap handling\n- Better error logging\n- Proper state management\n\n### Document Status\n\n**Role:** Foundational research document - explains WHY decisions were made\n**Status:** PARTIALLY OUTDATED - Phase 1 sections need updating\n**Value:** Still useful for Phase 2/3 planning and decision rationale","created_at":"2026-01-10T20:36:17Z"},{"id":4,"issue_id":"askbot-master-0pk","author":"devop","text":"## CRITICAL Findings (Deep Analysis)\n\n### 1. MathJax Claim is ARCHITECTURALLY WRONG\n\n**Document claims (line 33):** \"MathJax: Pass-through (client renders)\"\n\n**Actual implementation (markup.py):**\n- Line 301: \"Markdown to HTML converter with MathJax support\"\n- Line 303: \"Implements hybrid approach for MathJax\"\n- Lines 315-317: \"MathJax preprocessing (only if MathJax is enabled)\"\n- Lines 335-336: \"MathJax postprocessing\"\n\n**This is SERVER-SIDE processing, NOT client-side pass-through!**\n\nThe assessment completely missed that MathJax handling would require:\n- math_extract.py (11,774 bytes) - state machine for delimiter extraction\n- dollar_escape.py (1,273 bytes) - escaped dollar handling\n\n### 2. Plugin Count Underestimated by 150%\n\n| Anticipated | Actual |\n|-------------|--------|\n| video_embed.py ✅ | video_embed.py (3,310 bytes) |\n| link_patterns.py ✅ | link_patterns.py (6,298 bytes) |\n| - | truncate_links.py (4,867 bytes) - NOT anticipated |\n| - | math_extract.py (11,774 bytes) - NOT anticipated |\n| - | dollar_escape.py (1,273 bytes) - NOT anticipated |\n\n**Total: 2 anticipated → 5 actual (27,522 bytes of plugin code)**\n\nmath_extract.py alone is LARGER than video_embed.py + link_patterns.py combined!\n\n### 3. Preset Changed Without Documentation\n\n**Document uses throughout:** `MarkdownIt('gfm-like')`\n**Actual code (line 105):** `MarkdownIt('commonmark', {'linkify': True, 'typographer': False})`\n\nThis is a significant change affecting:\n- Table parsing behavior\n- Strikethrough handling\n- Autolink behavior\n\n### 4. Testing Strategy Status\n\n| Strategy | Assessment | Status |\n|----------|------------|--------|\n| Unit tests | \"for custom plugins\" | ✅ DONE |\n| Integration tests | \"for markdown converter\" | ✅ DONE |\n| Migration script | \"to test rendering of all existing posts\" | ❌ NOT DONE |\n| Visual comparison | \"of old vs new HTML output\" | ❌ NOT DONE |\n| User acceptance | \"with preview pane\" | ❌ N/A (Phase 2) |\n\n**3 of 5 testing types NOT implemented - same Goal 4 gap identified in overview audit**\n\n### 5. Migration Risks STILL UNADDRESSED\n\nAll 4 risks from lines 429-434 have NO mitigations in place:\n\n| Risk | Mitigation Status |\n|------|-------------------|\n| Breaking changes in HTML output | ❌ No comparison testing |\n| Testing burden for existing content | ❌ No migration script |\n| Custom extensions won't port | ✅ Custom plugins written |\n| User disruption (preview vs saved) | ❌ Phase 2 not started |\n\n### 6. Feature Matrix Accuracy\n\n| Feature | Doc Claim | Reality | Accurate? |\n|---------|-----------|---------|-----------|\n| Tables | Built-in (gfm-like) | Enabled via enable('table') | ⚠️ Partially |\n| Code highlighting | Pygments | Pygments in highlight_code() | ✅ Yes |\n| MathJax | Pass-through | Server-side preprocessing | ❌ WRONG |\n| Link patterns | Custom plugin needed | link_patterns.py done | ✅ Yes |\n| Code-friendly | Disable emphasis | md.disable('emphasis') | ⚠️ Buggy |\n| Video | NO PLUGIN | video_embed.py done | ✅ Yes |\n| Task lists | mdit-py-plugins | tasklists_plugin enabled | ✅ Yes |\n| Footnotes | mdit-py-plugins | footnote_plugin enabled | ✅ Yes |\n\n### 7. linkify-it-py Dependency Incorrect\n\n**Document says (line 69, 76):** Add `linkify-it-py==2.0.2` to requirements\n\n**Reality:** linkify-it-py is a transitive dependency of markdown-it-py, not needed as explicit requirement. It's NOT in askbot_requirements.txt.","created_at":"2026-01-10T20:39:31Z"},{"id":5,"issue_id":"askbot-master-0pk","author":"devop","text":"## Additional CRITICAL Findings (Third Pass)\n\n### 1. Frontend/Backend MathJax Processing MISMATCH\n\n**This is a PHASE 2 BLOCKER discovered during audit:**\n\n| Component | MathJax Approach |\n|-----------|------------------|\n| Backend (markup.py) | Server-side: math_extract.py extracts math → markdown renders → math restored |\n| Frontend (askbot_converter.js) | Client-side: raw text → Showdown → MathJax.Hub.Queue renders in browser |\n\n**Impact:** Preview in editor will NOT match saved content because:\n- Backend: `$x^2$` → extracted → markdown safe → `$x^2$` restored → MathJax\n- Frontend: `$x^2$` → Showdown mangles it → MathJax tries to fix\n\n**Phase 2 must address:** Either port math_extract.py to JavaScript OR change frontend approach\n\n### 2. Version Confirmed\n\n**mdit-py-plugins:** 0.5.0 (document says 0.4.2) - verified in askbot_requirements.txt:26\n\n### 3. Settings File Locations VERIFIED\n\nDocument said `askbot/conf/markup.py:86-138`, actual locations:\n\n| Setting | Document | Actual Line |\n|---------|----------|-------------|\n| MARKUP_CODE_FRIENDLY | ~86-138 | Line 39 |\n| ENABLE_MATHJAX | ~86-138 | Line 56 |\n| ENABLE_AUTO_LINKING | 86-138 | Line 86 ✓ |\n| AUTO_LINK_PATTERNS | 86-138 | Line 101 ✓ |\n| AUTO_LINK_URLS | 86-138 | Line 123 ✓ |\n\nAUTO_LINK settings are in the correct range; MATHJAX/CODE_FRIENDLY are earlier.\n\n### 4. Settings Help Text Confirms Design Intent\n\nFrom markup.py line 45-47:\n\u003e \"Note that 'MathJax support' implicitly turns this feature on, because underscores are heavily used in LaTeX input.\"\n\nThis confirms the `or` in:\n```python\nif askbot_settings.MARKUP_CODE_FRIENDLY or askbot_settings.ENABLE_MATHJAX:\n    md.disable('emphasis')\n```\n\n### 5. Phase 2 Guidance Issues\n\n**Assessment's Phase 2 code example (lines 131-187):**\n- Uses `window.markdownit('gfm-like')` but backend uses `'commonmark'`\n- Does NOT address math preprocessing mismatch\n- Assumes simple MathJax pass-through which is NOT how backend works\n\n**Recommendation:** Phase 2 planning needs revision to account for backend's math preprocessing architecture\n\n### 6. Current askbot_converter.js Analysis (67 lines)\n\n```javascript\n// Line 14: Uses Showdown\nthis._converter = new Markdown.getSanitizingConverter();\n\n// Lines 18-26: MathJax scheduling\nscheduleMathJaxRendering() { MathJax.Hub.Queue(['Typeset', MathJax.Hub, 'previewer']); }\n\n// Lines 48-66: makeHtml combines converter + MathJax\n```\n\nThis file is the PRIMARY target for Phase 2 rewrite, but assessment's example code doesn't account for math preprocessing.","created_at":"2026-01-10T20:41:47Z"},{"id":6,"issue_id":"askbot-master-0pk","author":"devop","text":"## Fourth Pass: Additional Missed Findings\n\n### 1. XSS Vulnerability in Assessment Code Examples\n\n**Document lines 88-95** (highlight_code example):\n```python\nreturn f'\u003cpre\u003e\u003ccode class=\"language-{lang}\"\u003e{code}\u003c/code\u003e\u003c/pre\u003e'\n```\n\nNeither `code` nor `lang` are HTML-escaped. This is a **security vulnerability** in the example code.\n\n**Actual implementation (markup.py lines 52, 71, 76)** has the SAME issue in fallback paths:\n- Line 52: `f'\u003cpre\u003e\u003ccode\u003e{code}\u003c/code\u003e\u003c/pre\u003e'`\n- Line 71: `f'\u003cpre\u003e\u003ccode class=\"language-{lang}\"\u003e{code}\u003c/code\u003e\u003c/pre\u003e'`\n- Line 76: Same pattern\n\n**Impact:** If Pygments fails and fallback triggers, unsanitized code content could inject HTML. Mitigated by `sanitize_html()` in `markdown_input_converter()` line 347, but defense-in-depth suggests escaping here too.\n\n### 2. Code-Friendly Mode: Document Description is WRONG\n\n**Document line 56:** \"Disable underscore emphasis when MARKUP_CODE_FRIENDLY=True\"\n**Document line 57:** \"Both: `md.disable('emphasis')` or selective rule tweaking\"\n\nThe document SAYS \"disable underscore emphasis\" but `md.disable('emphasis')` disables BOTH:\n- Underscore: `_italic_` ❌ disabled\n- Asterisk: `*italic*` ❌ ALSO disabled\n\nThis is NOT a bug in implementation matching the document - the DOCUMENT ITSELF is misleading. It describes the intention (disable underscore only) but the prescribed method (`md.disable('emphasis')`) disables both.\n\n**Recommendation:** Document should clarify that `md.disable('emphasis')` is a crude approach that disables all emphasis, and \"selective rule tweaking\" is the proper solution (never elaborated).\n\n### 3. MathJax 7-Phase Pipeline Not Anticipated\n\nAssessment's \"Pass-through (client renders)\" implies minimal server work. Actual implementation (markup.py:299-349) has **7 distinct phases**:\n\n| Phase | Function | Description |\n|-------|----------|-------------|\n| 1 | protect_code_dollars() | `$` → `~D` in code spans |\n| 2 | extract_math() | Math → `@@N@@` tokens |\n| 3 | escape_dollars() | `\\$` → `\u0026dollar;` |\n| 4 | md.render() | Standard markdown |\n| 5 | restore_code_dollars() | `~D` → `$` |\n| 6 | restore_math() | `@@N@@` → math |\n| 7 | sanitize_html() | XSS protection |\n\nThis complexity was NOT anticipated. Assessment gave NO indication math handling would require:\n- A state machine (math_extract.py line 14: MATH_SPLIT regex)\n- Multiple regex patterns\n- Token-based extraction algorithm\n- Stack Exchange reference implementation (line 5-6 of math_extract.py)\n\n### 4. truncate_links.py Entirely Missing from Assessment\n\nThe assessment mentions:\n- linkify-it-py for URL detection ✓\n- Custom link patterns plugin ✓\n\nBut NEVER mentions URL display truncation. Actual implementation has `truncate_links_plugin` (markup.py line 132-134) that:\n- Truncates display text to 40 chars\n- Adds title attribute for accessibility\n- 134 lines of code\n\nThis was a discovered requirement during implementation, not anticipated.\n\n### 5. Get_md_converter() vs markdown_input_converter() Architecture Split\n\nAssessment code examples (lines 97-127) show ALL features in `get_md_converter()`.\n\nActual architecture SPLITS responsibilities:\n- **get_md_converter()**: Markdown-it plugins (video, links, truncate, code-friendly)\n- **markdown_input_converter()**: MathJax preprocessing/postprocessing\n\nThis split is NOT documented anywhere. The math protection happens OUTSIDE the markdown-it plugin system, which differs from the v1 approach (math_protect.py as a plugin).\n\n### 6. Singleton Settings Issue Still Present\n\nAssessment code (line 107):\n```python\nif askbot_settings.MARKUP_CODE_FRIENDLY or askbot_settings.ENABLE_MATHJAX:\n    md.disable('emphasis')\n```\n\nActual code (markup.py line 138-141) has the SAME pattern with singleton caching.\n\n**Problem:** If ENABLE_MATHJAX changes at runtime, the cached converter won't update. Document mentions this nowhere.\n\nActual has `reset_md_converter()` (line 157-160) for tests, but production code would need restart to pick up setting changes.\n\n### 7. Assessment Outdated Since Phase 1 Complete\n\n**File header should indicate:** This document was written BEFORE implementation. The following sections are now OUTDATED:\n\n| Section | Lines | Status |\n|---------|-------|--------|\n| Current State | 3-15 | ❌ OUTDATED |\n| Missing implementations | 8 | ✅ ALL DONE |\n| Phase 1: Foundation | 62-127 | ✅ DONE (differently) |\n| Plugin examples | 191-399 | ⚠️ PARTIAL (actual more complete) |\n| Recommended Approach | 436-449 | ⚠️ Steps 1-3 done, 4-9 pending |\n\n**Sections still relevant:**\n| Section | Lines | Status |\n|---------|-------|--------|\n| Is markdown-it best? | 17-26 | ✅ Valid |\n| MyST Alternative | 401-427 | ✅ Valid |\n| Migration Risks | 429-434 | ✅ Valid |\n| Phase 2/3 guidance | 129-187, 460-488 | ✅ Still needed |","created_at":"2026-01-10T20:45:32Z"},{"id":7,"issue_id":"askbot-master-0pk","author":"devop","text":"## Fifth Pass: Additional Missed Findings\n\n### 1. Plugin Code Size 5.3x Larger Than Examples\n\n| Plugin | Assessment | Actual | Δ |\n|--------|------------|--------|---|\n| video_embed.py | 70 lines | 139 lines | +99% |\n| link_patterns.py | 93 lines | 218 lines | +134% |\n| truncate_links.py | 0 lines | 134 lines | NEW |\n| math_extract.py | 0 lines | 336 lines | NEW |\n| dollar_escape.py | 0 lines | 41 lines | NEW |\n| **TOTAL** | 163 lines | 869 lines | **+433%** |\n\n### 2. Line Reference Errors Throughout Document\n\n| Location | Document Claims | Reality |\n|----------|-----------------|---------|\n| Line 9 | `markup.py:30-47` | get_md_converter at 82-154 |\n| Line 53 | `conf/markup.py:86-138` | Settings at 39, 56, 86, 101, 123 |\n| Line 369 | `markup.py:30-47` | Same error repeated |\n\n### 3. Phase Structure is BACKWARDS\n\nAssessment: Phase 1 (Backend) → Phase 2 (Frontend) → **Phase 3 (Plugins)**\n\nReality: Plugins must be Phase 1. Can't test backend without plugins. Can't migrate frontend without JS equivalents.\n\n### 4. Steps 4-5 are Phase 1 Incomplete, NOT Phase 2\n\n- Step 4: \"Test with existing content\" - ❌ UNDONE\n- Step 5: \"Create migration script\" - ❌ UNDONE\n\nThese are Phase 1 completion criteria, not Phase 2 work.\n\n### 5. CDN @latest Security Risk\n\nLines 177-180 use unpinned versions:\n```\nhttps://cdn.jsdelivr.net/npm/markdown-it@latest/...\n```\nShould pin specific versions to prevent supply chain attacks.\n\n### 6. Assessment Example Code Bugs\n\n**link_patterns example:** Modifies children list while iterating (`token.children[child_idx:child_idx+1] = new_children`)\n\n**video_embed example:** Missing video ID validation, dailymotion support, loading=\"lazy\", wrapper div, per-service dimensions\n\n### 7. dollar_escape.py Order-Dependent Preprocessing\n\nThis is NOT a markdown-it plugin. It's a preprocessing step with strict ordering:\n1. AFTER extract_math() (math safe in @@N@@ tokens)\n2. BEFORE md.render()\n\nAssessment has NO discussion of preprocessing step ordering.\n\n### 8. askbot_converter.js Scratch Pad Pattern\n\nCurrent frontend (lines 28-46) uses DOM scratch pad for highlight.js:\n```javascript\nthis.makeScratchPadElement()  // Creates hidden div\n.find('pre code').parent().each(...)  // DOM manipulation\n```\n\nAssessment's replacement doesn't include this pattern. Frontend migration more complex than suggested.","created_at":"2026-01-10T20:50:28Z"}]}
{"id":"askbot-master-1c0","title":"Audit task file: markdown-upgrade-mathjax-support.md","description":"Analyze tasks/markdown-upgrade-mathjax-support.md - Detailed mathjax checklist. Check overlap with v2 implementation doc.","notes":"## Audit Instructions\n\n**Before starting:**\n1. Read `tasks/markdown-upgrade-status.md` to understand the document structure and current state\n\n**When completing this audit:**\n1. **Add findings to this bd issue** using `bd comments add \u003cissue-id\u003e` with key observations\n2. **Edit ONLY your relevant section** in `tasks/markdown-upgrade-status.md` - do NOT overwrite the entire file\n3. **Reference this issue ID** (e.g., `askbot-master-xxx`) in the status file where you add findings\n4. **Update the Audit Trail table** at the bottom - change your row status from `pending` to `done`\n5. When complete, close this issue with `bd close \u003cissue-id\u003e`\n\n**Important:** Use the Edit tool to modify specific sections. Do not use Write to replace the whole file.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:16:45.627812-03:00","created_by":"devop","updated_at":"2026-01-10T18:39:28.747743-03:00","closed_at":"2026-01-10T18:39:28.747743-03:00","close_reason":"Closed","labels":["audit","task-file"],"dependencies":[{"issue_id":"askbot-master-1c0","depends_on_id":"askbot-master-4gc","type":"blocks","created_at":"2026-01-10T14:25:12.112979-03:00","created_by":"devop"}],"comments":[{"id":8,"issue_id":"askbot-master-1c0","author":"devop","text":"## Audit Findings for markdown-upgrade-mathjax-support.md\n\n**STATUS: OBSOLETE**\n\nThis task file describes the v1 plugin-based approach for MathJax protection that was:\n1. Implemented in commit d625f5507\n2. Found to have critical bugs (see status file section 4.1)\n3. Reverted in commit a40000d1c\n4. Superseded by v2 preprocessing approach (markdown-mathjax-implementation-v2.md)\n\n### Overlap with v2 Implementation Doc\n\n| Aspect | mathjax-support.md (v1) | implementation-v2.md |\n|--------|-------------------------|----------------------|\n| Approach | Plugin-based (inside markdown-it) | Preprocessing (outside markdown-it) |\n| Architecture | math_inline/math_block tokens | @@N@@ placeholder tokens |\n| Complexity | Higher (state machine in parser) | Lower (preprocessing pipeline) |\n| Status | OBSOLETE | IMPLEMENTED (uncommitted) |\n\n### What's Still Valid\n- Problem Statement (lines 10-50): Why protection is needed\n- Design Requirement (line 42): 'NO markdown processing inside delimiters'\n- Edge cases discussion (partially - v2 handles differently)\n- Frontend JS parity requirement\n\n### What's Obsolete\n- Entire 'Solution: Math Protection Plugin' section\n- math_protect.py plugin design\n- Plugin integration code examples\n- 6-phase implementation plan\n- Testing strategy (superseded by actual test_markdown_mathjax.py with 386 lines)\n\n### V2 Explicitly Supersedes\nv2 document includes comparison table (lines 577-590) concluding:\n'Decision: New approach is simpler, proven, and more robust despite being less pure in design.'\n\n### Recommendation\nMove to Obsolete/Superseded section (Section 5) with note:\n- Superseded by: markdown-mathjax-implementation-v2.md and actual uncommitted implementation\n- Historical value: Documents the v1 approach that was tried and reverted","created_at":"2026-01-10T21:21:15Z"},{"id":9,"issue_id":"askbot-master-1c0","author":"devop","text":"## Additional Findings (Deep Analysis)\n\n### Correction: Document Relationships\n\nThe v2 document says 'Supersedes: Background document approach (entity conversion only)' - this refers to background-for-escaped-delimiters-mathjax.md, NOT mathjax-support.md directly.\n\n**Three-document relationship:**\n| Document | Focus | Approach |\n|----------|-------|----------|\n| background-for-escaped-delimiters-mathjax.md | Dollar escape only | Inline rule |\n| markdown-upgrade-mathjax-support.md (THIS FILE) | Math protection | Plugin inside markdown-it |\n| markdown-mathjax-implementation-v2.md | Both concerns | Preprocessing outside markdown-it |\n\nmathjax-support.md and v2 are ALTERNATIVE solutions to the same problem (math protection), not sequential.\n\n### TEST COVERAGE GAP: Critical Tests Missing\n\nmathjax-support.md proposed tests marked '⭐ Critical' that are NOT in actual test_markdown_mathjax.py:\n\n| Proposed Test | Purpose | Actual Coverage |\n|---------------|---------|-----------------|\n| test_math_with_url | URL inside math not linkified | ❌ NOT TESTED |\n| test_math_with_www | www. inside math not linkified | ❌ NOT TESTED |\n| test_math_with_fuzzy_link | example.com inside math not linkified | ❌ NOT TESTED |\n| test_math_with_pattern | link patterns inside math ignored | ❌ NOT TESTED |\n| test_math_with_underscores | _ inside math not emphasis | ❌ NOT TESTED |\n| test_math_with_asterisk | * inside math not emphasis | ❌ NOT TESTED |\n| test_math_linkify_no_interference | Integration: linkify + math | ❌ NOT TESTED |\n| test_math_patterns_no_interference | Integration: patterns + math | ❌ NOT TESTED |\n\nThese are the CORE PROTECTION tests that mathjax-support.md identifies as critical\\!\n\n### What IS covered in actual tests:\n- Dollar escape (✅)\n- Math extraction (✅)\n- Code span protection (✅)\n- LaTeX environments (✅)\n- Edge cases (✅)\n\n### RECOMMENDATION: Create work issue for missing tests\n\nThe preprocessing approach (v2) SHOULD protect math from linkify/patterns/emphasis, but there are NO TESTS verifying this. The test gap from mathjax-support.md should be addressed.\n\n### Frontend JS Parity: Still Unaddressed\nBoth documents require frontend parity. Phase 2 deliverable, not implemented.\n\n### Summary: Document Status\n- **Obsolete as implementation guide** (plugin approach reverted)\n- **VALID for functional requirements** (what protection means)\n- **VALID for test strategy** (missing critical tests identified)\n- **VALID for frontend requirements** (not yet implemented)","created_at":"2026-01-10T21:37:42Z"}]}
{"id":"askbot-master-25d","title":"CSS regression: Help panel width changes when switching tabs","description":"## Problem\n\nWhen navigating between help tabs in the editor help panel, there is a visible width change in the post display area. This is most noticeable when switching to/from the HTML tab.\n\n## How to Reproduce\n\n1. Start the dev server\n2. Open http://localhost.askbot.com:8000/\n3. Login with admin/admin\n4. Navigate to http://localhost.askbot.com:8000/question/163/hello-world/\n5. Click \"edit\" under the question body (the link with text \"edit\" below the post content, NOT the title edit button)\n6. Click the \"?\" button in the editor toolbar to open the help panel\n7. Switch between tabs - specifically go to \"HTML\" tab and then back to \"Links\" or other tabs\n8. Observe the width change in the help panel area (822px on Links vs 825px on HTML)\n\n## Investigation Findings\n\n### Root Cause Analysis\n\n1. **Button row overflow**: The `.wmd-button-row` has negative margins (`margin: 0 -0.125rem` = `0 -2px`) causing it to extend 4px beyond its parent container (828px vs 824px parent width).\n\n2. **Width measurements**:\n   - Links tab: help-panel-content width = 822px\n   - HTML tab: help-panel-content width = 825px\n   - The 3px difference causes visible layout shift\n\n3. **Parent chain**: The width change propagates up through:\n   - `.help-panel` \n   - `.editor-help-panel-container`\n   - `.wmd-container`\n   - `.js-editable`\n   - `.post-body`\n   - `.post-content`\n\n### Attempted Fix\n\nAdded `overflow: hidden` to `.wmd-container` in `askbot/media/sass/components/editors/wmd.scss`:\n\n```scss\n.wmd-container {\n  margin: var(--wmd-margin);\n  overflow: hidden;  // Added\n}\n```\n\nRebuilt CSS with `npm run sass:build`.\n\n**Result**: The wmd-container now clips overflow, but the width change still occurs. The fix did not fully resolve the issue.\n\n### Files Involved\n\n- `askbot/media/sass/components/editors/wmd.scss` - WMD editor styles\n- `askbot/media/sass/components/editors/wmd_help.scss` - Help panel styles (already has overflow: hidden)\n- `askbot/media/wmd/help-panel/src/HelpPanel.svelte` - Svelte component (has overflow: hidden in style)\n- `askbot/media/wmd/help-panel/src/components/TabBar.svelte` - Tab bar component\n\n### Previous Fix Attempt\n\nThe user mentioned a previous fix using `overflow-hidden` that worked but regressed. The `.editor-help-panel-container` and `.help-panel-content .help-content` already have `overflow: hidden` in wmd_help.scss (lines 13 and 22).\n\n## Next Steps to Investigate\n\n1. Check if the tab content itself is causing intrinsic width changes\n2. Look at the TabBar's `.measure-container` (position: absolute, visibility: hidden) - may need width constraints\n3. Consider adding `min-width` / `max-width` constraints to the help panel\n4. Check if the issue is related to flex layout calculations in the tab bar","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-31T17:38:22.14593-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-31T18:30:06.083762-03:00","closed_at":"2026-01-31T18:30:06.083762-03:00","close_reason":"Closed","comments":[{"id":105,"issue_id":"askbot-master-25d","author":"Evgeny Fadeev","text":"## Additional Fix: Seamless Help Panel / Editor Connection\n\nMade the help panel connect seamlessly with the editor textarea by removing the gap and matching border radii:\n\n### Changes:\n\n**HelpPanel.svelte:**\n- Set `margin: 0` (removed bottom margin gap)\n- Set `border-bottom: 0`\n- Changed border-radius to use `--input-border-radius` (matching textarea) with only top corners rounded\n\n**EditorHelpPanel.svelte:**\n- Added `editorInput` prop to receive textarea reference from wmd.js\n- Toggle `js-help-panel-open` class on textarea when panel opens/closes\n- Added CSS rule: `textarea.js-help-panel-open { border-top-left-radius: 0; border-top-right-radius: 0; }`\n\n**wmd.js:**\n- Pass `editorInput: inputBox` prop when instantiating EditorHelpPanel\n\nThis creates a seamless visual connection between the help panel and editor when the panel is open.","created_at":"2026-01-31T21:28:50Z"}]}
{"id":"askbot-master-2bt","title":"Audit commit 8: Added mathjax support task file","description":"Analyze commit 09a928f28 - added tasks/markdown-upgrade-mathjax-support.md.","notes":"## Audit Instructions\n\n**Before starting:**\n1. Read `tasks/markdown-upgrade-status.md` to understand the document structure and current state\n\n**When completing this audit:**\n1. **Add findings to this bd issue** using `bd comments add \u003cissue-id\u003e` with key observations\n2. **Edit ONLY your relevant section** in `tasks/markdown-upgrade-status.md` - do NOT overwrite the entire file\n3. **Reference this issue ID** (e.g., `askbot-master-xxx`) in the status file where you add findings\n4. **Update the Audit Trail table** at the bottom - change your row status from `pending` to `done`\n5. When complete, close this issue with `bd close \u003cissue-id\u003e`\n\n**Important:** Use the Edit tool to modify specific sections. Do not use Write to replace the whole file.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:15:40.217945-03:00","created_by":"devop","updated_at":"2026-01-10T16:20:20.194301-03:00","closed_at":"2026-01-10T16:20:20.194301-03:00","close_reason":"Closed","labels":["audit","commit"],"dependencies":[{"issue_id":"askbot-master-2bt","depends_on_id":"askbot-master-u9s","type":"blocks","created_at":"2026-01-10T14:15:40.218776-03:00","created_by":"devop"},{"issue_id":"askbot-master-2bt","depends_on_id":"askbot-master-8zl","type":"blocks","created_at":"2026-01-10T14:22:31.290578-03:00","created_by":"devop"}],"comments":[{"id":10,"issue_id":"askbot-master-2bt","author":"devop","text":"## Audit Summary: Commit 09a928f28\n\n**Purpose:** Added comprehensive MathJax implementation planning document (754 lines).\n\n### Document Overview\n\n**File:** `tasks/markdown-upgrade-mathjax-support.md`\n\nThis is a **documentation-only commit** - no code changes. It provides a detailed roadmap for implementing proper MathJax delimiter protection.\n\n### Problem Identified\n\nThe document explains why current MathJax support is inadequate:\n1. `md.disable('emphasis')` is a crude workaround, not real protection\n2. Linkify can interfere: `$x = y.com$` gets linkified inside math\n3. Link patterns can interfere: `$bug123$` gets converted to link\n4. Over-disabled emphasis: users can't use `**bold**` or `*italic*`\n5. Wrong plugin order: linkify runs without math awareness\n\n### Proposed Solution\n\nCreate `math_protect.py` plugin that:\n- Detects `$...$` (inline) and `$$...$$` (display) delimiters\n- Creates special tokens preserving content verbatim\n- Must run BEFORE all other inline/block rules\n- Prevents linkify, patterns, emphasis from processing math content\n\n### Document Sections\n- Problem Statement \u0026 Critical Issues\n- Technical Design (plugin structure, token types, detection algorithm)\n- Integration plan for markup.py (correct plugin ordering)\n- Edge cases (escaped delimiters, single $, mismatched, etc.)\n- Testing strategy (14 unit tests, 3 integration tests outlined)\n- 6 implementation phases\n- Frontend JavaScript equivalent guide\n- Related TODOs in markup.py that would be resolved\n\n### Key Technical Details\n- Plugin ordering: math_protect must be FIRST\n- Token types: `math_inline`, `math_block`\n- Rule placement: `md.inline.ruler.before('escape', 'math_inline', ...)`\n\n### Assessment\nHigh-quality planning document. Provides complete implementation roadmap with edge cases considered. Ready for implementation (which happens in commits 9-10, later reverted).","created_at":"2026-01-10T19:15:08Z"},{"id":11,"issue_id":"askbot-master-2bt","author":"devop","text":"## Additional Findings\n\n**Key details I should highlight:**\n\n### User Mandate (Driving Requirement)\nThe document quotes: *\"Inside mathjax delimiters when mathjax is enabled, there should be NO markdown processing at all!!!\"*\n\n### Current Code Analysis\nDocument identifies specific lines in `markup.py` (136-151):\n```python\nif askbot_settings.ENABLE_MATHJAX:\n    # TODO: Implement math delimiter protection plugin  (Line 150)\n    pass  # ← NOTHING IMPLEMENTED!\n```\n\n### Related TODOs to be Resolved\n- **Line 150**: `# TODO: Implement math delimiter protection plugin` → will be resolved\n- **Line 142**: `# TODO: Add custom rule to re-enable * only if needed` → partially addressed\n\n### Recommendation on Emphasis\nDocument recommends: \"Start with Option 3 (accept current behavior), add Option 1 (asterisk-only emphasis) as enhancement later\"\n\n### Critical Notes\n- \"Math protection is CRITICAL before markdown upgrade is complete\"\n- \"Plugin ordering is essential - math must be FIRST\"\n- References markdown-it-texmath (JS) as similar implementation\n\n### Author\nDocument created by \"Claude Code\" (AI-assisted planning)\n\n### Relationship to Later Commits\nThis planning document sets up commits 9-10 which attempt implementation (later reverted in commit 10).","created_at":"2026-01-10T19:17:28Z"},{"id":12,"issue_id":"askbot-master-2bt","author":"devop","text":"## Verification of Document Claims\n\n### Code References: VERIFIED ✓\nDocument claims lines 136-151 in markup.py have the workaround code.\n**Actual:** Lines 138-151 (close match). Code structure matches exactly:\n- `md.disable('emphasis')` at line 141\n- `# TODO: Add custom rule to re-enable * only if needed` at line 142  \n- `# TODO: Implement math delimiter protection plugin` at line 150\n- `pass` at line 151\n\n### Existing Tests: VERIFIED ✓\nDocument mentions these tests should still pass:\n- `test_mathjax_math_delimiters_preserved()` - EXISTS at line 162\n- `test_mathjax_underscores_not_emphasis()` - EXISTS at line 195\n\n### Critical Insight: EXISTING TESTS ARE INCOMPLETE\nThe existing tests verify:\n- `$E = mc^2$` is preserved (no emphasis tags)\n- `$a_b$` doesn't create `\u003cem\u003e` or `\u003csub\u003e` tags\n\nBUT they do **NOT** test the problematic scenarios the document identifies:\n- No test for URL inside math: `$x = y.com$`\n- No test for link pattern inside math: `$bug123$`\n- No test for linkify + math interaction\n\n**Why existing tests pass:** They pass because `md.disable('emphasis')` prevents emphasis processing. But they don't validate that linkify/patterns won't break math content.\n\nThis is WHY the document proposes 14 new unit tests and 3 integration tests - to cover the gaps.","created_at":"2026-01-10T19:19:22Z"}]}
{"id":"askbot-master-2um","title":"Remove stale comment at test_markup.py:76-80","description":"## Context\nAt `askbot/tests/test_markup.py:76-80` there is an outdated comment listing URL patterns as \"Known to fail against\". The comment predates the markdown-it migration and linkify implementation.\n\n## Task\nAdd tests for the following URL patterns with reasonable expectations, then remove the stale comments:\n\n- `http://example.com/quotes-are-\"part\"` - quotes in URL\n- `✪df.ws/1234` - unicode domain\n- `example.com/` - bare domain with trailing slash\n\nNote: `example.com` (bare domain without slash) now works with linkify and doesn't need a failure test.\n\n## File\n`askbot/tests/test_markup.py` lines 76-80\n\n## Acceptance Criteria\n- [ ] Add test cases for the three URL patterns above\n- [ ] Tests have reasonable expectations based on current behavior\n- [ ] Remove the stale \"Known to fail against\" comment section\n- [ ] Tests pass\n\n## Related\n- Source: tasks/markdown-upgrade-status.md section 1.2\n- Linkify implementation: commit ea2f58fa4","status":"closed","priority":4,"issue_type":"task","created_at":"2026-01-10T21:41:51.770794-03:00","created_by":"devop","updated_at":"2026-01-11T15:50:20.945447-03:00","closed_at":"2026-01-11T15:50:20.945447-03:00","close_reason":"Closed","dependencies":[{"issue_id":"askbot-master-2um","depends_on_id":"askbot-master-q54","type":"blocks","created_at":"2026-01-10T22:01:25.105095-03:00","created_by":"devop"}]}
{"id":"askbot-master-33a","title":"Create bd issue for backend testing completion","description":"⚠️ REQUIRES INTERACTIVE SESSION: Review testing scope before creating.\n\nSplit from original Phase 3 - backend testing only.\n\nFrom tasks/markdown-upgrade-status.md:\n- Migration test script (compare markdown2 vs markdown-it output)\n- Performance benchmarking\n- Edge case testing (using correct markdown_input_converter() not md.render())\n- Coverage tooling setup (pytest-cov, 95%+ target)\n\nDoes NOT include:\n- Visual regression (requires frontend)\n- Staged deployment (after frontend)\n- Full rollback testing (after frontend)\n\n---\nBEFORE STARTING: Confirm testing scope with user.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T20:36:39.049379-03:00","created_by":"devop","updated_at":"2026-01-10T22:09:15.951548-03:00","closed_at":"2026-01-10T22:09:15.951548-03:00","close_reason":"already planned","dependencies":[{"issue_id":"askbot-master-33a","depends_on_id":"askbot-master-zog","type":"blocks","created_at":"2026-01-10T20:39:14.554633-03:00","created_by":"devop"}]}
{"id":"askbot-master-35c","title":"Audit uncommitted: MathJax v2 implementation","description":"Analyze uncommitted staged files: math_extract.py, dollar_escape.py, test_markdown_mathjax.py, markup.py changes. Run tests, verify implementation state, determine commit-readiness.","notes":"## Audit Instructions\n\n**Before starting:**\n1. Read `tasks/markdown-upgrade-status.md` to understand the document structure and current state\n\n**When completing this audit:**\n1. **Add findings to this bd issue** using `bd comments add \u003cissue-id\u003e` with key observations\n2. **Edit ONLY your relevant section** in `tasks/markdown-upgrade-status.md` - do NOT overwrite the entire file\n3. **Reference this issue ID** (e.g., `askbot-master-xxx`) in the status file where you add findings\n4. **Update the Audit Trail table** at the bottom - change your row status from `pending` to `done`\n5. When complete, close this issue with `bd close \u003cissue-id\u003e`\n\n**Important:** Use the Edit tool to modify specific sections. Do not use Write to replace the whole file.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:17:04.484384-03:00","created_by":"devop","updated_at":"2026-01-10T17:16:43.737346-03:00","closed_at":"2026-01-10T17:16:43.737346-03:00","close_reason":"Closed","labels":["audit","uncommitted"],"dependencies":[{"issue_id":"askbot-master-35c","depends_on_id":"askbot-master-mps","type":"blocks","created_at":"2026-01-10T14:17:04.488224-03:00","created_by":"devop"}],"comments":[{"id":13,"issue_id":"askbot-master-35c","author":"devop","text":"## Test Results\n\n**All 35 tests pass** (2 skipped for documented edge cases):\n- DollarEscapeUtilityTests: 4/4 pass\n- MathExtractionTests: 9/9 pass (1 skip)\n- MarkdownDollarEscapeIntegrationTests: 12/12 pass\n- MarkdownWithoutMathJaxTests: 2/2 pass\n- EdgeCaseTests: 6/6 pass (1 skip)\n\n**No regressions** in existing test_markup.py tests (3/3 pass)\n\n## Implementation Analysis\n\n**Architecture (Stack Exchange approach):**\n1. math_extract.py (337 lines) - Token-based extraction using state machine\n2. dollar_escape.py (42 lines) - Simple \\$ → \u0026dollar; for text regions\n3. markup.py changes - 7-phase pipeline in markdown_input_converter()\n\n**Key Features:**\n- Solves FOUC problem (v1 limitation) - escaped dollars render immediately as HTML entities\n- Handles all LaTeX delimiters: $...$, $$...$$, \\[...\\], \\begin{env}...\\end{env}\n- Protects code spans via ~D placeholder technique\n- Preserves LaTeX \\$ inside math (for currency in equations)\n\n**Known Edge Cases (documented, tests skipped):**\n- Empty $$ requires different parsing approach\n\n## Verdict: COMMIT-READY\n\nAll tests pass, no regressions, well-documented code following proven Stack Exchange approach.","created_at":"2026-01-10T20:02:21Z"},{"id":14,"issue_id":"askbot-master-35c","author":"devop","text":"## Additional Edge Case Analysis\n\n**Double backslash + dollar bug:**\n- Input: `\\\\\\` (two backslashes + dollar, user wants \\$100)\n- Output: `\u0026amp;dollar;100` (literal text, BROKEN)\n- Cause: escape_dollars replaces `\\\\$` → `\\\\\u0026dollar;`, then markdown escapes the `\u0026`\n\n**Missing delimiter support:**\n- `\\\\(...\\\\)` delimiters NOT recognized as math\n- Markdown-it eats backslashes: `\\\\(x\\\\)` → `(x)`\n\n**Severity Assessment:**\n- Double-backslash bug: EDGE CASE - rare in practice (how often do users write `\\\\\\$`?)\n- Missing `\\\\(...\\\\)`: Known limitation, can be documented\n\n**Revised Verdict: COMMIT-READY with documented limitations**\n- Core functionality works correctly\n- All 35 tests pass\n- Edge cases are rare and can be addressed in follow-up work","created_at":"2026-01-10T20:07:45Z"},{"id":15,"issue_id":"askbot-master-35c","author":"devop","text":"## Final Verified Findings\n\n**Bugs Found (edge cases):**\n1. Math ending with `\\\\\\\\` not extracted: `$x^2 \\\\\\\\$` → blocks=[] (closing $ seen as escaped)\n2. `\\\\\\\\$` in text broken: `\\\\\\\\$100` → `\u0026amp;dollar;100` (docstring claims 'left alone' but code doesn't implement this)\n\n**Missing Feature:**\n- `\\\\(...\\\\)` delimiters not supported\n\n**Confirmed Working:**\n- Core delimiters ($, $$, \\\\[...\\\\], \\\\begin{env})\n- Single `\\\\$` escape (main use case) ✅\n- LaTeX `\\\\$` inside math ✅\n- Code spans AND fenced code blocks ✅\n- `\\\\\\\\` in middle of math ✅\n\n**Severity Assessment:** Edge cases are rare. Core functionality is solid.\n\n**Verdict: COMMIT-READY with documented limitations**","created_at":"2026-01-10T20:16:13Z"}]}
{"id":"askbot-master-37j","title":"Frontend migration (Phase 2): Replace Showdown with markdown-it.js","description":"Rough epic for Phase 2 frontend work. Detailed planning happens after backend is complete and tested.\n\n## Goal\nReplace outdated Showdown markdown library (~2011) with markdown-it.js to match Python backend, ensuring consistent rendering between server and client.\n\n## Critical Gaps Identified (from status document section 3.1)\n- CRITICAL: Sanitization missing from proposed frontend code (XSS risk)\n- CRITICAL: MathJax processing mismatch (preview ≠ saved content)\n- CRITICAL: Missing truncate_links.js plugin\n- CRITICAL: Rollback strategy contradiction (don't delete Showdown until Phase 3 validated)\n- HIGH: Syntax highlighting output mismatch (Pygments vs highlight.js)\n- HIGH: Escaped dollar handling missing (FOUC issue)\n\n## Key Files\n- `askbot/media/wmd/askbot_converter.js` - Main converter (needs rewrite)\n- `askbot/jinja2/meta/markdown_javascript.html` - Script includes\n- `askbot/media/wmd/Markdown.Sanitizer.js` - Keep for sanitization\n\n## Exit Criteria\n- Frontend renders markdown identically to backend\n- All browser tests passing\n- MathJax integration preserved\n- No JavaScript console errors\n\n## References\n- Source: tasks/markdown-upgrade-status.md section 3.1\n- Task file: tasks/markdown-upgrade-phase2-frontend.md","status":"open","priority":2,"issue_type":"epic","created_at":"2026-01-10T22:06:16.259589-03:00","created_by":"devop","updated_at":"2026-01-10T22:06:16.259589-03:00","dependencies":[{"issue_id":"askbot-master-37j","depends_on_id":"askbot-master-7o5","type":"blocks","created_at":"2026-01-10T22:23:41.58303-03:00","created_by":"devop"},{"issue_id":"askbot-master-37j","depends_on_id":"askbot-master-8xr","type":"blocks","created_at":"2026-01-11T12:38:51.409614-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j","depends_on_id":"askbot-master-9a9","type":"blocks","created_at":"2026-01-11T21:38:00.406513-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j","depends_on_id":"askbot-master-mxa","type":"blocks","created_at":"2026-01-12T12:10:44.443594-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j","depends_on_id":"askbot-master-7dy","type":"blocks","created_at":"2026-01-12T12:21:30.693301-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j","depends_on_id":"askbot-master-crx","type":"blocks","created_at":"2026-01-12T12:22:27.659191-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j","depends_on_id":"askbot-master-jij","type":"blocks","created_at":"2026-01-12T13:29:02.8128-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j","depends_on_id":"askbot-master-frm","type":"blocks","created_at":"2026-01-12T13:46:22.986209-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j","depends_on_id":"askbot-master-9b9","type":"blocks","created_at":"2026-01-13T10:53:22.021927-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j","depends_on_id":"askbot-master-hsr","type":"blocks","created_at":"2026-01-13T10:54:49.534815-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j","depends_on_id":"askbot-master-xmd","type":"blocks","created_at":"2026-01-13T10:56:27.447545-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j","depends_on_id":"askbot-master-8un","type":"blocks","created_at":"2026-01-13T10:59:16.986031-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j","depends_on_id":"askbot-master-ulk","type":"blocks","created_at":"2026-01-13T11:01:06.503797-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j","depends_on_id":"askbot-master-lai","type":"blocks","created_at":"2026-01-13T11:03:37.429797-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j","depends_on_id":"askbot-master-a8f","type":"blocks","created_at":"2026-01-13T11:29:32.150088-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j","depends_on_id":"askbot-master-uq7","type":"blocks","created_at":"2026-01-18T18:17:04.858243-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j","depends_on_id":"askbot-master-awh","type":"blocks","created_at":"2026-01-25T16:51:11.570291-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j","depends_on_id":"askbot-master-jvt","type":"blocks","created_at":"2026-01-25T16:53:48.965708-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j","depends_on_id":"askbot-master-3b8","type":"blocks","created_at":"2026-01-25T18:48:10.981264-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j","depends_on_id":"askbot-master-eb1","type":"blocks","created_at":"2026-01-25T19:26:09.777585-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j","depends_on_id":"askbot-master-r89","type":"blocks","created_at":"2026-01-25T19:27:14.884001-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j","depends_on_id":"askbot-master-esx","type":"blocks","created_at":"2026-01-28T10:45:17.913169-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j","depends_on_id":"askbot-master-25d","type":"blocks","created_at":"2026-01-31T18:30:29.451268-03:00","created_by":"Evgeny Fadeev"}],"comments":[{"id":57,"issue_id":"askbot-master-37j","author":"Evgeny Fadeev","text":"## Decision: Syntax Highlighting Approach (from askbot-master-8xr)\n\n**Decision:** Keep Pygments on backend, highlight.js on frontend, with CSS mapping.\n\n**Rationale:** \n- Pygments offers superior accuracy (598 languages vs 190) and is already implemented\n- highlight.js is lightweight for frontend (~30-50KB vs 10MB for Pyodide/WASM)\n- No Python port of highlight.js exists; running Node subprocess adds complexity\n- Token granularity differs (Pygments ~60 types, hljs ~30) but visual consistency is achievable\n\n**Implementation:** Create CSS that maps Pygments short classes to highlight.js-style colors:\n\n```css\n/* Map Pygments classes to hljs-style colors */\n.k, .kc, .kd, .kn, .kp, .kr { color: #d73a49; }  /* keywords */\n.kt { color: #6f42c1; }                           /* types */\n.nf, .fm { color: #6f42c1; }                      /* functions */\n.s, .s1, .s2, .sa, .sb, .sc, .sd, .se, .sh, .si, .sr, .ss, .sx { color: #032f62; }\n.c, .c1, .ch, .cm, .cp, .cpf, .cs { color: #6a737d; }\n.m, .mb, .mf, .mh, .mi, .mo, .il { color: #005cc5; }\n```\n\nThis ensures saved content (Pygments) and live preview (highlight.js) share the same color palette.\n\nKey file to update: askbot/media/sass/components/highlight.min.css","created_at":"2026-01-11T16:21:00Z"},{"id":64,"issue_id":"askbot-master-37j","author":"Evgeny Fadeev","text":"## Implementation Plan: Phase 2 Frontend Migration\n\n### Overview\nReplace Showdown with markdown-it.js to match backend exactly. 10 issues in dependency order.\n\n### Issue Breakdown\n\n**Phase 2.1: Foundation**\n1. **Add markdown-it.js and core dependencies** - Library setup (markdown-it.js, footnote, tasklists, DOMPurify)\n\n**Phase 2.2: Custom Plugin Ports (can run in parallel)**\n2. **Port truncate_links.js** - URL truncation to 40 chars with ellipsis\n3. **Port video_embed.js** - @[youtube](id), @[vimeo](id), @[dailymotion](id)\n4. **Port link_patterns.js** - Custom #bug123 pattern linking\n5. **Port asterisk_emphasis.js** - Code-friendly mode (*-only emphasis)\n\n**Phase 2.3: MathJax Handling**\n6. **Port math preprocessing** - Full math_extract.js + dollar_escape.js port (337 lines + 42 lines)\n   - protectCodeDollars, extractMath, escapeDollars, restoreCodeDollars, restoreMath\n\n**Phase 2.4: Syntax Highlighting**\n7. **Create Pygments ↔ highlight.js CSS mapping** - Map .k/.nf/.s classes to hljs colors\n\n**Phase 2.5: Integration**\n8. **Rewrite askbot_converter.js** - Replace Showdown with markdown-it, all plugins in correct order\n9. **Update script includes** - markdown_javascript.html updates, pass settings to JS\n\n**Phase 2.6: Testing**\n10. **Browser integration tests** - Side-by-side render comparison\n\n### Dependency Graph\n```\n[1: Foundation]\n    ├──\u003e [2-5: Plugin ports] ──┐\n    ├──\u003e [6: Math preprocessing]──┤\n    └──\u003e [7: CSS mapping] ────────┼──\u003e [8: Converter rewrite]\n                                  │            │\n                                  v            v\n                           [9: Script includes]\n                                  │\n                                  v\n                           [10: Browser tests]\n```\n\n### Key Matching Requirements\n- Plugin load order: footnotes → tasklists → video_embed → link_patterns → truncate_links → asterisk_emphasis\n- MathJax: Full 7-phase preprocessing (protect_code_dollars → extract_math → escape_dollars → render → restore_code_dollars → restore_math → sanitize)\n- URL truncation: 40 chars with '…' ellipsis\n- Keep Showdown for rollback until Phase 3 validated\n\n### Files to Create\n- askbot/media/wmd/truncate_links.js\n- askbot/media/wmd/video_embed.js\n- askbot/media/wmd/link_patterns.js\n- askbot/media/wmd/asterisk_emphasis.js\n- askbot/media/wmd/math_extract.js\n- askbot/media/sass/components/_pygments-compat.scss\n\n### Files to Modify\n- askbot/media/wmd/askbot_converter.js (rewrite)\n- askbot/jinja2/meta/markdown_javascript.html (update)","created_at":"2026-01-11T20:23:05Z"},{"id":69,"issue_id":"askbot-master-37j","author":"Evgeny Fadeev","text":"## Correction: File Paths in Implementation Plan\n\nThe 'Files to Create' section in the previous comment had incorrect paths. The correct paths (matching individual issues) are:\n\n### Files to Create\n- `askbot/media/wmd/markdown-it/vendor/markdown-it.min.js`\n- `askbot/media/wmd/markdown-it/vendor/markdown-it-footnote.min.js`\n- `askbot/media/wmd/markdown-it/vendor/markdown-it-task-lists.min.js`\n- `askbot/media/wmd/markdown-it/vendor/purify.min.js`\n- `askbot/media/wmd/markdown-it/plugins/truncate_links.js`\n- `askbot/media/wmd/markdown-it/plugins/video_embed.js`\n- `askbot/media/wmd/markdown-it/plugins/link_patterns.js`\n- `askbot/media/wmd/markdown-it/plugins/asterisk_emphasis.js`\n- `askbot/media/wmd/markdown-it/plugins/math_extract.js`\n- `askbot/media/sass/components/_pygments-compat.scss`\n\n### Files to Modify\n- `askbot/media/wmd/askbot_converter.js` (rewrite)\n- `askbot/jinja2/meta/markdown_javascript.html` (update)\n\n### Additional Clarification: Line Counts\nActual line counts: `math_extract.py` (336 lines) + `dollar_escape.py` (41 lines) = 377 total","created_at":"2026-01-11T21:01:42Z"},{"id":71,"issue_id":"askbot-master-37j","author":"Evgeny Fadeev","text":"## Plan Review: Corrections Needed\n\nAfter verifying the plan against the actual backend implementation (markup.py, all markdown_plugins/*.py), the plan is **largely correct** with a few issues to fix:\n\n### Issue #1: JavaScript Scoping Bug in 37j.8 (CRITICAL)\n\nThe MathJax pipeline pseudocode has a scoping error. `mathBlocks` is declared with `const` inside an `if` block, making it inaccessible in the second `if` block.\n\n**Current (buggy):**\n```javascript\nif (mathjaxEnabled) {\n  const { text: tokenized, mathBlocks } = extractMath(text);  // block-scoped!\n  text = escapeDollars(tokenized);\n}\nlet html = md.render(text);\nif (mathjaxEnabled) {\n  html = restoreMath(html, mathBlocks);  // ReferenceError: mathBlocks not defined\n}\n```\n\n**Corrected:**\n```javascript\nlet mathBlocks = null;\nif (mathjaxEnabled) {\n  text = protectCodeDollars(text);\n  const result = extractMath(text);\n  text = result.text;\n  mathBlocks = result.mathBlocks;\n  text = escapeDollars(text);\n}\nlet html = md.render(text);\nif (mathjaxEnabled) {\n  html = restoreCodeDollars(html);\n  if (mathBlocks) {\n    html = restoreMath(html, mathBlocks);\n  }\n}\nhtml = DOMPurify.sanitize(html);\n```\n\n### Issue #2: highlight.js Config Missing from Main Plugin Order (MEDIUM)\n\nThe \"Plugin Load Order\" section should include `md.options.highlight` inline (not just in a separate comment) to match the backend order:\n\n```javascript\nmd.enable('linkify');\nmd.options.highlight = function(code, lang) { ... };  // ADD THIS LINE\nmd.use(footnotePlugin);\n```\n\n### Issue #3: Missing Conditional for restore_math (MINOR)\n\nBackend has `if math_blocks:` before `restore_math()`. Already captured in Issue #1 fix above.\n\n---\n\n### Verified Correct\n\n- Plugin load order matches backend (markup.py:103-142)\n- All 6 plugin port specifications are accurate\n- MathJax 7-phase pipeline structure is correct\n- File paths match (per correction comment)\n- Dependency graph is sound\n- CSS mapping approach is valid","created_at":"2026-01-11T21:09:16Z"}]}
{"id":"askbot-master-37j.1","title":"Add markdown-it.js library and core dependencies","description":"## Goal\nSet up the foundation for frontend markdown migration by adding required JavaScript libraries.\n\n## Directory Structure\n```\naskbot/media/wmd/markdown-it/\n├── vendor/\n│   ├── markdown-it.min.js\n│   ├── markdown-it-footnote.min.js\n│   ├── markdown-it-task-lists.min.js\n│   └── purify.min.js\n└── plugins/\n    └── (custom plugins created in subsequent issues)\n```\n\n## Tasks\n1. Create directory structure: `askbot/media/wmd/markdown-it/vendor/`\n2. Download and bundle markdown-it.js\n3. Download and bundle markdown-it-footnote plugin\n4. Download and bundle markdown-it-task-lists plugin\n5. Download and bundle DOMPurify (purify.min.js)\n\n## Static Asset Pattern\n```html\n\u003cscript src=\"{{ '/wmd/markdown-it/vendor/markdown-it.min.js'|media }}\"\u003e\u003c/script\u003e\n```\n\n## Acceptance Criteria\n- [ ] Directory structure created\n- [ ] All libraries bundled locally\n- [ ] Libraries accessible globally in browser\n- [ ] No JavaScript console errors\n\n## Notes\n- Bundle locally (no CDN) for reliability\n- WMD editor unchanged - only adding new converter","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T17:25:17.293692-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-11T20:21:28.599874-03:00","closed_at":"2026-01-11T20:21:28.599874-03:00","close_reason":"Closed","dependencies":[{"issue_id":"askbot-master-37j.1","depends_on_id":"askbot-master-37j","type":"parent-child","created_at":"2026-01-11T17:25:17.294276-03:00","created_by":"Evgeny Fadeev"}],"comments":[{"id":65,"issue_id":"askbot-master-37j.1","author":"Evgeny Fadeev","text":"## Clarification: highlight.js Availability\n\nhighlight.js already exists at `/jslib/highlight.min.js` and is loaded in page templates (question.html, ask.html, etc.). No need to add to vendor/.\n\n**Important:** Ensure highlight.js is included in markdown_javascript.html BEFORE askbot_converter.js loads.","created_at":"2026-01-11T20:55:36Z"}]}
{"id":"askbot-master-37j.10","title":"Browser integration tests for markdown parity","description":"## Goal\nCreate browser tests verifying frontend preview matches backend rendering exactly.\n\n## Test Cases\n- Basic markdown (bold, italic, headings, lists)\n- Tables, footnotes, task lists\n- Video embeds: @[youtube](id)\n- Link patterns: #bug123\n- URL truncation (\u003e 40 chars)\n- Code-friendly mode (snake_case)\n- MathJax: $x=5$, $$y=mx+b$$, \\$100\n\n## Acceptance Criteria\n- [ ] Frontend output matches backend for all cases\n- [ ] No JavaScript console errors\n- [ ] Preview renders within 100ms","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T17:41:41.098717-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-12T18:27:46.402473-03:00","closed_at":"2026-01-12T18:27:46.402473-03:00","close_reason":"Closed","dependencies":[{"issue_id":"askbot-master-37j.10","depends_on_id":"askbot-master-37j","type":"parent-child","created_at":"2026-01-11T17:41:41.099309-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j.10","depends_on_id":"askbot-master-37j.9","type":"blocks","created_at":"2026-01-11T17:43:08.661452-03:00","created_by":"Evgeny Fadeev"}],"comments":[{"id":78,"issue_id":"askbot-master-37j.10","author":"Evgeny Fadeev","text":"## Implementation Plan: Markdown Parity Testing\n\n**Goal:** Automatically verify Python and JavaScript markdown converters produce identical output using Django's test framework.\n\n### Approach\nNode.js subprocess called from Django tests:\n1. Django test class defines test cases (markdown input + settings)\n2. Renders via Python markdown converter\n3. Spawns Node.js subprocess to render via JS converter\n4. Compares outputs with normalization\n\n### Files to Create\n- `askbot/tests/js/package.json` - npm dependencies\n- `askbot/tests/js/markdown_parity_runner.js` - Node test runner\n- `askbot/tests/test_markdown_parity.py` - Django test class\n\n### Files to Modify (add CommonJS exports)\n- `askbot/media/wmd/markdown-it/plugins/link_patterns.js`\n- `askbot/media/wmd/markdown-it/plugins/video_extract.js`\n\n### Test Cases\n- Basic markdown (bold, italic, headings, lists)\n- Tables, footnotes, task lists\n- Video embeds (@[youtube](id))\n- Link patterns (#bug123)\n- URL truncation (\u003e 40 chars)\n- Code-friendly mode (snake_case)\n- MathJax ($x=5$, $$y=mx+b$$, \\$100)\n\n### Design Decisions\n1. Node.js subprocess (not embedded JS) - uses npm packages directly\n2. Graceful skip if Node.js not installed\n3. Skip syntax highlighting class comparison\n4. Test math extraction/restoration only (skip browser typesetting)\n5. BeautifulSoup normalization for HTML comparison\n\n### Verification\n```bash\ncd askbot_site \u0026\u0026 ../env-md/bin/python manage.py test askbot.tests.test_markdown_parity\n```","created_at":"2026-01-12T21:03:42Z"}]}
{"id":"askbot-master-37j.2","title":"Port truncate_links.js plugin","description":"## Goal\nPort Python truncate_links plugin to JavaScript to ensure URL display matches backend exactly.\n\n## Source\n`askbot/utils/markdown_plugins/truncate_links.py` (135 lines)\n\n## Algorithm\n```javascript\nfunction truncateUrlText(text, limit) {\n  if (limit == null || limit \u003c= 0 || text.length \u003c= limit) return text;\n  return text.slice(0, Math.max(0, limit - 1)) + '…';  // U+2026 ellipsis\n}\n```\n\n## Requirements\n- Only truncate URLs created by linkify (check `token.markup === 'linkify'`)\n- Truncate to 40 characters (match Django's urlize trim_url_limit)\n- Add `title` attribute with full URL when truncated\n- Use actual ellipsis character `…` (U+2026)\n\n## File\n- Create: `askbot/media/wmd/markdown-it/plugins/truncate_links.js`\n\n## Acceptance Criteria\n- [ ] URLs \u003e 40 chars truncated with ellipsis\n- [ ] Title attribute contains full URL\n- [ ] Only linkify-created links affected\n- [ ] Output matches backend exactly","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T17:26:20.895826-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-11T20:59:30.639632-03:00","closed_at":"2026-01-11T20:59:30.639632-03:00","close_reason":"Closed","dependencies":[{"issue_id":"askbot-master-37j.2","depends_on_id":"askbot-master-37j","type":"parent-child","created_at":"2026-01-11T17:26:20.896392-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j.2","depends_on_id":"askbot-master-37j.1","type":"blocks","created_at":"2026-01-11T17:42:51.220672-03:00","created_by":"Evgeny Fadeev"}],"comments":[{"id":70,"issue_id":"askbot-master-37j.2","author":"Evgeny Fadeev","text":"## Clarification: Rule Registration Order\n\nFor robustness, explicitly register the core rule AFTER 'linkify' (matches Python implementation):\n\n```javascript\n// Run after linkify to process its output\nmd.core.ruler.after('linkify', 'truncate_links', truncateLinksCoreRule);\n```\n\nThis ensures the rule only runs after linkify has created the link tokens, matching the Python backend:\n```python\nmd.core.ruler.after('linkify', 'truncate_linkify_urls', truncate_links_core_rule)\n```","created_at":"2026-01-11T21:01:48Z"}]}
{"id":"askbot-master-37j.3","title":"Port video_embed.js plugin","description":"## Goal\nPort Python video_embed plugin to JavaScript for @[service](id) syntax.\n\n## Source\n`askbot/utils/markdown_plugins/video_embed.py` (140 lines)\n\n## Syntax\n- `@[youtube](VIDEO_ID)` → YouTube embed\n- `@[vimeo](VIDEO_ID)` → Vimeo embed\n- `@[dailymotion](VIDEO_ID)` → Dailymotion embed\n\n## Requirements\n- Register rule BEFORE 'link' rule for priority\n- Validate video ID: only `[a-zA-Z0-9_-]+`\n- Output: `\u003cdiv class=\"video-embed video-embed-{service}\"\u003e...\u003c/div\u003e`\n- Include `loading=\"lazy\"` on iframe\n\n## File\n- Create: `askbot/media/wmd/markdown-it/plugins/video_embed.js`\n\n## Acceptance Criteria\n- [ ] All three services render correctly\n- [ ] Invalid video IDs not converted\n- [ ] Output matches backend HTML exactly","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T17:26:26.510741-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-11T20:43:30.360549-03:00","closed_at":"2026-01-11T20:43:30.360549-03:00","close_reason":"Closed","dependencies":[{"issue_id":"askbot-master-37j.3","depends_on_id":"askbot-master-37j","type":"parent-child","created_at":"2026-01-11T17:26:26.511288-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j.3","depends_on_id":"askbot-master-37j.1","type":"blocks","created_at":"2026-01-11T17:42:51.33995-03:00","created_by":"Evgeny Fadeev"}]}
{"id":"askbot-master-37j.4","title":"Port link_patterns.js plugin","description":"## Goal\nPort Python link_patterns plugin to JavaScript for custom auto-linking.\n\n## Source\n`askbot/utils/markdown_plugins/link_patterns.py` (219 lines)\n\n## Example\nPattern: `#bug(\\d+)`, URL: `https://bugs.example.com/\\1`\nInput: `Fixed #bug123` → Output: `Fixed \u003ca href=\"...123\"\u003e#bug123\u003c/a\u003e`\n\n## Requirements\n- Register rule AFTER 'linkify'\n- Support \\1, \\2 capture group substitution\n- Handle overlapping matches (first wins)\n- Read config from `askbot.settings.autoLink*`\n\n## File\n- Create: `askbot/media/wmd/markdown-it/plugins/link_patterns.js`\n\n## Acceptance Criteria\n- [ ] Pattern matches converted to links\n- [ ] Capture groups work correctly\n- [ ] Output matches backend exactly","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T17:26:30.10735-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-11T20:55:13.219615-03:00","closed_at":"2026-01-11T20:55:13.219615-03:00","close_reason":"Closed","dependencies":[{"issue_id":"askbot-master-37j.4","depends_on_id":"askbot-master-37j","type":"parent-child","created_at":"2026-01-11T17:26:30.107852-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j.4","depends_on_id":"askbot-master-37j.1","type":"blocks","created_at":"2026-01-11T17:42:51.456168-03:00","created_by":"Evgeny Fadeev"}]}
{"id":"askbot-master-37j.5","title":"Port asterisk_emphasis.js plugin","description":"## Goal\nPort Python asterisk_emphasis plugin for code-friendly mode.\n\n## Source\n`askbot/utils/markdown_plugins/asterisk_emphasis.py` (137 lines)\n\n## Purpose\nWhen code-friendly mode enabled:\n- Keep `*italic*` and `**bold**` working\n- Disable `_italic_` and `__bold__`\n- Preserves snake_case variable names\n\n## Requirements\n- Only load when `askbot.settings.markupCodeFriendly === true`\n- Replace emphasis rule to only handle `*` marker (0x2A)\n\n## File\n- Create: `askbot/media/wmd/markdown-it/plugins/asterisk_emphasis.js`\n\n## Acceptance Criteria\n- [ ] *italic* → \u003cem\u003e, **bold** → \u003cstrong\u003e\n- [ ] _text_ and __text__ render literally\n- [ ] Only active when setting enabled","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T17:26:36.02471-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-11T20:50:57.995566-03:00","closed_at":"2026-01-11T20:50:57.995566-03:00","close_reason":"Closed","dependencies":[{"issue_id":"askbot-master-37j.5","depends_on_id":"askbot-master-37j","type":"parent-child","created_at":"2026-01-11T17:26:36.025212-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j.5","depends_on_id":"askbot-master-37j.1","type":"blocks","created_at":"2026-01-11T17:42:51.573124-03:00","created_by":"Evgeny Fadeev"}]}
{"id":"askbot-master-37j.6","title":"Port math preprocessing (math_extract.js + dollar_escape.js)","description":"## Goal\nPort Python MathJax preprocessing to JavaScript for exact backend parity.\n\n## Source\n- `askbot/utils/markdown_plugins/math_extract.py` (337 lines)\n- `askbot/utils/markdown_plugins/dollar_escape.py` (42 lines)\n\n## Functions\n- `protectCodeDollars(text)` - $ → ~D in backticks\n- `extractMath(text)` → `{text, mathBlocks}` - Extract to @@N@@ tokens\n- `escapeDollars(text)` - \\$ → \u0026dollar;\n- `restoreCodeDollars(html)` - ~D → $\n- `restoreMath(html, mathBlocks)` - @@N@@ → original\n\n## Supported Delimiters\n- `$...$`, `$$...$$`, `\\[...\\]`, `\\begin{env}...\\end{env}`\n\n## File\n- Create: `askbot/media/wmd/markdown-it/plugins/math_extract.js`\n\n## Acceptance Criteria\n- [ ] All delimiter types extracted/restored correctly\n- [ ] $ in code spans not treated as math\n- [ ] \\$100 renders as $100 immediately\n- [ ] Output matches backend exactly","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T17:28:07.357576-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-11T20:44:24.751728-03:00","closed_at":"2026-01-11T20:44:24.751728-03:00","close_reason":"Closed","dependencies":[{"issue_id":"askbot-master-37j.6","depends_on_id":"askbot-master-37j","type":"parent-child","created_at":"2026-01-11T17:28:07.358131-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j.6","depends_on_id":"askbot-master-37j.1","type":"blocks","created_at":"2026-01-11T17:42:51.690742-03:00","created_by":"Evgeny Fadeev"}],"comments":[{"id":66,"issue_id":"askbot-master-37j.6","author":"Evgeny Fadeev","text":"## Clarification: Single-File Approach\n\nThe JS version combines all 5 functions into a single `math_extract.js` file for simpler loading:\n\n```\naskbot/media/wmd/markdown-it/plugins/math_extract.js\n```\n\nContains:\n- `protectCodeDollars(text)` - $ → ~D in backticks\n- `extractMath(text)` → `{text, mathBlocks}`\n- `escapeDollars(text)` - \\$ → \u0026dollar;\n- `restoreCodeDollars(html)` - ~D → $\n- `restoreMath(html, mathBlocks)` - @@N@@ → original\n\n**Note:** Unlike Python which splits into `math_extract.py` (337 lines) + `dollar_escape.py` (42 lines), the JS version is combined for simpler module loading in the browser.","created_at":"2026-01-11T20:55:49Z"}]}
{"id":"askbot-master-37j.7","title":"Create Pygments ↔ highlight.js CSS mapping","description":"## Goal\nCreate CSS that maps Pygments token classes to highlight.js-style colors.\n\n## Background\n- Backend uses Pygments for syntax highlighting (outputs classes like .k, .nf, .s)\n- Frontend uses highlight.js (outputs classes like .hljs-keyword, .hljs-function)\n- Decision (from askbot-master-8xr): Use CSS mapping to share color palette\n\n## Implementation\nCreate stylesheet that targets Pygments classes with highlight.js-compatible colors:\n\n```scss\n// Keywords\n.k, .kc, .kd, .kn, .kp, .kr { color: #d73a49; }\n\n// Types\n.kt { color: #6f42c1; }\n\n// Functions\n.nf, .fm { color: #6f42c1; }\n\n// Strings\n.s, .s1, .s2, .sa, .sb, .sc, .sd, .se, .sh, .si, .sr, .ss, .sx { color: #032f62; }\n\n// Comments\n.c, .c1, .ch, .cm, .cp, .cpf, .cs { color: #6a737d; }\n\n// Numbers\n.m, .mb, .mf, .mh, .mi, .mo, .il { color: #005cc5; }\n\n// Operators\n.o, .ow { color: #d73a49; }\n\n// Names/variables\n.n, .na, .nb, .nc, .nd, .ne, .ni, .nl, .nn, .no, .nt, .nv { color: #24292e; }\n```\n\n## Files\n- Create: `askbot/media/sass/components/_pygments-compat.scss`\n- Update: Include in main stylesheet compilation\n\n## Acceptance Criteria\n- [ ] Backend-rendered code blocks styled correctly\n- [ ] Colors match between preview (hljs) and saved (Pygments)\n- [ ] All major token types covered (keywords, strings, comments, etc.)\n- [ ] Dark mode support (if applicable)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T17:28:14.739935-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-11T21:00:08.044623-03:00","closed_at":"2026-01-11T21:00:08.044623-03:00","close_reason":"Closed","dependencies":[{"issue_id":"askbot-master-37j.7","depends_on_id":"askbot-master-37j","type":"parent-child","created_at":"2026-01-11T17:28:14.740437-03:00","created_by":"Evgeny Fadeev"}]}
{"id":"askbot-master-37j.8","title":"Rewrite askbot_converter.js to use markdown-it","description":"## Goal\nReplace Showdown with markdown-it, loading all plugins in exact backend order.\n\n## Plugin Load Order (MUST MATCH BACKEND)\n```javascript\nconst md = markdownit('commonmark', { linkify: true, typographer: false });\nmd.enable(['table', 'strikethrough']);\nmd.enable('linkify');\n\n// Syntax highlighting (must be before plugins)\nmd.options.highlight = function(code, lang) {\n  if (lang \u0026\u0026 hljs.getLanguage(lang)) {\n    try {\n      return hljs.highlight(code, {language: lang}).value;\n    } catch (_) {}\n  }\n  return '';  // Let markdown-it escape the code\n};\n\nmd.use(footnotePlugin);\nmd.use(tasklistsPlugin);\nmd.use(videoEmbedPlugin);\nmd.use(linkPatternsPlugin, { enabled, patterns, urls });\nmd.use(truncateLinksPlugin, { trimLimit: 40 });\nif (askbot.settings.markupCodeFriendly) {\n  md.use(asteriskEmphasisPlugin);\n}\n```\n\n## MathJax Pipeline\n```javascript\n// MathJax preprocessing\nlet mathBlocks = null;\nif (mathjaxEnabled) {\n  text = protectCodeDollars(text);\n  const result = extractMath(text);\n  text = result.text;\n  mathBlocks = result.mathBlocks;\n  text = escapeDollars(text);\n}\n\n// Markdown rendering\nlet html = md.render(text);\n\n// MathJax postprocessing\nif (mathjaxEnabled) {\n  html = restoreCodeDollars(html);\n  if (mathBlocks) {\n    html = restoreMath(html, mathBlocks);\n  }\n}\n\n// Sanitization (CRITICAL for XSS prevention)\nhtml = DOMPurify.sanitize(html);\n```\n\n## MathJax Re-rendering (CRITICAL)\nAfter markdown→HTML conversion, MathJax must typeset the math in the DOM.\nKeep existing pattern from current askbot_converter.js:\n```javascript\n// Push HTML update to MathJax queue (ensures proper sequencing)\nMathJax.Hub.queue.Push(function() {\n  $('.wmd-preview').html(html);\n});\n// Schedule typesetting with debounce (500ms)\nscheduleMathJaxRendering(); // calls MathJax.Hub.Queue(['Typeset', MathJax.Hub, 'previewer'])\n```\nThis ensures MathJax processes the restored `$...$` and `$$...$$` delimiters after DOM update.\n\n## File\n- Modify: `askbot/media/wmd/askbot_converter.js`\n\n## Acceptance Criteria\n- [ ] Uses markdown-it instead of Showdown\n- [ ] All plugins loaded in correct order (including highlight.js config)\n- [ ] MathJax preprocessing pipeline (extract → render → restore)\n- [ ] MathJax postprocessing with conditional restore_math\n- [ ] MathJax re-rendering after DOM update (via Hub.Queue)\n- [ ] 500ms debounce on MathJax typesetting\n- [ ] DOMPurify sanitization\n- [ ] Singleton pattern maintained\n- [ ] No breaking changes to WMD editor integration","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T17:28:27.272038-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-11T21:04:33.37616-03:00","closed_at":"2026-01-11T21:04:33.37616-03:00","close_reason":"Closed","dependencies":[{"issue_id":"askbot-master-37j.8","depends_on_id":"askbot-master-37j","type":"parent-child","created_at":"2026-01-11T17:28:27.272569-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j.8","depends_on_id":"askbot-master-37j.2","type":"blocks","created_at":"2026-01-11T17:42:59.286926-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j.8","depends_on_id":"askbot-master-37j.3","type":"blocks","created_at":"2026-01-11T17:42:59.409705-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j.8","depends_on_id":"askbot-master-37j.4","type":"blocks","created_at":"2026-01-11T17:42:59.525704-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j.8","depends_on_id":"askbot-master-37j.5","type":"blocks","created_at":"2026-01-11T17:42:59.645555-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j.8","depends_on_id":"askbot-master-37j.6","type":"blocks","created_at":"2026-01-11T17:42:59.760399-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j.8","depends_on_id":"askbot-master-37j.7","type":"blocks","created_at":"2026-01-11T17:42:59.876794-03:00","created_by":"Evgeny Fadeev"}],"comments":[{"id":67,"issue_id":"askbot-master-37j.8","author":"Evgeny Fadeev","text":"## Addition: highlight.js Configuration\n\nAdd syntax highlighting configuration to markdown-it (mirrors Python backend's `md.options['highlight'] = highlight_code`):\n\n```javascript\n// Configure syntax highlighting with highlight.js\nmd.options.highlight = function(code, lang) {\n  if (lang \u0026\u0026 hljs.getLanguage(lang)) {\n    try {\n      return hljs.highlight(code, {language: lang}).value;\n    } catch (_) {}\n  }\n  return ''; // Let markdown-it escape the code\n};\n```\n\nThis ensures code blocks in preview are syntax-highlighted, matching the Pygments output on backend (with CSS mapping from 37j.7 for visual consistency).","created_at":"2026-01-11T20:55:59Z"},{"id":72,"issue_id":"askbot-master-37j.8","author":"Evgeny Fadeev","text":"## Correction: MathJax Pipeline Pseudocode\n\nThe current pseudocode has a JavaScript scoping bug. Replace the MathJax Pipeline section with:\n\n```javascript\n// MathJax preprocessing\nlet mathBlocks = null;\nif (mathjaxEnabled) {\n  text = protectCodeDollars(text);\n  const result = extractMath(text);\n  text = result.text;\n  mathBlocks = result.mathBlocks;\n  text = escapeDollars(text);\n}\n\n// Markdown rendering\nlet html = md.render(text);\n\n// MathJax postprocessing\nif (mathjaxEnabled) {\n  html = restoreCodeDollars(html);\n  if (mathBlocks) {\n    html = restoreMath(html, mathBlocks);\n  }\n}\n\n// Sanitization (CRITICAL for XSS prevention)\nhtml = DOMPurify.sanitize(html);\n```\n\nAlso update the Plugin Load Order to include highlight.js config inline:\n\n```javascript\nconst md = markdownit('commonmark', { linkify: true, typographer: false });\nmd.enable(['table', 'strikethrough']);\nmd.enable('linkify');\n\n// Syntax highlighting (must be before plugins)\nmd.options.highlight = function(code, lang) {\n  if (lang \u0026\u0026 hljs.getLanguage(lang)) {\n    try {\n      return hljs.highlight(code, {language: lang}).value;\n    } catch (_) {}\n  }\n  return '';  // Let markdown-it escape the code\n};\n\nmd.use(footnotePlugin);\nmd.use(tasklistsPlugin);\n// ... rest of plugins\n```","created_at":"2026-01-11T21:09:27Z"},{"id":73,"issue_id":"askbot-master-37j.8","author":"Evgeny Fadeev","text":"## Description Updated\n\nIncorporated corrections from parent epic comments:\n- Added `md.options.highlight` to Plugin Load Order (after `md.enable('linkify')`)\n- Fixed JavaScript scoping bug: `mathBlocks` now declared at outer scope\n- Added conditional check `if (mathBlocks)` before `restoreMath()`\n\nThe description now matches the backend implementation exactly.","created_at":"2026-01-11T21:16:11Z"}]}
{"id":"askbot-master-37j.9","title":"Update script includes in markdown_javascript.html","description":"## Goal\nUpdate template to include new markdown-it scripts and pass settings to JavaScript.\n\n## File\n`askbot/jinja2/meta/markdown_javascript.html`\n\n## Script Includes to Add\n```html\n\u003c!-- markdown-it vendor libraries --\u003e\n\u003cscript src=\"{{ '/wmd/markdown-it/vendor/markdown-it.min.js'|media }}\"\u003e\u003c/script\u003e\n\u003cscript src=\"{{ '/wmd/markdown-it/vendor/markdown-it-footnote.min.js'|media }}\"\u003e\u003c/script\u003e\n\u003cscript src=\"{{ '/wmd/markdown-it/vendor/markdown-it-task-lists.min.js'|media }}\"\u003e\u003c/script\u003e\n\u003cscript src=\"{{ '/wmd/markdown-it/vendor/purify.min.js'|media }}\"\u003e\u003c/script\u003e\n\n\u003c!-- markdown-it custom plugins --\u003e\n\u003cscript src=\"{{ '/wmd/markdown-it/plugins/truncate_links.js'|media }}\"\u003e\u003c/script\u003e\n\u003cscript src=\"{{ '/wmd/markdown-it/plugins/video_embed.js'|media }}\"\u003e\u003c/script\u003e\n\u003cscript src=\"{{ '/wmd/markdown-it/plugins/link_patterns.js'|media }}\"\u003e\u003c/script\u003e\n\u003cscript src=\"{{ '/wmd/markdown-it/plugins/asterisk_emphasis.js'|media }}\"\u003e\u003c/script\u003e\n\u003cscript src=\"{{ '/wmd/markdown-it/plugins/math_extract.js'|media }}\"\u003e\u003c/script\u003e\n```\n\n## Settings to Pass\n```html\n\u003cscript\u003e\naskbot.settings = askbot.settings || {};\naskbot.settings.mathjaxEnabled = {{ settings.ENABLE_MATHJAX|tojson }};\naskbot.settings.markupCodeFriendly = {{ settings.MARKUP_CODE_FRIENDLY|tojson }};\naskbot.settings.autoLinkingEnabled = {{ settings.ENABLE_AUTO_LINKING|tojson }};\naskbot.settings.autoLinkPatterns = {{ settings.AUTO_LINK_PATTERNS|tojson }};\naskbot.settings.autoLinkUrls = {{ settings.AUTO_LINK_URLS|tojson }};\n\u003c/script\u003e\n```\n\n## Important\n- Keep existing Showdown/WMD files for rollback\n- WMD editor scripts unchanged\n\n## Acceptance Criteria\n- [ ] All scripts loaded using |media filter\n- [ ] Settings passed to JavaScript\n- [ ] No 404 errors\n- [ ] Converter initializes correctly","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T17:41:22.727994-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-11T21:06:57.412812-03:00","closed_at":"2026-01-11T21:06:57.412812-03:00","close_reason":"Closed","dependencies":[{"issue_id":"askbot-master-37j.9","depends_on_id":"askbot-master-37j","type":"parent-child","created_at":"2026-01-11T17:41:22.728532-03:00","created_by":"Evgeny Fadeev"},{"issue_id":"askbot-master-37j.9","depends_on_id":"askbot-master-37j.8","type":"blocks","created_at":"2026-01-11T17:43:08.542676-03:00","created_by":"Evgeny Fadeev"}],"comments":[{"id":68,"issue_id":"askbot-master-37j.9","author":"Evgeny Fadeev","text":"## Addition: highlight.js Script Order\n\nhighlight.js must be loaded BEFORE askbot_converter.js. Update script includes to:\n\n```html\n\u003c!-- Syntax highlighting (already exists at this path) --\u003e\n\u003cscript src=\"{{ '/jslib/highlight.min.js'|media }}\"\u003e\u003c/script\u003e\n\n\u003c!-- markdown-it vendor libraries --\u003e\n\u003cscript src=\"{{ '/wmd/markdown-it/vendor/markdown-it.min.js'|media }}\"\u003e\u003c/script\u003e\n\u003cscript src=\"{{ '/wmd/markdown-it/vendor/markdown-it-footnote.min.js'|media }}\"\u003e\u003c/script\u003e\n\u003cscript src=\"{{ '/wmd/markdown-it/vendor/markdown-it-task-lists.min.js'|media }}\"\u003e\u003c/script\u003e\n\u003cscript src=\"{{ '/wmd/markdown-it/vendor/purify.min.js'|media }}\"\u003e\u003c/script\u003e\n\n\u003c!-- markdown-it custom plugins --\u003e\n...\n```\n\n**Note:** highlight.js is already in `/jslib/` - just needs to be included in markdown_javascript.html in the right order.","created_at":"2026-01-11T20:56:10Z"}]}
{"id":"askbot-master-3b8","title":"In the Ask page there is a sidebar with a rudimentary markdown help. Add to that section a statement that users can find more info by clicking the ? icon in the editor","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-25T18:47:52.978887-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-25T20:25:40.736399-03:00","closed_at":"2026-01-25T20:25:40.736399-03:00","close_reason":"Closed","comments":[{"id":88,"issue_id":"askbot-master-3b8","author":"Evgeny Fadeev","text":"Added help icon hint to sidebar markdown help in askbot/jinja2/components/markdown_help.html. New list item at the bottom of the markdown basics list tells users to click the ? icon in the editor for more help. Uses {% trans %} for i18n support and \u003cstrong\u003e to highlight the ? icon.","created_at":"2026-01-25T23:24:38Z"}]}
{"id":"askbot-master-45z","title":"Commit beads configuration files","description":"Commit the beads setup files (issues.jsonl already tracked).\n\nFiles to commit:\n- .beads/.gitignore - Defines local runtime files to ignore\n- .beads/README.md - Beads documentation\n- .beads/config.yaml - Team-shared configuration\n- .beads/interactions.jsonl - Interaction history\n- .beads/metadata.json - Repo metadata\n\nNote: issues.jsonl is already being tracked (auto-committed with changes).\n\nThe .gitignore correctly excludes:\n- SQLite database files (*.db*) - local cache\n- Daemon runtime files (daemon.*, bd.sock)\n- Local state (.local_version, last-touched)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T20:48:30.678364-03:00","created_by":"devop","updated_at":"2026-01-10T20:53:35.799999-03:00","closed_at":"2026-01-10T20:53:35.799999-03:00","close_reason":"Closed"}
{"id":"askbot-master-4gc","title":"Audit task file: markdown-upgrade-linkify.md","description":"Analyze tasks/markdown-upgrade-linkify.md - Linkify implementation details. Check if work is complete per commits.","notes":"## Audit Instructions\n\n**Before starting:**\n1. Read `tasks/markdown-upgrade-status.md` to understand the document structure and current state\n\n**When completing this audit:**\n1. **Add findings to this bd issue** using `bd comments add \u003cissue-id\u003e` with key observations\n2. **Edit ONLY your relevant section** in `tasks/markdown-upgrade-status.md` - do NOT overwrite the entire file\n3. **Reference this issue ID** (e.g., `askbot-master-xxx`) in the status file where you add findings\n4. **Update the Audit Trail table** at the bottom - change your row status from `pending` to `done`\n5. When complete, close this issue with `bd close \u003cissue-id\u003e`\n\n**Important:** Use the Edit tool to modify specific sections. Do not use Write to replace the whole file.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:16:49.014248-03:00","created_by":"devop","updated_at":"2026-01-10T18:18:19.231902-03:00","closed_at":"2026-01-10T18:18:19.231902-03:00","close_reason":"Closed","labels":["audit","task-file"],"dependencies":[{"issue_id":"askbot-master-4gc","depends_on_id":"askbot-master-d30","type":"blocks","created_at":"2026-01-10T14:25:12.03811-03:00","created_by":"devop"}],"comments":[{"id":16,"issue_id":"askbot-master-4gc","author":"devop","text":"## Audit Findings: markdown-upgrade-linkify.md\n\n**Status:** COMPLETED (task file status is outdated)\n\n### Implementation Verified ✅\n- **Plugin:** `truncate_links.py` (135 lines) - truncates URLs to 40 chars, adds title attribute\n- **Integration:** Enabled in `markup.py` line 105 (`{'linkify': True}`) and line 132 (`md.use(truncate_links_plugin)`)\n- **urlize_html removed:** Confirmed - no longer in markdown pipeline\n\n### Testing Verified ✅\n- **Unit tests:** 16/16 pass (`test_markdown_truncate_links_plugin.py`, 261 lines)\n- **Integration tests:** 12/12 pass (`test_markdown_integration.py`)\n- **Test coverage:** Inline code protection, code block protection, fuzzy link detection, truncation, title attributes, multiple URLs\n\n### Task File Assessment\n- **Checklist discrepancy:** Task file shows 'Testing' items unchecked but tests ARE implemented per commit ea2f58fa4\n- **Document is accurate:** Implementation details, rollback procedure, frontend JS example all verified\n- **Behavioral changes documented:** Fuzzy link detection (example.com now auto-links)\n\n### Key Implementation Details\n| Feature | Status | Verification |\n|---------|--------|--------------|\n| Linkify enabled | ✅ | markup.py line 105 |\n| Truncation at 40 chars | ✅ | test_url_truncation_at_40_chars passes |\n| Title attribute on long URLs | ✅ | test_title_attribute_on_truncated_url passes |\n| Code protection | ✅ | test_inline_code_protection, test_code_block_protection pass |\n| Fuzzy links | ✅ | test_fuzzy_link_detection passes |\n| urlize_html removed | ✅ | Not imported in markup.py |\n\n### Recommendation\nUpdate task file status from 'Testing Pending' to 'Complete' - all checkboxes under Testing should be marked done.","created_at":"2026-01-10T21:08:59Z"},{"id":17,"issue_id":"askbot-master-4gc","author":"devop","text":"## REVISED Audit Findings: markdown-upgrade-linkify.md\n\n### Implementation: COMPLETE ✅\n\nAll 8 implementation checklist items verified done:\n- `truncate_links.py` plugin (135 lines) integrated at markup.py:132\n- Linkify enabled at markup.py:105 (`{'linkify': True}`)\n- `urlize_html` removed from pipeline\n\n### Testing: MOSTLY COMPLETE ⚠️ (with known gap)\n\n**Tests pass:** 16/16 unit + 12/12 integration + 3/3 markup = **31/31 pass**\n\n**Checklist mapping (12 items):**\n| Task File Item | Actual Test | Status |\n|----------------|-------------|--------|\n| inline code protection | test_inline_code_protection | ✅ |\n| code block protection | test_code_block_protection | ✅ |\n| URL truncation 40 chars | test_url_truncation_at_40_chars | ✅ |\n| title attribute | test_title_attribute_on_truncated_url | ✅ |\n| fuzzy link detection | test_fuzzy_link_detection | ✅ |\n| www. detection | test_www_detection | ✅ |\n| HTML links unchanged | test_anchor_stays_untouched | ✅ |\n| markdown links unchanged | test_markdown_links_unchanged | ✅ |\n| **raw HTML block protection** | **(REMOVED in 339de84e0)** | **❌ GAP** |\n\n**Key finding:** Commit 339de84e0 removed `test_convert_mixed_text` which tested URLs inside raw HTML blocks (`\u003cp\u003e`, `\u003cpre\u003e` tags). This is a **KNOWN GAP** already documented in status file section for askbot-master-8zl.\n\nGap severity: LOW - relies on markdown-it core behavior, not custom code.\n\n### Documentation: COMPLETE ✅\n\nTask file comprehensive (500 lines): rollback procedure, frontend JS example, behavioral changes, performance analysis all present.\n\n### Task File Status Update Needed\n\nCurrent: 'Testing Pending'\nShould be: 'Implementation Complete, Testing Complete (minor gap in raw HTML block coverage)'\n\n### Connection to Other Audits\n\nThis audit confirms findings from:\n- askbot-master-6ts (commit audit for ea2f58fa4)\n- askbot-master-8zl (commit audit for 339de84e0 - identified the coverage gap)","created_at":"2026-01-10T21:12:08Z"},{"id":18,"issue_id":"askbot-master-4gc","author":"devop","text":"## FINAL Comprehensive Audit Findings\n\n### A. Implementation: ✅ COMPLETE\nAll 8 checklist items verified:\n- `truncate_links.py`: 135 lines, properly structured\n- `markup.py` line 105: `{'linkify': True}`\n- `markup.py` line 132: `md.use(truncate_links_plugin, {'trim_limit': 40})`\n- `urlize_html` import and usage removed\n\n### B. Testing: ⚠️ MOSTLY COMPLETE (3 gaps identified)\n\n**Tests passing:** 31/31\n- 16/16 unit tests (`test_markdown_truncate_links_plugin.py`)\n- 12/12 integration tests (`test_markdown_integration.py`)\n- 3/3 markup tests (`test_markup.py`)\n\n**Coverage Gaps:**\n\n| Gap | Description | Severity | Source |\n|-----|-------------|----------|--------|\n| Raw HTML blocks | URLs in `\u003cp\u003e`, `\u003cpre\u003e` tags not tested | Low | test_convert_mixed_text removed in 339de84e0 |\n| Email auto-linking | `user@example.com` → `mailto:` not tested | Medium | linkify-it-py default, no explicit test |\n| Full pipeline | Integration tests use `md.render()` not `markdown_input_converter()` | Low | sanitization not tested in linkify context |\n\n**Note:** The `test_linkify_with_truncation` integration test IS comprehensive for converter-level testing (fuzzy links, truncation, code protection, markdown links). The gaps are at the edges.\n\n### C. Documentation: ✅ COMPLETE\n- Task file comprehensive (500 lines)\n- Rollback procedure: documented (lines 408-428)\n- Frontend JS example: provided (lines 199-248) - NOT verified to work\n- Performance claim: '2-3x faster' - NOT benchmarked\n\n### D. Behavioral Changes (Breaking)\n\n| Change | Old Behavior | New Behavior | Tested |\n|--------|--------------|--------------|--------|\n| Fuzzy links | `example.com` NOT linked | `example.com` → `http://example.com` | ✅ Yes |\n| Email links | Emails NOT linked | `user@example.com` → `mailto:` | ❌ No |\n\n### E. Task File Status Discrepancy\n- **Current header:** '✅ Implementation Complete (Testing Pending)'\n- **Reality:** Implementation complete, testing 90% complete with known gaps\n- **Testing checklist:** 12 items shown unchecked but 10+ are implemented\n\n### F. Connections to Status File\n\nRelates to Open Questions:\n- **Q2 (sanitization):** Still relevant - integration tests don't test sanitize_html() in linkify context\n- **Q3 (raw HTML blocks):** Confirmed gap - no explicit test exists\n\nConfirms findings from:\n- **askbot-master-8zl:** Coverage gaps identified (raw HTML blocks, test type shift)\n- **askbot-master-6ts:** Implementation details accurate\n\n### G. Recommendations\n\n1. **Low priority:** Add email auto-linking test\n2. **Low priority:** Add full pipeline test using `markdown_input_converter()`\n3. **Documentation:** Update task file header from 'Testing Pending' to reflect actual state\n4. **Consider:** Whether email auto-linking is desired behavior","created_at":"2026-01-10T21:14:27Z"},{"id":19,"issue_id":"askbot-master-4gc","author":"devop","text":"## ULTRA-DEEP AUDIT - Additional Critical Findings\n\n### 1. STALE COMMENT in test_markup.py:76-80\n```\nKnown to fail against:\n    http://example.com/quotes-are-\"part\"\n    ✪df.ws/1234\n    example.com    ← THIS NOW WORKS\\!\n    example.com/\n```\nThe comment says `example.com` fails, but `test_fuzzy_link_detection` proves it NOW WORKS.\n**Action needed:** Update or remove stale comment.\n\n### 2. Task File Documentation SIGNIFICANTLY OUTDATED\n\n| Item | Task File Says | Reality |\n|------|----------------|---------|\n| truncate_links.py lines | 119 | 134 (15 line difference) |\n| Plugin location | lines 127-131 | lines 132-134 |\n| Success Criteria | 4 items ⏳ | All 7 are ✅ |\n| Next Steps | 6 TODOs | All 6 are DONE |\n| Header status | 'Testing Pending' | Testing ~90% complete |\n\n### 3. Security: NOT TESTED\n- No test for `javascript:` URL rejection by linkify\n- linkify-it-py should reject by default (only allows http, https, ftp, mailto)\n- But this is NOT explicitly verified in tests\n\n### 4. urlize Correctly Handled\n- Task file says 'remove urlize_html import'\n- Reality: `urlize_html` from askbot.utils.html WAS removed ✅\n- Django's `urlize` still imported but used only in `plain_text_input_converter()` (correct)\n- markdown_input_converter() correctly uses sanitize_html() instead\n\n### 5. Behavioral Changes Impact on Existing Content\n| Change | Effect on Existing Posts |\n|--------|-------------------------|\n| Fuzzy links | Posts with `example.com` text now render as links |\n| Email links | Posts with `user@example.com` now render as mailto links |\n\n**This could cause unexpected rendering changes for existing content.**\n\n### 6. Complete Test Coverage Gaps (4 total)\n1. Raw HTML blocks (`\u003cp\u003e`, `\u003cpre\u003e` URLs not linkified) - removed test\n2. Email auto-linking (`mailto:` behavior) - no test  \n3. Full pipeline with `markdown_input_converter()` - integration tests use `md.render()`\n4. Security: `javascript:` URL rejection - no test\n\n### Summary Assessment\n\n| Category | Status | Notes |\n|----------|--------|-------|\n| Implementation | ✅ Complete | All features working |\n| Tests | ⚠️ 90% | 31/31 pass, 4 gap areas |\n| Task File Docs | ❌ Stale | Significant updates needed |\n| Code Comments | ❌ Stale | test_markup.py:76-80 |\n| Security Tests | ❌ Missing | javascript: not tested |\n\n### Recommended Actions\n1. **High:** Remove/update stale comment in test_markup.py:76-80\n2. **Medium:** Update task file header, success criteria, next steps\n3. **Low:** Add email auto-linking test\n4. **Low:** Add javascript: URL rejection test\n5. **Low:** Consider if fuzzy/email linking should be configurable","created_at":"2026-01-10T21:17:28Z"}]}
{"id":"askbot-master-5i7","title":"Audit task file: markdown-upgrade-phase2-frontend.md","description":"Analyze tasks/markdown-upgrade-phase2-frontend.md - Frontend migration plan (Showdown → markdown-it.js). Extract all requirements.","notes":"## Audit Instructions\n\n**Before starting:**\n1. Read `tasks/markdown-upgrade-status.md` to understand the document structure and current state\n\n**When completing this audit:**\n1. **Add findings to this bd issue** using `bd comments add \u003cissue-id\u003e` with key observations\n2. **Edit ONLY your relevant section** in `tasks/markdown-upgrade-status.md` - do NOT overwrite the entire file\n3. **Reference this issue ID** (e.g., `askbot-master-xxx`) in the status file where you add findings\n4. **Update the Audit Trail table** at the bottom - change your row status from `pending` to `done`\n5. When complete, close this issue with `bd close \u003cissue-id\u003e`\n\n**Important:** Use the Edit tool to modify specific sections. Do not use Write to replace the whole file.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:16:35.130363-03:00","created_by":"devop","updated_at":"2026-01-10T19:14:43.786312-03:00","closed_at":"2026-01-10T19:14:43.786312-03:00","close_reason":"Closed","labels":["audit","task-file"],"dependencies":[{"issue_id":"askbot-master-5i7","depends_on_id":"askbot-master-8lq","type":"blocks","created_at":"2026-01-10T14:25:12.345622-03:00","created_by":"devop"}],"comments":[{"id":20,"issue_id":"askbot-master-5i7","author":"devop","text":"## Audit Findings: markdown-upgrade-phase2-frontend.md\n\n**Document Status:** NOT STARTED - VALID with CRITICAL GAPS\n\n### What's Valid:\n1. Task structure is comprehensive (7 tasks covering installation, rewrite, plugins, templates, testing, cleanup)\n2. API compatibility approach (`makeHtml()` preserved)\n3. Files to create/delete correctly identified\n4. Testing requirements reasonable (manual + Selenium/Playwright)\n5. Exit criteria well-defined (8 checkboxes)\n\n### CRITICAL Gaps:\n\n**1. MathJax Architecture Mismatch (Lines 230-307)**\n\n| Component | Approach |\n|-----------|----------|\n| Backend | 7-phase server-side preprocessing: protect_code_dollars -\u003e extract_math -\u003e escape_dollars -\u003e md.render -\u003e restore_code_dollars -\u003e restore_math -\u003e sanitize_html |\n| Document's Frontend | Simple inline/block math rules in markdown-it (lines 238-307) |\n\n**Impact:** Preview WILL NOT match saved content. Backend extracts math to `@@N@@` tokens BEFORE markdown processing; frontend lets markdown-it handle text then passes to MathJax AFTER.\n\nStatus file section 3.1 flags this mismatch with three options:\n1. Port math_extract.py to JavaScript (complex)\n2. Simplified frontend handling (preview/save differences)\n3. Backend preview API (performance cost)\n\n**Document does NOT address any option.**\n\n**2. Missing truncate_links Plugin (NOT MENTIONED)**\n- Backend has `truncate_links.py` (134 lines) - truncates auto-linked URLs to 40 chars\n- Document lists video.js and link-patterns.js but NOT truncate-links.js\n- **Result:** Frontend shows full URLs, backend shows truncated\n\n**3. Escaped Dollar Handling Missing**\n- Backend `escape_dollars()` converts `\\$` -\u003e `\u0026dollar;` HTML entity (instant render)\n- Document relies on MathJax client-side `processEscapes`\n- **Result:** FOUC - `\\$100` shows backslash until MathJax loads\n\n**4. Code-friendly Mode Bug Propagated (Lines 211-215)**\n- Document: `this._md.disable('emphasis')` - disables BOTH `*` and `_`\n- Backend has same bug (askbot-master-6nm)\n- TODO comment \"Re-enable just asterisk if needed\" - not addressed\n\n### MEDIUM Issues:\n\n**5. Preset Mismatch (Lines 153-154)**\n- Document comment says 'gfm-like' but actual backend uses 'commonmark'\n- Code correctly enables table/strikethrough manually (line 165)\n\n**6. Element ID Inconsistency**\n- Current askbot_converter.js uses `'previewer'` (actual line 23)\n- Document code uses `'wmd-preview'` (lines 377, 380)\n\n**7. Template Inaccuracy (Lines 818-821)**\n- Document says template has `showdown-min.js`\n- Actual template has `Markdown.Converter.js` (Showdown bundled differently)\n\n### Files Verified:\n- askbot/media/wmd/askbot_converter.js - 67 lines (current API surface confirmed)\n- askbot/jinja2/meta/markdown_javascript.html - 9 lines\n- askbot/media/wmd/showdown-min.js - exists\n- askbot/media/wmd/Markdown.Converter.js - exists\n\n### Requirements Extracted:\n\n**Functional (10):**\n| ID | Requirement | Lines |\n|---|---|---|\n| FR-1 | Replace Showdown with markdown-it.js | 10 |\n| FR-2 | Maintain makeHtml() API | 343-357 |\n| FR-3 | GFM tables/strikethrough | 165 |\n| FR-4 | Video embedding @[service](id) | 417-566 |\n| FR-5 | Custom link patterns | 570-794 |\n| FR-6 | MathJax delimiter protection | 230-307 |\n| FR-7 | Syntax highlighting (hljs) | 313-334 |\n| FR-8 | Code-friendly mode | 206-224 |\n| FR-9 | Footnotes | 182-184 |\n| FR-10 | Task lists | 185-189 |\n\n**Non-Functional (4):**\n| ID | Requirement | Lines |\n|---|---|---|\n| NFR-1 | \u003c100ms render time | 1018 |\n| NFR-2 | Browser compatibility (Chrome, Firefox, Safari) | 1011-1014 |\n| NFR-3 | No JS console errors | 1017 |\n| NFR-4 | Preview matches backend exactly | 1014 |\n\n### Missing Requirements (not in document):\n- **MR-1:** truncate_links.js plugin\n- **MR-2:** escape_dollars.js or equivalent\n- **MR-3:** Code span dollar protection\n\n### Security Concerns (Lines 858-862):\n- CDN links for highlight.js lack SRI integrity hashes\n- Example: `https://cdn.jsdelivr.net/npm/highlight.js@11/...` - no hash\n\n### Connections:\n- askbot-master-6nm: Code-friendly emphasis bug (replicated here)\n- askbot-master-0pk: Assessment also doesn't address MathJax mismatch\n- askbot-master-35c: Backend MathJax v2 impl (source for JS port)\n- askbot-master-4gc: Linkify/truncate audit (frontend missing truncate)\n\n### Recommended Actions:\n\n1. **CRITICAL:** Add task for MathJax parity - choose one of:\n   - Task 2.x: \"Port math_extract.py to JavaScript\"\n   - Task 2.x: \"Implement backend preview API endpoint\"\n\n2. **CRITICAL:** Add Task 2.x: \"Write truncate_links.js plugin\"\n\n3. **HIGH:** Fix preset comment from 'gfm-like' to 'commonmark'\n\n4. **MEDIUM:** Add escape_dollars.js or document FOUC as acceptable\n\n5. **LOW:** Update template code examples to match actual paths\n\n6. **SECURITY:** Add SRI hashes to CDN links\n","created_at":"2026-01-10T22:07:53Z"},{"id":21,"issue_id":"askbot-master-5i7","author":"devop","text":"## REVISED Audit Findings: markdown-upgrade-phase2-frontend.md\n\n**Document Status:** NOT STARTED - VALID with CRITICAL GAPS\n\n### Summary of Issues Found\n\n| Severity | Count | Key Issues |\n|----------|-------|------------|\n| CRITICAL | 4 | Sanitization missing, MathJax mismatch, truncate_links missing, rollback contradiction |\n| HIGH | 2 | Syntax highlighting mismatch, escape_dollars missing |\n| MEDIUM | 4 | Preset comment, element ID, settings naming, error handling |\n| LOW | 2 | Template reference, CDN SRI hashes |\n\n---\n\n### CRITICAL Issues\n\n**1. SECURITY: Sanitization Missing from New Code**\n\n| Current (askbot_converter.js:14) | Document's Proposal (lines 343-357) |\n|----------------------------------|-------------------------------------|\n| `new Markdown.getSanitizingConverter()` | `this._md.render(text)` - NO sanitization! |\n\nDocument says keep `Markdown.Sanitizer.js` (line 32) but the new `makeHtml()` doesn't call any sanitizer!\n\nBackend calls `sanitize_html()` at end of pipeline (markup.py:347).\n\n**Impact:** XSS vulnerability if document's code is implemented as-is.\n\n**Fix Required:** Add sanitization step to `makeHtml()` or use a markdown-it sanitization plugin.\n\n**2. MathJax Architecture Mismatch (Lines 230-307)**\n\nBackend (markup.py:299-349) uses 7-phase preprocessing:\n```\n1. protect_code_dollars()   → Replace $ with ~D in code spans\n2. extract_math()           → Extract math to @@N@@ tokens\n3. escape_dollars()         → Convert \\$ → \u0026dollar;\n4. md.render()              → Markdown processing\n5. restore_code_dollars()   → ~D → $ in output\n6. restore_math()           → @@N@@ → original math\n7. sanitize_html()          → XSS protection\n```\n\nDocument's frontend (lines 238-307): Simple inline/block math rules in markdown-it that pass content through to MathJax client-side.\n\n**Impact:** Preview will NOT match saved content. Backend extracts math BEFORE markdown; frontend lets markdown process text then MathJax runs AFTER.\n\n**3. Missing truncate_links.js Plugin**\n\nBackend has `truncate_links.py` (134 lines) - truncates auto-linkified URLs to 40 chars with title attribute for accessibility.\n\nDocument lists video.js and link-patterns.js but NOT truncate-links.js.\n\n**Impact:** Frontend shows full URLs, backend shows truncated.\n\n**4. Rollback Strategy Contradiction**\n\n| Document | Says |\n|----------|------|\n| Overview (line 141) | \"Showdown files kept as fallback during transition\" |\n| Phase 2 (Task 2.7, lines 969-990) | DELETE Showdown files: `git rm showdown-min.js` |\n| Phase 3 (line 1000) | Rollback requires Showdown |\n\n**Impact:** If Phase 2 deletes Showdown and Phase 3 rollback is needed, NO frontend fallback exists.\n\n**Fix Required:** Either:\n1. Keep Showdown files during Phase 2, delete in Phase 3 after validation\n2. Add frontend feature flag mechanism before deleting\n\n---\n\n### HIGH Issues\n\n**5. Syntax Highlighting Output Mismatch**\n\n| Backend (Pygments) | Frontend (highlight.js) |\n|--------------------|-------------------------|\n| `\u003cdiv class=\"highlight\"\u003e...\u003c/div\u003e` | `\u003cpre\u003e\u003ccode class=\"hljs\"\u003e...\u003c/code\u003e\u003c/pre\u003e` |\n| CSS classes: `.highlight .k`, `.highlight .n`, etc. | CSS classes: `.hljs-keyword`, `.hljs-name`, etc. |\n\n**Impact:** Preview styling won't match saved content.\n\n**6. Escaped Dollar Handling Missing**\n\nBackend `escape_dollars()` converts `\\$` → `\u0026dollar;` HTML entity (instant render).\n\nDocument relies on MathJax client-side `processEscapes: true`.\n\n**Impact:** FOUC - `\\$100` shows backslash until MathJax loads.\n\n---\n\n### MEDIUM Issues\n\n**7. Preset Comment Mismatch (Line 154)**\n- Document comment: \"Matches Python: MarkdownIt('gfm-like')\"\n- Actual backend (markup.py:105): `MarkdownIt('commonmark', ...)`\n\n**8. Element ID Inconsistency**\n- Current askbot_converter.js line 23: `'previewer'`\n- Document code lines 377, 380: `'wmd-preview'`\n- Current code line 57: `'.wmd-preview'` (CSS selector!)\n\n**9. Settings Property Naming**\n- Current: `askbot['settings']['mathjaxEnabled']`\n- Document: `window.askbot.settings.mathjaxEnabled`\n- Different access patterns may cause issues\n\n**10. Error Handling Behavior Change**\n- Current: Silently falls back if MathJax not loaded\n- Document (lines 149-151): Throws error if markdown-it not loaded\n\n---\n\n### LOW Issues\n\n**11. Template File Reference (Lines 818-821)**\n- Document claims template has `showdown-min.js`\n- Actual template has `Markdown.Converter.js`\n\n**12. CDN Links Need SRI (Lines 858-862)**\n- highlight.js CDN links lack integrity hashes\n\n---\n\n### Files Verified\n\n| File | Lines | Status |\n|------|-------|--------|\n| askbot/media/wmd/askbot_converter.js | 67 | Current Showdown wrapper |\n| askbot/jinja2/meta/markdown_javascript.html | 9 | Loads Markdown.Converter.js |\n| askbot/media/wmd/Markdown.Sanitizer.js | exists | Used by current, NOT by proposal |\n| askbot/utils/markup.py | 452 | Backend pipeline with sanitize_html() |\n| askbot/utils/markdown_plugins/truncate_links.py | 134 | Missing from document |\n\n---\n\n### Requirements Extracted\n\n**Functional (10):**\nFR-1 through FR-10 (markdown-it, video, link patterns, MathJax, footnotes, task lists, highlighting, code-friendly, API compat)\n\n**Non-Functional (4):**\nNFR-1: \u003c100ms render | NFR-2: Browser compat | NFR-3: No errors | NFR-4: Preview=backend\n\n**Missing (5):**\n- MR-1: truncate_links.js\n- MR-2: escape_dollars.js\n- MR-3: Code span dollar protection\n- MR-4: HTML sanitization\n- MR-5: Frontend rollback mechanism\n\n---\n\n### Recommended Actions (Priority Order)\n\n1. **CRITICAL/SECURITY:** Add sanitization to makeHtml() - either call Markdown.Sanitizer or add DOMPurify\n\n2. **CRITICAL:** Add task \"Port MathJax preprocessing to JavaScript\" OR \"Implement backend preview API\"\n\n3. **CRITICAL:** Add task \"Write truncate_links.js plugin\"\n\n4. **CRITICAL:** Resolve rollback contradiction - keep Showdown until Phase 3 validated\n\n5. **HIGH:** Document that highlight.js output differs from Pygments OR implement compatible highlighter\n\n6. **HIGH:** Add escape_dollars.js or document FOUC as acceptable\n\n7. **MEDIUM:** Fix preset comment, element IDs, settings access patterns\n\n8. **SECURITY:** Add SRI hashes to CDN links\n\n---\n\n### Connections to Other Issues\n\n| Issue ID | Relevance |\n|----------|-----------|\n| askbot-master-6nm | Code-friendly emphasis bug (same bug propagated) |\n| askbot-master-0pk | Assessment also missing MathJax parity solution |\n| askbot-master-35c | Backend MathJax v2 impl (source for JS port) |\n| askbot-master-4gc | Linkify/truncate audit (missing truncate) |\n| askbot-master-uga | Rollback strategy contradiction |\n","created_at":"2026-01-10T22:13:16Z"}]}
{"id":"askbot-master-6n7","title":"Add integration test: verify math content protected from linkify","description":"## Context\nThe MathJax v2 preprocessing implementation extracts math content to `@@N@@` tokens BEFORE markdown processing, then restores them after. This should protect math content from being processed by linkify.\n\n## Task\nAdd an integration test to `askbot/tests/test_markdown_mathjax.py` that verifies URLs inside math delimiters are NOT converted to links.\n\n## Test Requirements\n- Must use `markdown_input_converter()` (full pipeline), not `md.render()`\n- Must have `ENABLE_MATHJAX=True` setting active\n\n## Test Cases\n```python\ndef test_url_inside_math_not_linkified(self):\n    \"\"\"URLs inside math delimiters should not become links\"\"\"\n    # Inline math with URL\n    text = \"See $http://example.com$ for formula\"\n    html = markdown_input_converter(text)\n    # Should contain the URL as plain text inside math, NOT as \u003ca\u003e tag\n    assert '\u003ca href=\"http://example.com\"\u003e' not in html\n    assert '$http://example.com$' in html or 'http://example.com' in html\n\ndef test_www_inside_math_not_linkified(self):\n    \"\"\"www URLs inside math should not become links\"\"\"\n    text = \"Check $www.example.com$ here\"\n    html = markdown_input_converter(text)\n    assert '\u003ca ' not in html or 'www.example.com' not in html.split('\u003ca')[1].split('\u003c/a\u003e')[0]\n```\n\n## Acceptance Criteria\n- [ ] Test passes with current implementation (verifies protection works)\n- [ ] Test uses `markdown_input_converter()` for full pipeline coverage\n- [ ] Test is added to `test_markdown_mathjax.py`\n\n## Related\n- Source: tasks/markdown-upgrade-status.md section 7\n- Pipeline: askbot/utils/markup.py `markdown_input_converter()`","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T21:38:27.464539-03:00","created_by":"devop","updated_at":"2026-01-11T13:42:08.823669-03:00","closed_at":"2026-01-11T13:42:08.823669-03:00","close_reason":"Closed","dependencies":[{"issue_id":"askbot-master-6n7","depends_on_id":"askbot-master-q54","type":"blocks","created_at":"2026-01-10T22:01:24.878471-03:00","created_by":"devop"}]}
{"id":"askbot-master-6nm","title":"Audit commit 4: Completed backend migration markdown2 → markdown_it","description":"Analyze commit 4c3ad65bd - WIP review: completed backend migration markdown2 -\u003e markdown_it. Key milestone commit.","notes":"## Audit Instructions\n\n**Before starting:**\n1. Read `tasks/markdown-upgrade-status.md` to understand the document structure and current state\n\n**When completing this audit:**\n1. **Add findings to this bd issue** using `bd comments add \u003cissue-id\u003e` with key observations\n2. **Edit ONLY your relevant section** in `tasks/markdown-upgrade-status.md` - do NOT overwrite the entire file\n3. **Reference this issue ID** (e.g., `askbot-master-xxx`) in the status file where you add findings\n4. **Update the Audit Trail table** at the bottom - change your row status from `pending` to `done`\n5. When complete, close this issue with `bd close \u003cissue-id\u003e`\n\n**Important:** Use the Edit tool to modify specific sections. Do not use Write to replace the whole file.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:15:33.59663-03:00","created_by":"devop","updated_at":"2026-01-10T15:36:30.182282-03:00","closed_at":"2026-01-10T15:36:30.182282-03:00","close_reason":"Closed","labels":["audit","commit"],"dependencies":[{"issue_id":"askbot-master-6nm","depends_on_id":"askbot-master-u9s","type":"blocks","created_at":"2026-01-10T14:15:33.597599-03:00","created_by":"devop"},{"issue_id":"askbot-master-6nm","depends_on_id":"askbot-master-jrw","type":"blocks","created_at":"2026-01-10T14:22:30.98723-03:00","created_by":"devop"}],"comments":[{"id":22,"issue_id":"askbot-master-6nm","author":"devop","text":"## Key Findings: Commit 4c3ad65bd\n\n**Summary:** Key milestone commit completing backend migration markdown2 → markdown-it-py\n\n### Dependency Changes\n- Removed markdown2 dependency\n- Upgraded markdown-it-py: 2.2.0 → 4.0.0\n- Upgraded mdit-py-plugins: 0.3.5 → 0.5.0\n- Added pygments\u003e=2.15.0 for syntax highlighting\n\n### New Custom Plugins\n1. **video_embed.py** - Video embedding (@[youtube](id), @[vimeo](id), @[dailymotion](id))\n2. **link_patterns.py** - Custom auto-linking (#bug123 → link)\n\n### Core markup.py Changes\n- Implemented singleton pattern (get_md_converter() + reset_md_converter())\n- Added Pygments syntax highlighting (highlight_code())\n- Integrated: footnotes, tasklists, video embed, link patterns plugins\n- Code-friendly mode (disables underscore emphasis when MARKUP_CODE_FRIENDLY or ENABLE_MATHJAX)\n- **TODO left:** Math delimiter protection plugin for MathJax\n\n### Test Coverage Added\n- test_markdown_integration.py (149 lines) - integration tests\n- test_markdown_link_patterns_plugin.py (105 lines) - link patterns unit tests  \n- test_markdown_video_plugin.py (55 lines) - video plugin unit tests\n\n### Documentation Updates\n- Updated phase1-backend.md: env-md virtual environment instructions\n- Updated phase3-testing.md: askbot_site directory info\n- Added markdown-upgrade-todos.txt with remaining tasks\n\n### Remaining Work (from todos.txt)\n- Disallow headings toggle\n- Footnotes toggle\n- Tasklist toggle\n- Real-life UX testing\n- Math delimiter protection (addressed in later commits)","created_at":"2026-01-10T18:27:37Z"},{"id":23,"issue_id":"askbot-master-6nm","author":"devop","text":"## Additional Findings (Double-Check)\n\n### 1. Feature Restoration Context\nCommit 4 **RESTORES** features that were lost in commit 1:\n- Video embedding: ✓ Restored (new video_embed.py plugin)\n- Link patterns: ✓ Restored (new link_patterns.py plugin)  \n- Code-friendly mode: ✓ Restored (via emphasis disable)\n\nThis completes the migration started in commit 1.\n\n### 2. Potential UX Regression: Code-Friendly Mode\n**Issue:** When `MARKUP_CODE_FRIENDLY=True` OR `ENABLE_MATHJAX=True`, the code runs:\n```python\nmd.disable('emphasis')\n# TODO: Add custom rule to re-enable * only if needed\n```\nThis disables ALL emphasis - both `_underscores_` AND `*asterisks*`.\n\n**Impact:** Users lose ability to use `*italic*` and `**bold**` when MathJax or code-friendly mode is enabled.\n\n**TODO exists** but not implemented.\n\n### 3. Test Gap\nNo test verifies that asterisk emphasis (`*italic*`, `**bold**`) still works when code-friendly mode is enabled. Current test only checks underscore behavior.\n\n### 4. Minor Items\n- **the_diff file**: 923-line developer working file (notes + diff copies). Not functional.\n- **Linkify**: gfm-like preset handles URL linkification, replacing removed urlize_html.\n- **Singleton**: Settings captured at first use; reset_md_converter() needed for changes (properly handled in tests).","created_at":"2026-01-10T18:31:19Z"}]}
{"id":"askbot-master-6ts","title":"Audit commit 6: Enabled linkify and link truncation","description":"Analyze commit ea2f58fa4 - Enabled linkify and implemented link truncation plugin. Feature complete.","notes":"## Audit Instructions\n\n**Before starting:**\n1. Read `tasks/markdown-upgrade-status.md` to understand the document structure and current state\n\n**When completing this audit:**\n1. **Add findings to this bd issue** using `bd comments add \u003cissue-id\u003e` with key observations\n2. **Edit ONLY your relevant section** in `tasks/markdown-upgrade-status.md` - do NOT overwrite the entire file\n3. **Reference this issue ID** (e.g., `askbot-master-xxx`) in the status file where you add findings\n4. **Update the Audit Trail table** at the bottom - change your row status from `pending` to `done`\n5. When complete, close this issue with `bd close \u003cissue-id\u003e`\n\n**Important:** Use the Edit tool to modify specific sections. Do not use Write to replace the whole file.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:15:37.371878-03:00","created_by":"devop","updated_at":"2026-01-10T15:54:41.766276-03:00","closed_at":"2026-01-10T15:54:41.766276-03:00","close_reason":"Closed","labels":["audit","commit"],"dependencies":[{"issue_id":"askbot-master-6ts","depends_on_id":"askbot-master-u9s","type":"blocks","created_at":"2026-01-10T14:15:37.372724-03:00","created_by":"devop"},{"issue_id":"askbot-master-6ts","depends_on_id":"askbot-master-n1c","type":"blocks","created_at":"2026-01-10T14:22:31.13876-03:00","created_by":"devop"}],"comments":[{"id":24,"issue_id":"askbot-master-6ts","author":"devop","text":"## Audit Summary: Commit ea2f58fa4\n\n**Purpose:** Re-enabled markdown-it's native linkify plugin and implemented custom URL truncation to replace the urlize_html post-processing from commit 5.\n\n### Key Changes\n\n1. **Re-enabled linkify** - Changed `{'linkify': False}` to `{'linkify': True}` and explicitly enabled the linkify rule\n2. **New truncate_links.py plugin** (134 lines) - Custom markdown-it-py plugin that:\n   - Truncates auto-linkified URLs to 40 chars (matching Django's urlize trim_url_limit)\n   - Adds `title` attribute with full URL for accessibility/hover\n   - Only processes linkify-created links (markup='linkify'), preserving markdown links\n   - Uses Django's truncation algorithm: `f\"{text[:max(0, limit - 1)]}…\"`\n\n3. **Removed urlize_html dependency** - No longer needed since linkify handles URL detection\n4. **Added explicit sanitize_html()** - Previously handled by urlize_html\n\n### Files Added/Modified\n- **askbot/utils/markdown_plugins/truncate_links.py** (NEW, 134 lines)\n- **askbot/tests/test_markdown_truncate_links_plugin.py** (NEW, 260 lines)\n- **askbot/tests/test_markdown_integration.py** (+43 lines)\n- **askbot/tests/test_markup.py** (+34 lines, -22 lines)\n- **askbot/utils/markup.py** (+24 lines, -6 lines)\n- **tasks/markdown-upgrade-linkify.md** (NEW, 500 lines)\n\n### Relationship to Commit 5\nCommit 5 (1a736db26) had REVERTED linkify and restored urlize_html as a post-processing step. Commit 6 reverses that decision with a proper markdown-it-native solution using the truncate_links plugin.\n\n### Test Coverage\nComprehensive tests covering:\n- Inline/fenced code block protection (URLs not linkified)\n- Plain URL linkification (with/without protocol)\n- Fuzzy detection (example.com, www.example.com)\n- Truncation at 40 chars with ellipsis\n- Title attribute for accessibility\n- Markdown link preservation","created_at":"2026-01-10T18:50:29Z"}]}
{"id":"askbot-master-6yy","title":"Add test: data: URLs rejected in links (security)","description":"## Context\nSimilar to `javascript:` URLs, `data:` URLs can be used for XSS attacks when placed in href attributes. Need to verify these are rejected both in:\n1. Auto-linkified URLs (linkify plugin)\n2. User-written markdown links `[text](data:...)`\n\n## Pre-check\nBefore implementing, search for existing tests:\n- `grep -r \"data:\" askbot/tests/test_markdown*.py`\n- `grep -r \"data:\" askbot/tests/test_markup.py`\n\n## Task\nAdd security tests to verify `data:` URLs are not allowed in links.\n\n## Test Cases\n```python\ndef test_data_url_not_autolinked(self):\n    \"\"\"data: URLs should NOT be auto-linked\"\"\"\n    text = \"See data:text/html,\u003cscript\u003ealert(1)\u003c/script\u003e here\"\n    html = markdown_input_converter(text)\n    assert 'href=\"data:' not in html\n\ndef test_data_url_in_markdown_link_sanitized(self):\n    \"\"\"Markdown links with data: URLs should be sanitized\"\"\"\n    text = \"[click](data:text/html,\u003cscript\u003ealert(1)\u003c/script\u003e)\"\n    html = markdown_input_converter(text)\n    # Link should either be removed or href sanitized\n    assert 'href=\"data:' not in html\n```\n\n## Acceptance Criteria\n- [ ] Searched for existing tests first\n- [ ] Test uses `markdown_input_converter()` (full pipeline)\n- [ ] Test covers auto-linking rejection\n- [ ] Test covers user-written markdown link sanitization\n- [ ] Tests pass with current implementation\n\n## Security Note\nIf tests fail, there is an XSS vulnerability that must be fixed.\n\n## Related\n- Similar to: askbot-master-tkt (javascript: URL rejection)\n- Source: tasks/markdown-upgrade-status.md section 1.2\n- sanitize_html: askbot/utils/html.py","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T21:49:40.390513-03:00","created_by":"devop","updated_at":"2026-01-11T14:40:22.097936-03:00","closed_at":"2026-01-11T14:40:22.097936-03:00","close_reason":"Closed","dependencies":[{"issue_id":"askbot-master-6yy","depends_on_id":"askbot-master-q54","type":"blocks","created_at":"2026-01-10T21:58:53.464276-03:00","created_by":"devop"}]}
{"id":"askbot-master-6za","title":"Add integration test: code blocks with script tags are escaped","description":"## Context\nThe `highlight_code()` function in `askbot/utils/markup.py` has fallback paths that don't HTML-escape output. Need to verify whether the full pipeline (`markdown_input_converter()` → `sanitize_html()`) properly escapes malicious content in code blocks.\n\n## Task\nAdd integration test that verifies code blocks containing `\u003cscript\u003e` tags are properly escaped in the final HTML output.\n\n## Pre-check\nBefore implementing, search for existing tests:\n- `grep -r \"script\" askbot/tests/test_markdown*.py`\n- `grep -r \"escape\" askbot/tests/test_markdown*.py`\n\n## Test Cases\n```python\ndef test_script_in_code_block_escaped(self):\n    \"\"\"Script tags in code blocks should be escaped\"\"\"\n    text = '''```html\n\u003cscript\u003ealert('xss')\u003c/script\u003e\n```'''\n    html = markdown_input_converter(text)\n    assert '\u003cscript\u003e' not in html\n    assert '\u0026lt;script\u0026gt;' in html or 'alert' not in html\n\ndef test_script_in_inline_code_escaped(self):\n    \"\"\"Script tags in inline code should be escaped\"\"\"\n    text = \"Use `\u003cscript\u003ealert('xss')\u003c/script\u003e` carefully\"\n    html = markdown_input_converter(text)\n    assert '\u003cscript\u003e' not in html\n```\n\n## Outcome\n- If test **passes**: `sanitize_html()` handles this, no fix needed\n- If test **fails**: Create follow-up issue to fix `highlight_code()` escaping\n\n## Files\n- Test location: `askbot/tests/test_markdown_integration.py`\n- Code under test: `askbot/utils/markup.py` lines 50-76\n\n## Acceptance Criteria\n- [ ] Searched for existing tests first\n- [ ] Test uses `markdown_input_converter()` (full pipeline)\n- [ ] Test verifies script tags are escaped or removed\n- [ ] Document outcome (pass/fail) for follow-up decision\n\n## Related\n- Source: tasks/markdown-upgrade-status.md line 694\n- highlight_code: markup.py lines 38-76\n- sanitize_html: askbot/utils/html.py","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T21:47:46.052707-03:00","created_by":"devop","updated_at":"2026-01-11T14:16:10.3996-03:00","closed_at":"2026-01-11T14:16:10.3996-03:00","close_reason":"Closed","dependencies":[{"issue_id":"askbot-master-6za","depends_on_id":"askbot-master-q54","type":"blocks","created_at":"2026-01-10T22:00:58.184094-03:00","created_by":"devop"}],"comments":[{"id":60,"issue_id":"askbot-master-6za","author":"Evgeny Fadeev","text":"## Test Results\n\n**Both tests PASS** - script tags are properly escaped by the pipeline.\n\n### Findings:\n\n1. **Code blocks with script tags**: The Pygments syntax highlighter HTML-escapes the code content, converting `\u003c` to `\u0026lt;` and `\u003e` to `\u0026gt;`. The `sanitize_html()` function then allows these escaped entities through safely.\n\n2. **Inline code with script tags**: Similarly escaped via the standard markdown code span rendering.\n\n### Outcome:\n- **No fix needed** for `highlight_code()` - the current pipeline properly handles script tags through the combination of:\n  1. Pygments HTML escaping in the highlighting path\n  2. Markdown-it's default escaping in the fallback path\n  3. `sanitize_html()` as the final safety net\n\n### Tests Added:\n- `test_script_in_code_block_escaped` - verifies fenced code blocks\n- `test_script_in_inline_code_escaped` - verifies inline code\n\nAll 18 integration tests pass.","created_at":"2026-01-11T17:15:43Z"}]}
{"id":"askbot-master-6zh","title":"Audit commit 2: Added CLAUDE.md and task planning","description":"Analyze commit d487c1e7a - added CLAUDE.md, planned tasks for the markdown upgrade.","notes":"## Audit Instructions\n\n**Before starting:**\n1. Read `tasks/markdown-upgrade-status.md` to understand the document structure and current state\n\n**When completing this audit:**\n1. **Add findings to this bd issue** using `bd comments add \u003cissue-id\u003e` with key observations\n2. **Edit ONLY your relevant section** in `tasks/markdown-upgrade-status.md` - do NOT overwrite the entire file\n3. **Reference this issue ID** (e.g., `askbot-master-xxx`) in the status file where you add findings\n4. **Update the Audit Trail table** at the bottom - change your row status from `pending` to `done`\n5. When complete, close this issue with `bd close \u003cissue-id\u003e`\n\n**Important:** Use the Edit tool to modify specific sections. Do not use Write to replace the whole file.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:15:29.000017-03:00","created_by":"devop","updated_at":"2026-01-10T15:22:12.269988-03:00","closed_at":"2026-01-10T15:22:12.269988-03:00","close_reason":"Closed","labels":["audit","commit"],"dependencies":[{"issue_id":"askbot-master-6zh","depends_on_id":"askbot-master-u9s","type":"blocks","created_at":"2026-01-10T14:15:29.000876-03:00","created_by":"devop"}],"comments":[{"id":25,"issue_id":"askbot-master-6zh","author":"devop","text":"## Audit Findings for Commit d487c1e7a\n\n### Summary\nPure documentation/planning commit - no code changes. Added CLAUDE.md and comprehensive markdown upgrade task planning documents.\n\n### Files Added (6 files, 4160 lines)\n\n| File | Lines | Purpose |\n|------|-------|---------|\n| `CLAUDE.md` | 202 | AI assistant guidance for the project |\n| `tasks/markdown-upgrade-overview.md` | 227 | Executive summary, 3-phase plan |\n| `tasks/markdown-upgrade-assessment.md` | 496 | Current state analysis, feature gap matrix |\n| `tasks/markdown-upgrade-phase1-backend.md` | 1121 | Detailed backend migration tasks |\n| `tasks/markdown-upgrade-phase2-frontend.md` | 971 | Frontend (Showdown → markdown-it.js) migration |\n| `tasks/markdown-upgrade-phase3-testing.md` | 1143 | Testing, deployment, rollback plan |\n\n### Key Planning Decisions Documented\n\n**3-Phase Migration Strategy:**\n- Phase 1: Backend (weeks 1-2) - upgrade markdown-it-py, write custom plugins\n- Phase 2: Frontend (weeks 3-4) - replace Showdown with markdown-it.js\n- Phase 3: Testing \u0026 Deployment (week 5) - migration scripts, visual regression\n\n**Identified Gaps (from assessment):**\n- markdown-it-py needs upgrade: 2.2.0 → 4.0.0\n- Video embedding plugin: **must be written** (no official port exists)\n- Custom link patterns plugin: **must be written**\n- Code-friendly mode: configuration change\n- Frontend mismatch: still using Showdown (~2011), not markdown-it.js\n\n**CLAUDE.md Contents:**\n- Project overview (Django Q\u0026A forum)\n- Development setup instructions\n- Testing commands (tox, direct Django)\n- Architecture overview\n- Management commands reference\n\n### Observations\n\n1. **Commit order note**: This commit (Oct 2025) was made AFTER commit 1 (Dec 2023), suggesting the planning docs were written retrospectively to document the existing WIP migration.\n\n2. **Plans acknowledge WIP state**: The assessment notes markdown-it-py 2.2.0 is installed (from commit 1) but needs upgrade to 4.0.0.\n\n3. **Frontend not touched yet**: Plans identify frontend (Showdown) as separate phase, explaining why commit 1 only did backend.\n","created_at":"2026-01-10T18:21:29Z"}]}
{"id":"askbot-master-7dy","title":"Make markdown conversion robust to stripping of whitespace","description":"## Context\n\nThe spaceless middleware (`askbot/middleware/spaceless.py`) strips whitespace between HTML tags to reduce bandwidth. This can break code blocks where newlines are significant.\n\n**Current state:** A modification on the `markdown-upgrade` branch adds `\u003cpre\u003e` block preservation, but this change is uncommitted and may be incomplete.\n\n## Research Findings\n\n### 1. Middleware Purpose \u0026 Relevance\n\nThe middleware was copied from a 2008-era blog post. Its purpose is to reduce HTML payload size by collapsing whitespace between tags (`\u003e\\s+\u003c` → `\u003e \u003c`).\n\n**Modern relevance:** Low. HTTP compression (gzip/brotli) makes this optimization largely redundant:\n- Gzip compresses whitespace extremely efficiently\n- Django deprecated the `spaceless` template filter in v4.0\n- The regex processing overhead likely exceeds any bandwidth savings\n\n**Evidence from codebase:** The settings file already has a FIXME comment questioning this:\n```python\n'askbot.middleware.spaceless.SpacelessMiddleware', # FIXME: why do we even have this?\n```\n\n### 2. Edge Cases Not Handled\n\nThe current modification only preserves `\u003cpre\u003e` blocks. Other whitespace-sensitive elements that could be corrupted:\n\n| Element | Risk | Found in codebase |\n|---------|------|-------------------|\n| `\u003ctextarea\u003e` | User input corruption | `askbot/jinja2/editors/simple.html` |\n| `\u003cscript\u003e` | Template literals, string literals | 63+ templates including `bottom_scripts.html` |\n| `\u003cstyle\u003e` | CSS content rules | Various templates |\n| Inline `\u003ccode\u003e` | Minor readability impact | Throughout markdown output |\n\n### 3. Options\n\n**Option A: Extend whitespace preservation**\n- Add patterns for `\u003ctextarea\u003e`, `\u003cscript\u003e`, `\u003cstyle\u003e`\n- Pros: Keeps any (minimal) bandwidth savings\n- Cons: Complex regex, more edge cases to discover, no tests\n\n**Option B: Remove the middleware entirely** (Recommended)\n- Comment out or remove from `MIDDLEWARE` in settings\n- Pros: Simpler, no edge cases, follows modern best practices\n- Cons: Slightly larger HTML payloads (mitigated by HTTP compression)\n\n### 4. Impact of Removal\n\n**Bandwidth impact:** Minimal. Modern HTTP compression is 99%+ effective at compressing whitespace. The uncompressed HTML will be slightly larger, but compressed transfer size will be nearly identical.\n\n**Performance impact:** Positive. Removes regex processing on every response.\n\n**Compatibility impact:** None. No client-side code depends on minified HTML.\n\n**Testing impact:** None. No tests exist for this middleware.\n\n## Recommendation\n\n**Remove the middleware** rather than trying to preserve more tags. The complexity of handling all edge cases correctly is not justified by the minimal (if any) bandwidth savings, especially since HTTP compression already handles this efficiently.\n\n## Files Affected\n\n- `askbot/middleware/spaceless.py` - The middleware implementation\n- `askbot_site/askbot_site/settings.py:134` - Production config\n- `testproject/testproject/settings.py:139` - Test config","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T12:21:03.113121-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-12T13:12:50.595309-03:00","closed_at":"2026-01-12T13:12:50.595309-03:00","close_reason":"Closed","comments":[{"id":75,"issue_id":"askbot-master-7dy","author":"Evgeny Fadeev","text":"**Additional context:** Markdown conversion happens both server-side (Python markdown-it-py) and client-side (JavaScript markdown-it.js). The spaceless middleware only affects server-rendered content. Client-side rendering is unaffected.\n\nThis means the issue is limited to:\n- Initial page load (server-rendered content)\n- Cached HTML responses\n- Email notifications (server-rendered)\n\nThe recommendation to remove the middleware still stands, as it simplifies the architecture and eliminates the server-side edge cases without affecting client-side rendering.","created_at":"2026-01-12T15:57:47Z"},{"id":76,"issue_id":"askbot-master-7dy","author":"Evgeny Fadeev","text":"## Analysis of Uncommitted Changes\n\n### Changes Related to Newline/Whitespace Preservation\n\n**1. `askbot/middleware/spaceless.py`** - The core fix\n- **Before:** Simple regex `\u003e\\s+\u003c` stripped ALL whitespace between tags\n- **After:** Preserves entire `\u003cpre\u003e...\u003c/pre\u003e` blocks intact\n- **Status:** Looks correct for code blocks. The pattern `(\u003cpre[^\u003e]*\u003e.*?\u003c/pre\u003e)` captures everything including internal spans and newlines.\n\n**2. `askbot/utils/markup.py`** - Pygments highlighting\n- Changed from generating `\u003cpre\u003e\u003ccode\u003e...\u003c/code\u003e\u003c/pre\u003e` wrappers to just returning inner spans\n- Now uses `nowrap=True` so markdown-it handles the wrapper\n- **Why this matters:** With the spaceless fix, newlines between `\u003cspan\u003e` tags inside `\u003cpre\u003e` are now preserved\n\n**3. `askbot/media/sass/components/_pygments-compat.scss`** - CSS backup\n- Added `white-space: pre` to ensure browser preserves whitespace visually\n- This is belt-and-suspenders with the spaceless fix\n\n**4. `askbot/jinja2/email/base_mail.html`** - Email styles\n- Added inline Pygments styles for email (which has no external CSS)\n- Email content is server-rendered, so it depends on spaceless middleware fix\n\n### Edge Cases to Consider\n\nThe current spaceless.py modification only handles `\u003cpre\u003e` blocks. Other whitespace-sensitive elements:\n\n1. **`\u003ctextarea\u003e`** - User input; whitespace corruption could cause issues\n2. **`\u003cscript\u003e`** - Template literals with `${}` could break\n3. **`\u003cstyle\u003e`** - CSS with content rules could break\n\n### Potential Actions\n\n**Option A:** Keep current `\u003cpre\u003e` fix, add patterns for other elements\n**Option B:** Remove spaceless middleware entirely (recommended in main issue body)\n**Option C:** Revert spaceless.py changes and remove middleware (cleanest)\n\nThe uncommitted `spaceless.py` change is a targeted fix, but removing the middleware entirely would be simpler and more robust.","created_at":"2026-01-12T16:00:51Z"},{"id":77,"issue_id":"askbot-master-7dy","author":"Evgeny Fadeev","text":"## Resolution\n\nRemoved the spaceless middleware entirely rather than trying to fix it.\n\n**Changes made:**\n- Removed `askbot.middleware.spaceless.SpacelessMiddleware` from:\n  - `askbot/startup_procedures.py` (required middleware check)\n  - `askbot/deployment/templates/settings_py.jinja2`\n  - `askbot/setup_templates/settings.py.jinja2`\n  - `testproject/testproject/settings.py`\n  - Local deployment settings (askbot_site)\n- Reverted uncommitted spaceless.py modifications\n\n**Result:** Code blocks now preserve newlines. Django check passes without middleware warning.","created_at":"2026-01-12T16:12:57Z"}]}
{"id":"askbot-master-7mm","title":"Commit .claude configuration files","description":"Commit the .claude/ directory configuration files.\n\nFiles to commit:\n- .claude/commands/land.md\n- .claude/docs/architecture.md\n- .claude/settings.json\n- CLAUDE.md (updates)\n\nThese are Claude Code configuration files that should be tracked in git.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T20:44:26.795699-03:00","created_by":"devop","updated_at":"2026-01-10T20:46:11.844295-03:00","closed_at":"2026-01-10T20:46:11.844295-03:00","close_reason":"Closed"}
{"id":"askbot-master-7o5","title":"Markdown backend support","description":"## Goal\nComplete all backend markdown processing work including tests, security fixes, and cleanup to ensure the Python markdown-it pipeline is fully tested and production-ready.\n\n## Scope\n- Security tests (XSS prevention for data: and javascript: URLs)\n- Integration tests (code blocks, math/emphasis, math/links, math/linkify)\n- Fix HTML-escape in highlight_code fallback paths\n- Research emphasis handling in code-friendly/MathJax modes\n- Cleanup stale comments and TODOs\n\n## Exit Criteria\n- All security tests pass\n- All integration tests pass\n- No XSS vulnerabilities in markdown processing\n- Code cleanup complete\n\n## Related\n- Frontend epic (askbot-master-37j) depends on this epic\n- Source: tasks/markdown-upgrade-status.md","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-01-10T22:17:42.770359-03:00","created_by":"devop","updated_at":"2026-01-11T15:51:34.672678-03:00","closed_at":"2026-01-11T15:51:34.672678-03:00","close_reason":"Closed","dependencies":[{"issue_id":"askbot-master-7o5","depends_on_id":"askbot-master-6yy","type":"blocks","created_at":"2026-01-10T22:23:26.411395-03:00","created_by":"devop"},{"issue_id":"askbot-master-7o5","depends_on_id":"askbot-master-qtj","type":"blocks","created_at":"2026-01-10T22:23:26.525148-03:00","created_by":"devop"},{"issue_id":"askbot-master-7o5","depends_on_id":"askbot-master-6za","type":"blocks","created_at":"2026-01-10T22:23:26.640643-03:00","created_by":"devop"},{"issue_id":"askbot-master-7o5","depends_on_id":"askbot-master-tkt","type":"blocks","created_at":"2026-01-10T22:23:26.753046-03:00","created_by":"devop"},{"issue_id":"askbot-master-7o5","depends_on_id":"askbot-master-xeq","type":"blocks","created_at":"2026-01-10T22:23:26.86617-03:00","created_by":"devop"},{"issue_id":"askbot-master-7o5","depends_on_id":"askbot-master-8u0","type":"blocks","created_at":"2026-01-10T22:23:26.97802-03:00","created_by":"devop"},{"issue_id":"askbot-master-7o5","depends_on_id":"askbot-master-hpj","type":"blocks","created_at":"2026-01-10T22:23:27.093619-03:00","created_by":"devop"},{"issue_id":"askbot-master-7o5","depends_on_id":"askbot-master-6n7","type":"blocks","created_at":"2026-01-10T22:23:27.209834-03:00","created_by":"devop"},{"issue_id":"askbot-master-7o5","depends_on_id":"askbot-master-cx8","type":"blocks","created_at":"2026-01-10T22:23:27.321132-03:00","created_by":"devop"},{"issue_id":"askbot-master-7o5","depends_on_id":"askbot-master-2um","type":"blocks","created_at":"2026-01-10T22:23:27.434215-03:00","created_by":"devop"},{"issue_id":"askbot-master-7o5","depends_on_id":"askbot-master-mdo","type":"blocks","created_at":"2026-01-10T22:23:27.547921-03:00","created_by":"devop"},{"issue_id":"askbot-master-7o5","depends_on_id":"askbot-master-ap5","type":"blocks","created_at":"2026-01-11T15:01:16.36949-03:00","created_by":"Evgeny Fadeev"}],"comments":[{"id":59,"issue_id":"askbot-master-7o5","author":"Evgeny Fadeev","text":"After fine-tuning emphasis handling, re-run full markdown backend test battery: askbot.tests.test_markdown_mathjax, askbot.tests.test_markdown_integration, and askbot.tests.test_markup to verify no regressions.","created_at":"2026-01-11T17:05:05Z"}]}
{"id":"askbot-master-8lq","title":"Audit task file: background-for-escaped-delimiters-mathjax.md","description":"Analyze tasks/background-for-escaped-delimiters-mathjax.md - Background context for dollar sign escaping problem.","notes":"## Audit Instructions\n\n**Before starting:**\n1. Read `tasks/markdown-upgrade-status.md` to understand the document structure and current state\n\n**When completing this audit:**\n1. **Add findings to this bd issue** using `bd comments add \u003cissue-id\u003e` with key observations\n2. **Edit ONLY your relevant section** in `tasks/markdown-upgrade-status.md` - do NOT overwrite the entire file\n3. **Reference this issue ID** (e.g., `askbot-master-xxx`) in the status file where you add findings\n4. **Update the Audit Trail table** at the bottom - change your row status from `pending` to `done`\n5. When complete, close this issue with `bd close \u003cissue-id\u003e`\n\n**Important:** Use the Edit tool to modify specific sections. Do not use Write to replace the whole file.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:16:47.336191-03:00","created_by":"devop","updated_at":"2026-01-10T19:00:56.44628-03:00","closed_at":"2026-01-10T19:00:56.44628-03:00","close_reason":"Closed","labels":["audit","task-file"],"dependencies":[{"issue_id":"askbot-master-8lq","depends_on_id":"askbot-master-0ae","type":"blocks","created_at":"2026-01-10T14:25:12.266497-03:00","created_by":"devop"}],"comments":[{"id":26,"issue_id":"askbot-master-8lq","author":"devop","text":"## Audit Findings: background-for-escaped-delimiters-mathjax.md\n\n**Document Status:** BACKGROUND DOCUMENT - PARTIALLY OBSOLETE\n\n### What's Still Valid:\n1. **Problem statement (lines 1-28)** - Correctly identifies the core issue: dollar is not in CommonMark escape list, so markdown-it does not process backslash-dollar\n2. **Multi-layer escaping complexity (lines 30-57)** - Accurate technical analysis of Python/markdown/browser/MathJax layers\n3. **Design decisions:**\n   - dollar entity approach - IMPLEMENTED\n   - Preserve backslash-dollar inside math - IMPLEMENTED  \n   - NO auto-convert of dollar-100 - CORRECT BEHAVIOR\n\n### What's Obsolete:\n1. **Architecture (lines 149-179):** Proposed inline rule approach was NOT used\n   - Document proposes: dollar_escape inline rule running after math rules\n   - Actual: escape_dollars() is a simple preprocessing function (42 lines) that runs AFTER extract_math()\n   - This is simpler and avoids markdown-it plugin complexity\n\n2. **Next Steps (lines 258-266):** Outdated - shows 4 items as pending but all done via different implementation\n\n### Test Coverage:\n- Single escaped dollar: TESTED (test_simple_escaped_dollar)\n- Escaped with markdown: GAP - NOT tested\n- Both sides escaped: TESTED (test_multiple_escaped_dollars)\n- Display delimiter escape: TESTED (test_escaped_double_dollar)\n- Escaped in inline math: TESTED (test_math_with_escaped_dollar)\n- Escaped in display math: TESTED (test_escaped_dollar_in_display_math)\n\n### Open Questions Status:\n- Triple backslash handling: UNDEFINED BEHAVIOR (known edge case)\n- Performance: Mitigated\n- Code blocks: Correctly handled\n- Plugin interaction: N/A (preprocessing, not plugin)\n\n**Recommendation:** Archive as historical reference; useful for understanding the problem space. Implementation details superseded by v2 preprocessing approach.\n","created_at":"2026-01-10T21:52:17Z"},{"id":27,"issue_id":"askbot-master-8lq","author":"devop","text":"## Audit Findings: background-for-escaped-delimiters-mathjax.md (REVISED)\n\n**Document Status:** BACKGROUND DOCUMENT - PARTIALLY OBSOLETE with CRITICAL GAPS\n\n### What's Still Valid:\n1. **Problem statement (lines 1-28)** - Correctly identifies core issue\n2. **Multi-layer escaping analysis (lines 30-57)** - Accurate technical breakdown\n3. **Design decisions adopted:**\n   - \u0026dollar; entity approach - IMPLEMENTED\n   - Preserve \\$ inside math for LaTeX - IMPLEMENTED\n   - NO auto-convert of $100 - IMPLEMENTED\n\n### What's Obsolete:\n1. **Architecture (lines 149-179):** Proposed inline rule NOT used\n   - Document: dollar_escape inline rule after math rules\n   - Actual: escape_dollars() preprocessing function (42 lines) runs AFTER extract_math()\n\n2. **Next Steps (lines 258-266):** Items 2-4 done differently; items 5-6 (user docs) NOT DONE\n\n### CRITICAL: Edge Case Verification\n\nTested edge cases from document lines 171-179:\n\n| Case | Input | Doc Expects | Actual | Match |\n|------|-------|-------------|--------|-------|\n| 1 | \\$ | \u0026dollar; | \u0026dollar; | YES |\n| 2 | \\$$ | \u0026dollar;\u0026dollar; | \u0026dollar;$ | NO |\n| 3 | \\$\\$ | \u0026dollar;\u0026dollar; | \u0026dollar;\u0026dollar; | YES |\n| 4 | \\\\$ | \\$ | \\\u0026dollar; | NO (known limitation) |\n\nCase 2 deviation: Implementation treats \\$ atomically, so \\$$ = \\$ + $ = \u0026dollar;$\n\n### CRITICAL: Test Requirement #2 CANNOT PASS\n\nDocument test (lines 189-192):\n- Input: \\$x = *y*$\n- Expected: \u0026dollar;x = \u003cem\u003ey\u003c/em\u003e$\n\n**Actual behavior verified:**\n- extract_math runs FIRST (before escape_dollars)\n- extract_math does NOT respect backslash escaping\n- Result: $x = *y*$ is extracted as MATH\n- The *y* is INSIDE math block - no emphasis processing\n- Final output will NOT match document expectation\n\n**This is a DESIGN GAP:** Document assumes \\$ prevents math mode, but extract_math doesn't check for preceding backslash.\n\n### Test for \"Mixed escaped and real math\":\nInput: Text \\$50 and $math$ here\nExpected: \"Text \u0026dollar;50 and $math$ here\"\nActual math extracted: \"$50 and $\" (WRONG - includes literal text!)\n\n### Display Math with LaTeX Dollar:\nInput: $$price = \\$50$$\nResult: Correctly preserved - LaTeX \\$ inside display math works\n\n### Document Section Status:\n\n| Section | Status |\n|---------|--------|\n| Problem Statement | VALID |\n| Multi-Layer Escaping | VALID |\n| Design Question #1 | VALID |\n| Proposed Solution | PARTIALLY VALID (approach adopted, edge cases differ) |\n| Design Question #2 | VALID |\n| Implementation Requirements | OBSOLETE (different architecture) |\n| Edge Cases (lines 171-179) | 2 of 6 FAIL |\n| Test Requirements | Test #2 CANNOT PASS with current impl |\n| Open Questions | #1 not implemented; #2-4 resolved |\n\n### Recommended Actions:\n1. HIGH: Create issue for extract_math to respect \\$ escaping (or document as intentional)\n2. MEDIUM: Update document to reflect actual edge case behavior\n3. LOW: Implement user documentation (Next Steps items 5-6)\n","created_at":"2026-01-10T22:00:07Z"}]}
{"id":"askbot-master-8nq","title":"Audit task file: improve-markdown-it-plugin-tests.md","description":"Analyze tasks/improve-markdown-it-plugin-tests.md - Test improvement requirements. Extract pending test work.","notes":"## Audit Instructions\n\n**Before starting:**\n1. Read `tasks/markdown-upgrade-status.md` to understand the document structure and current state\n\n**When completing this audit:**\n1. **Add findings to this bd issue** using `bd comments add \u003cissue-id\u003e` with key observations\n2. **Edit ONLY your relevant section** in `tasks/markdown-upgrade-status.md` - do NOT overwrite the entire file\n3. **Reference this issue ID** (e.g., `askbot-master-xxx`) in the status file where you add findings\n4. **Update the Audit Trail table** at the bottom - change your row status from `pending` to `done`\n5. When complete, close this issue with `bd close \u003cissue-id\u003e`\n\n**Important:** Use the Edit tool to modify specific sections. Do not use Write to replace the whole file.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:16:51.10157-03:00","created_by":"devop","updated_at":"2026-01-10T19:51:56.566585-03:00","closed_at":"2026-01-10T19:51:56.566585-03:00","close_reason":"Closed","labels":["audit","task-file"],"dependencies":[{"issue_id":"askbot-master-8nq","depends_on_id":"askbot-master-p48","type":"blocks","created_at":"2026-01-10T14:25:12.497468-03:00","created_by":"devop"}],"comments":[{"id":28,"issue_id":"askbot-master-8nq","author":"devop","text":"## Audit Findings for improve-markdown-it-plugin-tests.md\n\n### Status: SUBSTANTIALLY COMPLETE with GAPS\n\n**Test Files Analyzed:**\n- test_markdown_integration.py (12 tests)\n- test_markdown_link_patterns_plugin.py (7 tests)  \n- test_markdown_video_plugin.py (7 tests)\n\n**Test Results:** All 26 tests PASS\n\n### What Was Improved (vs task file 'Current' examples):\nAll 17 tests identified in task file have been converted from weak text-based assertions to BeautifulSoup structural validation:\n- ✅ Tests now use `soup = BeautifulSoup(html, 'html5lib')`\n- ✅ Tests find actual elements (iframe, a, p, ul, etc.)\n- ✅ Tests verify attributes (href, src, class)\n- ✅ Tests validate structure (element nesting, counts)\n\n### GAPS IDENTIFIED:\n\n**Video Embed Tests Missing Checks:**\nThe video_embed.py plugin outputs:\n```html\n\u003cdiv class=\"video-embed video-embed-{service}\"\u003e\n  \u003ciframe ... allowfullscreen loading=\"lazy\"\u003e\u003c/iframe\u003e\n\u003c/div\u003e\n```\n\nBut tests don't verify:\n| Test | Missing Checks |\n|------|----------------|\n| test_youtube_embed | wrapper div class, allowfullscreen |\n| test_vimeo_embed | wrapper div class, allowfullscreen |\n| test_dailymotion_embed | wrapper div class |\n| test_video_embedding (integration) | wrapper div class, allowfullscreen |\n| test_multiple_videos | wrapper div classes |\n\n**Task File Inaccuracy:**\nDocument recommends checking `iframe.get('class', [])` for 'video-embed-youtube', but class is actually on wrapper DIV, not iframe.\n\n### Pending Work:\n1. Add wrapper div class checks to all video embed tests\n2. Add `allowfullscreen` attribute checks to iframe assertions\n3. (Optional) Add `loading=\"lazy\"` attribute check\n\n### Recommendation:\nCreate follow-up issue for video embed test completeness (LOW priority - core functionality is tested).","created_at":"2026-01-10T22:49:04Z"}]}
{"id":"askbot-master-8u0","title":"Add integration test: verify math content protected from emphasis","description":"## Context\nThe MathJax v2 preprocessing implementation extracts math content to `@@N@@` tokens BEFORE markdown processing, then restores them after. This should protect math content from having underscores/asterisks processed as emphasis.\n\n## Task\nAdd an integration test to `askbot/tests/test_markdown_mathjax.py` that verifies emphasis markers inside math delimiters are NOT converted to `\u003cem\u003e` or `\u003cstrong\u003e` tags.\n\n## Test Requirements\n- Must use `markdown_input_converter()` (full pipeline), not `md.render()`\n- Must have `ENABLE_MATHJAX=True` setting active\n\n## Test Cases\n```python\ndef test_underscore_inside_math_not_emphasis(self):\n    \"\"\"Underscores inside math should not become emphasis\"\"\"\n    text = \"Formula $a_b + c_d$ here\"\n    html = markdown_input_converter(text)\n    # Underscores should be preserved, not converted to \u003cem\u003e or \u003csub\u003e\n    assert '\u003cem\u003e' not in html\n    assert '_b' in html or 'a_b' in html  # underscore preserved\n\ndef test_asterisk_inside_math_not_emphasis(self):\n    \"\"\"Asterisks inside math should not become emphasis\"\"\"\n    text = \"Formula $a * b * c$ here\"\n    html = markdown_input_converter(text)\n    # Should not have emphasis tags wrapping content\n    assert '\u003cem\u003eb\u003c/em\u003e' not in html\n\ndef test_double_underscore_inside_math_not_strong(self):\n    \"\"\"Double underscores inside math should not become strong\"\"\"\n    text = \"Formula $a__b__c$ here\"\n    html = markdown_input_converter(text)\n    assert '\u003cstrong\u003e' not in html\n```\n\n## Acceptance Criteria\n- [ ] Test passes with current implementation (verifies protection works)\n- [ ] Test uses `markdown_input_converter()` for full pipeline coverage\n- [ ] Test covers both underscore and asterisk emphasis\n- [ ] Test is added to `test_markdown_mathjax.py`\n\n## Related\n- Source: tasks/markdown-upgrade-status.md section 7\n- Pipeline: askbot/utils/markup.py `markdown_input_converter()`","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T21:39:13.860295-03:00","created_by":"devop","updated_at":"2026-01-11T14:02:08.669933-03:00","closed_at":"2026-01-11T14:02:08.669933-03:00","close_reason":"Closed","dependencies":[{"issue_id":"askbot-master-8u0","depends_on_id":"askbot-master-q54","type":"blocks","created_at":"2026-01-10T22:01:24.653455-03:00","created_by":"devop"}]}
{"id":"askbot-master-8un","title":"Editor help panel HTML section: filter tags based on ALLOWED_HTML_ELEMENTS constant","description":"In the html section of the editor help panel all the html tags shown must come from the constants in `askbot/utils/html.py`:\n\n- `ALLOWED_HTML_ELEMENTS` - tuple of allowed HTML element names\n- `ALLOWED_HTML_ATTRIBUTES` - dict mapping element names to their allowed attributes\n\n**Requirements:**\n- If some tag is not in `ALLOWED_HTML_ELEMENTS`, do not have a help entry for it\n- If no html tags are allowed, then remove entire html section from the help panel\n\n**Files to modify:**\n- `askbot/templates/widgets/editor-help-panel.html` - the Jinja2 template for the help panel","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T10:58:53.713403-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-25T16:28:37.046508-03:00","closed_at":"2026-01-25T16:28:37.046508-03:00","close_reason":"done"}
{"id":"askbot-master-8xr","title":"Decide: syntax highlighting approach for frontend/backend compatibility","description":"## Context\n\nThe backend uses **Pygments** (Python) for syntax highlighting in markdown code blocks, while the frontend preview needs JavaScript-based highlighting. These use incompatible token class naming conventions:\n\n| Token Type | Pygments | highlight.js |\n|------------|----------|--------------|\n| Keyword    | `.k`     | `.hljs-keyword` |\n| Function   | `.nf`    | `.hljs-title.function_` |\n| String     | `.s2`    | `.hljs-string` |\n\n## Options to Evaluate\n\n1. **Keep both, align CSS themes** - Accept minor visual differences between preview and saved content\n2. **Switch backend to highlight.js** - Use a Python port/wrapper of highlight.js (e.g., `py-highlight` or similar) for consistent output\n3. **Use Pygments via Pyodide in browser** - Run actual Pygments in WASM (~10MB download, 3-5x slower, needs Web Worker)\n4. **CSS mapping layer** - Create CSS that maps Pygments classes to highlight.js theme colors\n\n## Decision Criteria\n\n- Visual consistency between preview and rendered content\n- Performance (especially for live preview while typing)\n- Maintenance burden\n- Bundle size impact\n\n## Outcome\n\nDocument chosen approach and update implementation plan for frontend migration accordingly.\n\n## Files\n\n- Backend highlighting: `askbot/utils/markup.py` (lines 38-76)\n- Frontend lib: `askbot/media/jslib/highlight/`\n- CSS: `askbot/media/sass/components/highlight.min.css`","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-11T12:37:38.49413-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-11T13:21:07.370693-03:00","closed_at":"2026-01-11T13:21:07.370693-03:00","close_reason":"Closed"}
{"id":"askbot-master-8zl","title":"Audit commit 7: Removed redundant tests","description":"Analyze commit 339de84e0 - askbot/tests/test_markup.py: removed redundant tests.","notes":"## Audit Instructions\n\n**Before starting:**\n1. Read `tasks/markdown-upgrade-status.md` to understand the document structure and current state\n\n**When completing this audit:**\n1. **Add findings to this bd issue** using `bd comments add \u003cissue-id\u003e` with key observations\n2. **Edit ONLY your relevant section** in `tasks/markdown-upgrade-status.md` - do NOT overwrite the entire file\n3. **Reference this issue ID** (e.g., `askbot-master-xxx`) in the status file where you add findings\n4. **Update the Audit Trail table** at the bottom - change your row status from `pending` to `done`\n5. When complete, close this issue with `bd close \u003cissue-id\u003e`\n\n**Important:** Use the Edit tool to modify specific sections. Do not use Write to replace the whole file.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:15:38.825222-03:00","created_by":"devop","updated_at":"2026-01-10T16:11:51.249457-03:00","closed_at":"2026-01-10T16:11:51.249457-03:00","close_reason":"Closed","labels":["audit","commit"],"dependencies":[{"issue_id":"askbot-master-8zl","depends_on_id":"askbot-master-u9s","type":"blocks","created_at":"2026-01-10T14:15:38.826062-03:00","created_by":"devop"},{"issue_id":"askbot-master-8zl","depends_on_id":"askbot-master-6ts","type":"blocks","created_at":"2026-01-10T14:22:31.215394-03:00","created_by":"devop"}],"comments":[{"id":29,"issue_id":"askbot-master-8zl","author":"devop","text":"## Audit Summary: Commit 339de84e0\n\n**Purpose:** Removed 3 redundant linkify tests from `test_markup.py` (-49 lines) that became obsolete after commit 6's comprehensive test suite.\n\n### Tests Removed\n\n1. **`test_full_link_converts_to_anchor`** - Full URL auto-linkification\n   - Now covered by: `test_plain_url_linkification`, `test_https_url`, `test_ftp_url`\n\n2. **`test_protocol_less_link_converts_to_anchor`** - www. URL linkification  \n   - Now covered by: `test_www_detection`, `test_fuzzy_link_detection`\n\n3. **`test_convert_mixed_text`** - Mixed HTML/markdown with truncation\n   - Now covered by: `test_url_truncation_at_40_chars`, `test_title_attribute_on_truncated_url`, `test_inline_code_protection`, `test_code_block_protection`\n\n### Rationale\nCommit 6 (ea2f58fa4) added 260+ lines of dedicated linkify/truncation tests in `test_markdown_truncate_links_plugin.py` plus 43 lines in `test_markdown_integration.py`. These provide much better coverage and isolation than the removed tests, making them redundant.\n\n### Files Modified\n- **askbot/tests/test_markup.py** (-49 lines)\n\n### Assessment\nCorrect cleanup commit. No functionality lost - just removed duplicate test coverage.","created_at":"2026-01-10T18:57:36Z"},{"id":30,"issue_id":"askbot-master-8zl","author":"devop","text":"## Correction to Previous Analysis\n\n**Error in mapping for `test_convert_mixed_text`:**\n\nI incorrectly stated this was covered by `test_code_block_protection`. That's wrong:\n\n- **Removed test**: Verified raw HTML blocks (`\u003cp\u003e`, `\u003cpre\u003e` tags) pass through unchanged with URLs inside NOT linkified\n- **New test**: `test_code_block_protection` tests fenced markdown code blocks (``` syntax), which is different\n\n**Actual coverage gap:** Raw HTML block handling is **no longer explicitly tested**. The behavior relies on markdown-it core treating HTML blocks as opaque.\n\n**Impact assessment:** Low risk - this is markdown-it's documented core behavior, not custom plugin code. But technically a coverage gap exists for:\n- URLs inside raw `\u003cp\u003e` tags not being linkified\n- URLs inside raw `\u003cpre\u003e` tags not being linkified\n\n**Recommendation:** Could add a test for raw HTML block handling if paranoid, but likely acceptable to trust markdown-it core behavior here.","created_at":"2026-01-10T19:03:19Z"},{"id":31,"issue_id":"askbot-master-8zl","author":"devop","text":"## Additional Finding: Test Type Shift\n\n**Removed tests used:** `self.conv = markdown_input_converter` - full pipeline including `sanitize_html()`\n\n**New tests use:** `self.md = MarkdownIt(...)` then `self.md.render()` - markdown only, no sanitization\n\n**Implication:** We no longer have integration tests verifying that linkify+truncation output survives the `sanitize_html()` step unchanged.\n\n**Risk assessment:** Low. The `sanitize_html()` function operates on HTML tags/attributes and shouldn't modify valid anchor tags. The remaining `test_anchor_stays_untouched` test in `test_markup.py` still uses the full pipeline, providing some integration coverage.\n\n**Summary of coverage gaps identified:**\n1. Raw HTML block handling (`\u003cp\u003e`, `\u003cpre\u003e` tags) - no explicit test\n2. Full pipeline integration for linkify output - only partial coverage via `test_anchor_stays_untouched`","created_at":"2026-01-10T19:06:26Z"}]}
{"id":"askbot-master-9a9","title":"Restrict iframe sanitization to whitelisted video hosts","description":"## Goal\nMake iframe sanitization more secure by only allowing iframes from whitelisted video hosting domains.\n\n## Current State\nBoth backend (bleach) and frontend (DOMPurify) currently allow all iframes, which is a security risk. Users could potentially embed malicious iframes from any domain.\n\n## Required Changes\n\n### Backend (askbot/conf/static_settings.py)\nReplace simple iframe allowlist with a custom bleach filter that validates iframe `src` against whitelisted domains:\n- youtube.com / www.youtube.com\n- player.vimeo.com\n- www.dailymotion.com\n\n### Frontend (askbot/media/wmd/askbot_converter.js)\nConfigure DOMPurify with a custom hook to validate iframe src:\n```javascript\nDOMPurify.addHook('uponSanitizeElement', function(node, data) {\n  if (data.tagName === 'iframe') {\n    var src = node.getAttribute('src') || '';\n    var allowedHosts = [\n      'www.youtube.com',\n      'youtube.com', \n      'player.vimeo.com',\n      'www.dailymotion.com'\n    ];\n    // Check if src starts with allowed host\n    // Remove iframe if not whitelisted\n  }\n});\n```\n\n## Files\n- `askbot/conf/static_settings.py` - backend sanitization\n- `askbot/media/wmd/askbot_converter.js` - frontend sanitization\n- `askbot/utils/html.py` - may need custom bleach filter\n\n## Acceptance Criteria\n- [ ] Iframes from YouTube, Vimeo, Dailymotion are allowed\n- [ ] Iframes from other domains are stripped\n- [ ] Works on both backend and frontend preview\n- [ ] No XSS vulnerabilities introduced","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T21:36:02.970736-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-12T12:08:27.032444-03:00","closed_at":"2026-01-12T12:08:27.032444-03:00","close_reason":"instead will use protection pattern similar to what's done for mathjax"}
{"id":"askbot-master-9b9","title":"Improve whitespace use in and around of the editor help panel","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T10:53:05.016449-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-18T17:45:37.633785-03:00","closed_at":"2026-01-18T17:45:37.633785-03:00","close_reason":"Fixed manually"}
{"id":"askbot-master-a5f","title":"test title with very long unwrappable line - in the old version it's pushing out of the space available","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-31T13:29:04.55131-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-31T19:54:48.368367-03:00","closed_at":"2026-01-31T19:54:48.368367-03:00","close_reason":"Closed","comments":[{"id":108,"issue_id":"askbot-master-a5f","author":"Evgeny Fadeev","text":"Fixed long unwrappable words overflowing into sidebar by adding overflow-wrap: break-word to:\n- .js-post.js-question h1 in sass/question/post.scss (question detail page)\n- .question-summary h2 in sass/questions/question_summary.scss (questions list and user profile pages)","created_at":"2026-01-31T22:54:30Z"}]}
{"id":"askbot-master-a8f","title":"Imrove UX of video embedding: in the document insert text Video","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T11:28:32.817254-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-25T21:34:34.659061-03:00","closed_at":"2026-01-25T21:34:34.659061-03:00","close_reason":"Closed","comments":[{"id":83,"issue_id":"askbot-master-a8f","author":"Evgeny Fadeev","text":"Modify extension to take and display video title","created_at":"2026-01-25T19:59:40Z"},{"id":85,"issue_id":"askbot-master-a8f","author":"Evgeny Fadeev","text":"## Implementation Plan\n\n**Summary:** Transform video embedding from inline iframes to clickable links that open in a modal player, with optional title support.\n\n- **Current:** `@[youtube](id)` → inline `\u003ciframe\u003e`\n- **New:** `@[youtube](id)` → `(Video ▶)` link → modal with player\n- **New with title:** `@[youtube](id \"Title\")` → `(Video \"Title\" ▶)` link\n\n### Implementation Order\n1. Python first → test → port to JavaScript\n\n### Safeguards (No Collateral Damage)\n- **No base class modifications**: `ModalDialog` stays unchanged\n- **Isolated CSS**: Video modal uses `.video-modal` class\n- **Namespaced JS**: Click handler only targets `.js-video-link` elements\n- **Backward compatible**: Existing syntax still works\n- **Feature-flagged**: Only active when `videoEmbeddingEnabled` is true\n\n### Phases\n\n**Phase 1: Python Backend**\n- Update `video_extract.py`: regex for optional title, output link HTML instead of iframe\n- Update `html.py`: allowlist data attributes\n\n**Phase 2: Python Tests**\n- Add tests for title syntax, link output, data attributes\n\n**Phase 3: JavaScript**\n- Port `video_extract.js` changes\n- Create `video_modal.js` extending `ModalDialog` (singleton, event delegation)\n- Register script in `bottom_scripts.html`\n\n**Phase 4: CSS**\n- Style `.video-link` and `.video-modal`\n\n**Phase 5: Help Panel**\n- Update `VideoHelp.svelte` with new syntax documentation\n\n### Files to Modify\n- `askbot/utils/markdown_plugins/video_extract.py`\n- `askbot/utils/html.py`\n- `askbot/tests/test_markdown_video_plugin.py`\n- `askbot/media/wmd/markdown-it/plugins/video_extract.js`\n- `askbot/media/js/utils/video_modal.js` (new)\n- `askbot/jinja2/meta/bottom_scripts.html`\n- `askbot/media/sass/components/video_embed.scss`\n- `askbot/media/wmd/help-panel/src/tabs/VideoHelp.svelte`","created_at":"2026-01-25T20:44:23Z"},{"id":87,"issue_id":"askbot-master-a8f","author":"Evgeny Fadeev","text":"## Updated Implementation Plan\n\n### Key Decisions\n- **JS class convention**: All JS-related classes use `js-` prefix (`.js-video-link`, `.js-video-modal`)\n- **Token strategy preserved**: Keep `@@VIDEO{N}@@` guards - no `html.py` changes needed\n- **Modal approach**: Extend `ModalDialog` without modifying base class\n\n### Safeguards (No Collateral Damage)\n- No base class modifications: `ModalDialog` unchanged\n- No `html.py` changes: data attributes inserted post-sanitization\n- Isolated CSS: `.js-video-modal` class won't affect existing modals\n- Namespaced JS: click handler only targets `.js-video-link`\n- Feature-flagged: only active when `videoEmbeddingEnabled` is true\n\n### Files to Modify\n1. `askbot/utils/markdown_plugins/video_extract.py` - regex + link output\n2. `askbot/tests/test_markdown_video_plugin.py` - new tests\n3. `askbot/media/wmd/markdown-it/plugins/video_extract.js` - port Python changes\n4. `askbot/media/js/utils/video_modal.js` - **new file**\n5. `askbot/jinja2/meta/bottom_scripts.html` - add video_modal.js\n6. `askbot/media/sass/components/video_embed.scss` - link + modal styles\n7. `askbot/media/wmd/help-panel/src/tabs/VideoHelp.svelte` - update docs\n\n### Output HTML (inserted post-sanitization)\n```html\n\u003cspan class=\"video-link\"\u003e\n  \u003ca href=\"#\" class=\"js-video-link\"\n     data-video-service=\"youtube\"\n     data-video-id=\"abc123\"\n     data-video-title=\"Optional Title\"\u003e\n    (Video \"Optional Title\" \u003ci class=\"fa fa-play-circle\"\u003e\u003c/i\u003e)\n  \u003c/a\u003e\n\u003c/span\u003e\n```","created_at":"2026-01-25T22:21:49Z"},{"id":89,"issue_id":"askbot-master-a8f","author":"Evgeny Fadeev","text":"## Session Summary - Video Modal \u0026 Code Cleanup\n\n### Base ModalDialog ESC Key Handling\n- Added ESC key handling to base `ModalDialog` class in `modal_dialog.js`\n- Handler attaches on `show()`, detaches on `hide()` to prevent accumulation\n- Uses namespaced event (`keydown.modalDialog`) for clean removal\n- Removed redundant ESC handler from `VideoModal`\n- Updated `VideoModal.hide()` to call parent's `hide()` via `ModalDialog.prototype.hide.call(this)`\n- Verified all ModalDialog subclasses properly handle `hide()`\n\n### CSS Variable Refactoring (video_embed.scss)\n- Replaced hardcoded colors with CSS variables from `colors.scss`:\n  - `#1a1a1a` → `var(--clr-neutral-10)` (modal background)\n  - `#222` → `var(--clr-neutral-20)` (header background)\n  - `#333` → `var(--clr-neutral-20)` (header border)\n  - `#999` → `var(--clr-neutral-60)` (close button color)\n- Updated heading to use `var(--extra-large-font-size)` and `var(--font-weight-bold)`\n- Simplified header styling: removed wrapper div background, reduced padding\n\n### Code Deduplication (video_extract.py)\n- Deleted unused `video_embed.py` markdown-it plugin (was only used in tests)\n- Added `render_video_link(service, video_id, title)` function to `video_extract.py`\n- Refactored `restore_video_embeds()` to use `render_video_link()` - no more duplication\n- Rewrote tests with 4 focused test classes:\n  - `TestRenderVideoLink` - render function tests\n  - `TestExtractVideoEmbeds` - extraction tests\n  - `TestRestoreVideoEmbeds` - restoration tests\n  - `TestFullExtractRestoreFlow` - integration tests\n- All 21 tests pass","created_at":"2026-01-26T00:31:31Z"},{"id":90,"issue_id":"askbot-master-a8f","author":"Evgeny Fadeev","text":"## Feature Complete: Video Embedding UX Improvements\n\n### Overview\nTransformed video embedding from inline iframes to clickable links that open in a modal player, with optional title support.\n\n**Before:** `@[youtube](id)` → inline `\u003ciframe\u003e` embedded in content\n**After:** `@[youtube](id)` → `(Video ▶)` clickable link → modal player\n**With title:** `@[youtube](id \"Title\")` → `(Video \"Title\" ▶)` link\n\n### Implementation\n\n#### Python Backend (`video_extract.py`)\n- Updated regex to support optional title syntax: `@[service](id \"title\")`\n- Added `render_video_link(service, video_id, title)` function for HTML generation\n- `restore_video_embeds()` now uses `render_video_link()` - no code duplication\n- Deleted unused `video_embed.py` markdown-it plugin\n\n#### JavaScript (`video_extract.js`, `video_modal.js`)\n- Ported Python changes to JS for live preview support\n- Created `VideoModal` class extending `ModalDialog` (singleton pattern)\n- Supports YouTube, Vimeo, Dailymotion services\n- Event delegation on `document` for dynamic content support\n- Feature-flagged: only active when `videoEmbeddingEnabled` is true\n\n#### Base ModalDialog Enhancement (`modal_dialog.js`)\n- Added ESC key handling to base `ModalDialog` class\n- Handler attaches on `show()`, detaches on `hide()` to prevent accumulation\n- Uses namespaced event (`keydown.modalDialog`) for clean removal\n- All ModalDialog subclasses now benefit from ESC-to-close\n\n#### CSS Styling (`video_embed.scss`)\n- Service-specific link colors (YouTube red, Vimeo blue, Dailymotion blue)\n- Dark-themed modal with CSS variables from `colors.scss`\n- Responsive 16:9 aspect ratio iframe wrapper\n- Uses project font variables (`--extra-large-font-size`, `--font-weight-bold`)\n\n#### Help Panel (`VideoHelp.svelte`)\n- Updated documentation with new syntax examples\n- Shows both basic and titled video embed syntax\n\n#### Tests (`test_markdown_video_plugin.py`)\n- 21 tests covering:\n  - `TestRenderVideoLink` - render function (all services, XSS escaping)\n  - `TestExtractVideoEmbeds` - extraction (titles, invalid input, case handling)\n  - `TestRestoreVideoEmbeds` - restoration (multiple videos, HTML preservation)\n  - `TestFullExtractRestoreFlow` - integration tests\n\n### Files Modified\n- `askbot/utils/markdown_plugins/video_extract.py`\n- `askbot/utils/markdown_plugins/video_embed.py` (deleted)\n- `askbot/media/wmd/markdown-it/plugins/video_extract.js`\n- `askbot/media/js/utils/video_modal.js` (new)\n- `askbot/media/js/utils/modal_dialog.js`\n- `askbot/jinja2/meta/bottom_scripts.html`\n- `askbot/media/sass/components/video_embed.scss`\n- `askbot/media/wmd/help-panel/src/tabs/VideoHelp.svelte`\n- `askbot/tests/test_markdown_video_plugin.py`","created_at":"2026-01-26T00:34:02Z"},{"id":91,"issue_id":"askbot-master-a8f","author":"Evgeny Fadeev","text":"Fixed failing integration tests in test_markdown_integration.py. Updated test_video_embedding and test_combined_features to check for the new video link structure (\u003ca class='js-video-link'\u003e with data-video-service and data-video-id attributes) instead of iframe elements. All 23 integration tests now pass. Commit: 49f15ada3","created_at":"2026-01-26T00:41:42Z"}]}
{"id":"askbot-master-abw","title":"Delete tasks/ directory","description":"Final cleanup: remove the tasks/ directory entirely.\n\nPrerequisites (must be completed first):\n1. MathJax v2 implementation committed\n2. Legacy .md files committed for reference\n3. All relevant content migrated to bd issues\n\nAfter this, all project tracking is in bd.\n\nCommand: git rm -r tasks/","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T20:37:11.23391-03:00","created_by":"devop","updated_at":"2026-01-10T22:12:14.513539-03:00","closed_at":"2026-01-10T22:12:14.513539-03:00","close_reason":"Deleted all tasks/ files except markdown-upgrade-status.md which is referenced by other bd issues","dependencies":[{"issue_id":"askbot-master-abw","depends_on_id":"askbot-master-0m9","type":"blocks","created_at":"2026-01-10T20:38:15.058875-03:00","created_by":"devop"},{"issue_id":"askbot-master-abw","depends_on_id":"askbot-master-nfb","type":"blocks","created_at":"2026-01-10T20:38:51.528411-03:00","created_by":"devop"},{"issue_id":"askbot-master-abw","depends_on_id":"askbot-master-zog","type":"blocks","created_at":"2026-01-10T21:06:48.600634-03:00","created_by":"devop"},{"issue_id":"askbot-master-abw","depends_on_id":"askbot-master-ig7","type":"blocks","created_at":"2026-01-10T21:15:10.629428-03:00","created_by":"devop"},{"issue_id":"askbot-master-abw","depends_on_id":"askbot-master-33a","type":"blocks","created_at":"2026-01-10T21:15:19.086074-03:00","created_by":"devop"}]}
{"id":"askbot-master-ap5","title":"Fix emphasis handling: remove MathJax condition, implement asterisk-only for code-friendly mode","description":"## Context\n\nResearch issue askbot-master-cx8 found that the current emphasis handling at `markup.py:138-142` is overly aggressive:\n\n```python\nif askbot_settings.MARKUP_CODE_FRIENDLY or askbot_settings.ENABLE_MATHJAX:\n    md.disable('emphasis')\n    # TODO: Add custom rule to re-enable * only if needed\n```\n\nThis disables ALL emphasis (`*` and `_`) when either setting is enabled, breaking basic formatting for users.\n\n## Research Findings\n\n1. **MathJax does NOT need emphasis disabled** - The math extraction pipeline (extract → markdown → restore) already protects math content by replacing it with `@@N@@` tokens before markdown runs.\n\n2. **Code-friendly mode should disable underscore only** - StackOverflow's approach: disable `_` emphasis entirely but keep `*` working. This prevents issues with `snake_case` variables while preserving formatting.\n\n3. **markdown-it supports selective disabling** - Replace the emphasis tokenizer with a custom one that only handles `*`.\n\n## Proposed Implementation\n\n### Step 1: Create asterisk-only emphasis plugin\n\nCreate `askbot/utils/markdown_plugins/asterisk_emphasis.py`:\n\n```python\n\"\"\"Asterisk-only emphasis for code-friendly mode.\"\"\"\nfrom markdown_it.rules_inline.state_inline import Delimiter, StateInline\n\ndef asterisk_only_tokenize(state: StateInline, silent: bool) -\u003e bool:\n    \"\"\"Emphasis tokenizer that only handles * (ignores _).\"\"\"\n    start = state.pos\n    marker = state.src[start]\n\n    if silent:\n        return False\n\n    if marker != \"*\":  # KEY: only handle asterisk\n        return False\n\n    scanned = state.scanDelims(state.pos, True)\n\n    for _ in range(scanned.length):\n        token = state.push(\"text\", \"\", 0)\n        token.content = marker\n        state.delimiters.append(\n            Delimiter(\n                marker=ord(marker),\n                length=scanned.length,\n                token=len(state.tokens) - 1,\n                end=-1,\n                open=scanned.can_open,\n                close=scanned.can_close,\n            )\n        )\n\n    state.pos += scanned.length\n    return True\n\n\ndef asterisk_emphasis_plugin(md):\n    \"\"\"Plugin to replace emphasis with asterisk-only version.\"\"\"\n    md.inline.ruler.at(\"emphasis\", asterisk_only_tokenize)\n```\n\n### Step 2: Update markup.py\n\nReplace lines 136-150 with:\n\n```python\n# Code-friendly mode: disable underscore emphasis, keep asterisk\n# This prevents issues with snake_case variables while preserving *italic* and **bold**\nif askbot_settings.MARKUP_CODE_FRIENDLY:\n    from askbot.utils.markdown_plugins.asterisk_emphasis import asterisk_emphasis_plugin\n    md.use(asterisk_emphasis_plugin)\n\n# Note: MathJax does NOT need emphasis disabled - math is extracted to tokens\n# before markdown runs, so emphasis never touches math content\n```\n\n### Step 3: Remove stale TODO comment\n\nDelete the TODO at line 142 and the pass statement at line 150.\n\n## Expected Behavior After Fix\n\n| Input | MathJax ON | Code-Friendly ON | Both OFF |\n|-------|-----------|------------------|----------|\n| `$a_b$` | `$a_b$` (protected) | `$a_b$` | `$a_b$` |\n| `_italic_` | `\u003cem\u003eitalic\u003c/em\u003e` | `_italic_` (literal) | `\u003cem\u003eitalic\u003c/em\u003e` |\n| `*italic*` | `\u003cem\u003eitalic\u003c/em\u003e` | `\u003cem\u003eitalic\u003c/em\u003e` | `\u003cem\u003eitalic\u003c/em\u003e` |\n| `__bold__` | `\u003cstrong\u003ebold\u003c/strong\u003e` | `__bold__` (literal) | `\u003cstrong\u003ebold\u003c/strong\u003e` |\n| `**bold**` | `\u003cstrong\u003ebold\u003c/strong\u003e` | `\u003cstrong\u003ebold\u003c/strong\u003e` | `\u003cstrong\u003ebold\u003c/strong\u003e` |\n\n## Acceptance Criteria\n\n- [ ] MathJax enabled: emphasis works normally (both `_` and `*`)\n- [ ] Code-friendly enabled: only `*` emphasis works, `_` stays literal\n- [ ] Both enabled: only `*` emphasis works (code-friendly takes precedence)\n- [ ] Neither enabled: emphasis works normally\n- [ ] Remove stale TODO comment at line 142\n- [ ] Remove stale pass statement at line 150\n- [ ] All existing tests pass\n- [ ] Review existing tests in `test_markup.py`, `test_markdown_mathjax.py`, and `test_markdown_integration.py` to check if they already cover the new behavior; only add new tests if gaps exist\n\n## Files to Modify\n\n- `askbot/utils/markup.py` (lines 136-150)\n- New: `askbot/utils/markdown_plugins/asterisk_emphasis.py`\n- `askbot/tests/test_markup.py` (if new tests needed)\n\n## Related\n\n- Research: askbot-master-cx8\n- Epic: askbot-master-7o5 (Markdown backend support)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T15:01:07.932921-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-11T15:38:45.331786-03:00","closed_at":"2026-01-11T15:38:45.331786-03:00","close_reason":"Closed","comments":[{"id":62,"issue_id":"askbot-master-ap5","author":"Evgeny Fadeev","text":"## Implementation Plan\n\n**Workflow:**\n1. Run all markdown tests first (baseline)\n2. Create asterisk-only emphasis plugin\n3. Update markup.py to use the plugin\n4. Run tests - expect specific tests to fail (the ones assuming wrong behavior)\n5. Update failing tests to match new correct behavior\n6. Run all tests again to verify everything passes\n\n**Changes:**\n\n### 1. Create asterisk-only emphasis plugin\n`askbot/utils/markdown_plugins/asterisk_emphasis.py` (new)\n\nCustom emphasis plugin that only handles `*` markers, ignoring `_`. Plugin needs:\n- `tokenize()`: Scans for `*` markers and creates delimiters (ignores `_`)\n- `postProcess()`: Converts matched delimiter pairs to `\u003cem\u003e`/`\u003cstrong\u003e` tags\n\n### 2. Update markup.py (lines 136-150)\n- Remove `ENABLE_MATHJAX` from the condition (math already protected via token extraction)\n- Replace `md.disable('emphasis')` with custom asterisk-only plugin\n- Remove stale TODO comment\n- Remove the no-op `if ENABLE_MATHJAX: pass` block entirely\n\n### 3. Update tests (after verifying expected failures)\n- `test_markdown_mathjax.py` line 599: Update to expect emphasis to work with MathJax\n- `test_markdown_integration.py`: Add test for asterisk emphasis in code-friendly mode\n\n**Expected Behavior:**\n| Input | MathJax ON | Code-Friendly ON |\n|-------|-----------|------------------|\n| `_italic_` | `\u003cem\u003eitalic\u003c/em\u003e` | literal |\n| `*italic*` | `\u003cem\u003eitalic\u003c/em\u003e` | `\u003cem\u003eitalic\u003c/em\u003e` |","created_at":"2026-01-11T18:15:11Z"}]}
{"id":"askbot-master-awh","title":"autolink help should reflect actual autolink settings","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-25T16:50:56.553732-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-25T18:51:49.029145-03:00","closed_at":"2026-01-25T18:51:49.029145-03:00","close_reason":"Closed","comments":[{"id":86,"issue_id":"askbot-master-awh","author":"Evgeny Fadeev","text":"Fix: Show full example URLs in help panel autolinks\n\nChanges:\n- Modified generateExample() in settings.js to return both the display text and captured value\n- Updated parsedAutoLinks to compute exampleUrl by substituting the captured value into the URL template\n- Removed generateDescription() function (no longer needed)\n- Changed LinksHelp.svelte to display link.exampleUrl instead of link.description\n- Fixed vertical alignment with align-items: baseline\n\nNow displays:\n  gh:123 → https://github.com/ASKBOT/askbot-devel/issues/123\n  linear:DEVS-48 → https://linear.app/propertysimple/issue/DEVS-48\n\nInstead of:\n  gh:123 → github issue\n  linear:DEVS-48 → linear issue","created_at":"2026-01-25T21:50:52Z"}]}
{"id":"askbot-master-crx","title":"Make markdown conversion of code blocks more robust to changes in the setting of allowed tags","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T12:22:17.005295-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-12T13:23:20.032013-03:00","closed_at":"2026-01-12T13:23:20.032013-03:00","close_reason":"Closed"}
{"id":"askbot-master-cx8","title":"Research: emphasis handling in code-friendly and MathJax modes","description":"## Context\nCurrently `markup.py:138-142` disables ALL emphasis (both `*` and `_`) when either code-friendly mode or MathJax is enabled:\n\n```python\nif askbot_settings.MARKUP_CODE_FRIENDLY or askbot_settings.ENABLE_MATHJAX:\n    md.disable('emphasis')\n    # TODO: Add custom rule to re-enable * only if needed\n```\n\nThis breaks `*italic*` and `**bold**` formatting for users.\n\n## Questions to Research\n\n### 1. Is emphasis disabling still needed for MathJax?\nWith the preprocessing approach (extract math → markdown → restore math), math content is `@@N@@` tokens during markdown processing. Does this mean emphasis inside math is already protected without disabling emphasis globally?\n\n**Test to run:**\n```python\n# With ENABLE_MATHJAX=True but WITHOUT md.disable('emphasis')\ntext = \"Formula $a_b$ and _italic_ text\"\n# Does _italic_ become \u003cem\u003eitalic\u003c/em\u003e?\n# Does $a_b$ stay as $a_b$ (math extracted before emphasis runs)?\n```\n\n### 2. How does StackOverflow handle code-friendly mode?\nStackOverflow disables only underscore emphasis, keeping asterisk for bold/italic. Research:\n- How do they implement this technically?\n- Is there a markdown-it API to disable just `_` emphasis?\n- Or do they use a custom rule?\n\n### 3. markdown-it emphasis internals\n- Can we selectively disable underscore emphasis via markdown-it API?\n- Does `md.disable('emphasis')` have options?\n- Would we need a custom rule to re-enable `*`?\n\n## Deliverables\n1. Answer to each research question\n2. Recommended approach for fixing the issue\n3. If implementation is straightforward, create follow-up implementation issue\n4. If complex, document tradeoffs and options\n\n## Acceptance Criteria\n- [ ] Document findings for each research question\n- [ ] Provide code examples or references\n- [ ] Recommend implementation approach\n- [ ] Create follow-up implementation issue if applicable\n\n## Related\n- Code: askbot/utils/markup.py lines 136-142\n- TODO comment at line 142\n- StackOverflow's markdown implementation","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-10T21:41:08.304011-03:00","created_by":"devop","updated_at":"2026-01-11T15:02:05.842592-03:00","closed_at":"2026-01-11T15:02:05.842592-03:00","close_reason":"Closed","dependencies":[{"issue_id":"askbot-master-cx8","depends_on_id":"askbot-master-q54","type":"blocks","created_at":"2026-01-10T22:01:24.991284-03:00","created_by":"devop"}],"comments":[{"id":58,"issue_id":"askbot-master-cx8","author":"Evgeny Fadeev","text":"After fine-tuning emphasis handling, re-run full markdown backend test battery: askbot.tests.test_markdown_mathjax, askbot.tests.test_markdown_integration, and askbot.tests.test_markup to verify no regressions.","created_at":"2026-01-11T17:03:27Z"},{"id":61,"issue_id":"askbot-master-cx8","author":"Evgeny Fadeev","text":"## Research Findings\n\n### Question 1: Is emphasis disabling still needed for MathJax?\n\n**Answer: NO**\n\nWith the preprocessing approach (extract math → markdown → restore math), math content is replaced with `@@N@@` tokens BEFORE markdown processing. This means emphasis rules never see the math content.\n\n**Proof:**\n```\nInput:  Formula $a_b$ and _italic_ text\nAfter extract_math: Formula @@0@@ and _italic_ text\nAfter markdown: \u003cp\u003eFormula @@0@@ and \u003cem\u003eitalic\u003c/em\u003e text\u003c/p\u003e\nFinal: \u003cp\u003eFormula $a_b$ and \u003cem\u003eitalic\u003c/em\u003e text\u003c/p\u003e\n```\n\nMath is protected, and `_italic_` correctly becomes `\u003cem\u003e`. No need to disable emphasis for MathJax.\n\n### Question 2: How does StackOverflow handle code-friendly mode?\n\n**Answer: They disable underscore emphasis entirely, keeping asterisk**\n\n- CommonMark already prevents intra-word underscore emphasis (`snake_case` stays literal)\n- But code-friendly mode goes further: disable ALL underscore emphasis\n- Users must use `*italic*` and `**bold**` instead of `_italic_` and `__bold__`\n\n**Sources:**\n- Stack Overflow blog: Three Markdown Gotchas (2008)\n- python-markdown2 code-friendly extra\n- CommonMark spec\n\n### Question 3: Can markdown-it selectively disable underscore emphasis?\n\n**Answer: YES, via custom rule replacement**\n\nNo built-in option, but we can replace the emphasis tokenizer:\n\n```python\ndef asterisk_only_tokenize(state, silent):\n    marker = state.src[state.pos]\n    if marker != '*':  # Only handle asterisk, ignore underscore\n        return False\n    # ... rest of tokenize logic\n    \nmd.inline.ruler.at('emphasis', asterisk_only_tokenize)\n```\n\n**Tested result:**\n- `_italic_` → `_italic_` (literal)\n- `*italic*` → `\u003cem\u003eitalic\u003c/em\u003e` (works)\n- `__bold__` → `__bold__` (literal)\n- `**bold**` → `\u003cstrong\u003ebold\u003c/strong\u003e` (works)\n\n### Recommended Implementation\n\n1. **Remove MathJax from the emphasis-disabling condition** - not needed\n2. **For code-friendly mode only**, replace emphasis tokenizer with asterisk-only version\n3. **Remove the stale TODO comment** at line 142\n\nImplementation is straightforward (~20 lines of code).","created_at":"2026-01-11T17:56:07Z"}]}
{"id":"askbot-master-d30","title":"Audit task file: markdown-upgrade-phase1-backend.md","description":"Analyze tasks/markdown-upgrade-phase1-backend.md - Backend implementation details. Check which items are done vs pending.","notes":"## Audit Instructions\n\n**Before starting:**\n1. Read `tasks/markdown-upgrade-status.md` to understand the document structure and current state\n\n**When completing this audit:**\n1. **Add findings to this bd issue** using `bd comments add \u003cissue-id\u003e` with key observations\n2. **Edit ONLY your relevant section** in `tasks/markdown-upgrade-status.md` - do NOT overwrite the entire file\n3. **Reference this issue ID** (e.g., `askbot-master-xxx`) in the status file where you add findings\n4. **Update the Audit Trail table** at the bottom - change your row status from `pending` to `done`\n5. When complete, close this issue with `bd close \u003cissue-id\u003e`\n\n**Important:** Use the Edit tool to modify specific sections. Do not use Write to replace the whole file.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:16:31.645225-03:00","created_by":"devop","updated_at":"2026-01-10T18:03:45.373925-03:00","closed_at":"2026-01-10T18:03:45.373925-03:00","close_reason":"Closed","labels":["audit","task-file"],"dependencies":[{"issue_id":"askbot-master-d30","depends_on_id":"askbot-master-0pk","type":"blocks","created_at":"2026-01-10T14:25:11.962312-03:00","created_by":"devop"}],"comments":[{"id":32,"issue_id":"askbot-master-d30","author":"devop","text":"## Audit Findings: markdown-upgrade-phase1-backend.md\n\n### Document Status: OUTDATED but STRUCTURALLY SOUND\n\nThis document is a detailed implementation guide for Phase 1 backend work. Most tasks are now complete per commit audits, but the document shows all checkboxes as unchecked.\n\n### Task-by-Task Status:\n\n| Task | Description | Actual Status | Verification |\n|------|-------------|---------------|--------------|\n| 1.1 | Dependency Upgrades | ✅ DONE | Commit 4c3ad65bd: markdown-it-py 4.0.0, mdit-py-plugins 0.5.0 |\n| 1.2 | Pygments Integration | ✅ DONE | Commit 4c3ad65bd: highlight_code() in markup.py |\n| 1.3 | Video Embedding Plugin | ✅ DONE | Commit 4c3ad65bd: video_embed.py exists |\n| 1.4 | Link Patterns Plugin | ✅ DONE | Commit 4c3ad65bd: link_patterns.py exists |\n| 1.5 | Update get_md_converter() | ⚠️ PARTIAL | Math protection done (uncommitted), code-friendly bug exists |\n| 1.6 | Integration Testing | ⚠️ PARTIAL | Tests exist and pass, but coverage tooling not configured |\n| 1.7 | Update Tests | ✅ DONE | 35/35 tests pass per askbot-master-35c |\n\n### Exit Criteria Status:\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| All tests passing (0 failures) | ✅ | 35/35 pass |\n| Code coverage ≥95% | ❌ | No coverage tooling configured |\n| Manual validation | ❓ | No documentation of manual testing |\n| Performance benchmark | ❌ | Not performed |\n| Code review | ❓ | Not documented |\n| Documentation complete | ⚠️ | Overview doc is outdated |\n\n### Key Discrepancies:\n\n1. **Linkify not mentioned:** Commits 5-6 implemented linkify/truncate_links plugin - major deliverable not in this plan\n2. **MathJax implementation differs:** Document shows TODO for math protection; actual implementation uses preprocessing (math_extract.py) not plugin approach\n3. **Time estimates included:** Document has 'Estimated Time' for each task - should be removed per project standards\n4. **Virtual env naming:** Document specifies 'env-md/' but may not match actual setup\n5. **Preset changed:** Document uses 'gfm-like' but actual code uses 'commonmark'\n\n### Value Assessment:\n- Document served its purpose as implementation guide\n- Most code examples are accurate (though some details outdated)\n- Task breakdown structure is clear and well-organized\n- Should be marked as 'completed with deviations' rather than actively maintained","created_at":"2026-01-10T20:52:28Z"},{"id":33,"issue_id":"askbot-master-d30","author":"devop","text":"## ADDITIONAL FINDINGS (Deep Audit)\n\n### Code Example Accuracy Issues:\n\n1. **render_video_embed signature WRONG in document:**\n   - Document (line 330): `def render_video_embed(tokens, idx, options, env, renderer):`\n   - Actual code (line 93): `def render_video_embed(self, tokens, idx, options, env):`\n   - Document's version would NOT work - missing `self`, has extra `renderer`\n\n2. **Token import differs:**\n   - Document (line 561): `Token = state.Token`\n   - Actual code (line 27): `from markdown_it.token import Token`\n   - Both work, but shows document wasn't tested\n\n3. **XSS vulnerability in highlight_code fallback:**\n   - Lines 71, 76 in markup.py: `f'\u003cpre\u003e\u003ccode class=\"language-{lang}\"\u003e{code}\u003c/code\u003e\u003c/pre\u003e'`\n   - `lang` and `code` are NOT HTML-escaped\n   - Matches document example - BOTH have this vulnerability\n\n### Structural/Reference Errors:\n\n4. **Line number reference WRONG:**\n   - Document Task 1.5 says: `askbot/utils/markup.py:30-47`\n   - Actual get_md_converter() is at lines 82-154\n\n5. **Docstring/implementation mismatch in get_md_converter():**\n   - Line 87: Docstring says 'GFM-like preset'\n   - Line 103-105: Actual code uses 'commonmark' with manual table/strikethrough enables\n   - This is inconsistent documentation within the actual code\n\n6. **Misleading TODO comments in get_md_converter():**\n   - Lines 144-151 have TODO for math protection as if not implemented\n   - But markdown_input_converter() (lines 316-344) HAS the full implementation\n   - The TODO is stale/misleading\n\n### Missing from Document (Major):\n\n7. **truncate_links_plugin completely absent:**\n   - Actual code imports and uses it (lines 27, 130-134)\n   - Critical for URL display - not mentioned anywhere in document\n\n8. **MathJax preprocessing approach not described:**\n   - Document shows plugin approach (Task 1.5 lines 890-895)\n   - Actual uses 7-phase preprocessing in markdown_input_converter()\n   - Completely different architecture\n\n9. **sanitize_html() call not documented:**\n   - Line 347 calls sanitize_html(html) at end\n   - Document doesn't mention this security step\n\n### Configuration Details:\n\n10. **.coveragerc EXISTS:**\n    - File exists at project root (created Aug 4, 2021)\n    - But coverage tooling not integrated into test workflow\n    - Document's coverage commands (lines 1106-1108) are valid but not automated\n\n11. **Virtual env 'env-md/' may not match reality:**\n    - Document specifies env-md/ throughout\n    - CLAUDE.md mentions testproject/\n    - Should verify which is actually used","created_at":"2026-01-10T20:58:30Z"},{"id":34,"issue_id":"askbot-master-d30","author":"devop","text":"## VERIFICATION FINDINGS (Deep Audit Part 2)\n\n### Dependencies - FULLY VERIFIED:\n\n**askbot/__init__.py REQUIREMENTS dict (lines 38-42):**\n- `markdown_it`: 'markdown-it-py==4.0.0' ✅\n- `mdit_py_plugins`: 'mdit-py-plugins==0.5.0' ✅\n- `linkify_it`: 'linkify-it-py==2.0.2' ✅\n- `pygments`: 'pygments\u003e=2.15.0' ✅\n- markdown2: ❌ REMOVED (as specified)\n\n**askbot_requirements.txt:** All 4 dependencies present ✅\n\n### Environment - VERIFIED:\n- env-md/ directory EXISTS (created Oct 5) ✅\n- askbot_site/ directory EXISTS ✅\n- Document's venv instructions were followed\n\n### Documentation Deliverables - GAPS FOUND:\n\n| Deliverable | Status |\n|-------------|--------|\n| README for markdown_plugins | ❌ NOT CREATED |\n| Migration notes for developers | ❌ NOT CREATED |\n| Docstrings for functions | ✅ Present in code |\n\n### Test Implementation - IMPROVED OVER DOCUMENT:\n\n| Test File | Document Lines | Actual Lines | Notes |\n|-----------|---------------|--------------|-------|\n| test_markdown_video_plugin.py | ~55 | 99 | Uses BeautifulSoup |\n| test_markdown_link_patterns_plugin.py | ~96 | 144 | Uses BeautifulSoup |\n| test_markdown_integration.py | ~133 | 324 | Django TestCase |\n| test_markdown_mathjax.py | N/A | 385 | NOT IN DOCUMENT |\n| test_markdown_truncate_links_plugin.py | N/A | 260 | NOT IN DOCUMENT |\n| **TOTAL** | ~284 | **1,212** | 4.3x more than suggested |\n\nTest quality improvements:\n1. All tests use BeautifulSoup for structural HTML validation (more robust)\n2. Django TestCase used instead of pytest (consistent with project)\n3. 2 additional test files for features not in document\n\n### Exit Criteria Deep Assessment:\n\n| Criterion | Document Spec | Actual Status | Gap |\n|-----------|--------------|---------------|-----|\n| Tests passing | 0 failures | 35/35 ✅ | None |\n| Coverage ≥95% | Required | .coveragerc exists, not automated | CI integration |\n| Manual validation | Required | No records | Need documentation |\n| Performance benchmark | Required | No benchmark tests exist | Need implementation |\n| Code review | Required | No records | Need documentation |\n| Documentation | Required | README/migration notes missing | Need creation |\n\n### Files Implemented But NOT In Document:\n\n| File | Lines | Purpose |\n|------|-------|---------|\n| truncate_links.py | 134 | URL display truncation |\n| math_extract.py | 337 | MathJax preprocessing |\n| dollar_escape.py | 42 | Escaped dollar handling |\n| test_markdown_mathjax.py | 385 | MathJax tests |\n| test_markdown_truncate_links_plugin.py | 260 | Truncation tests |\n\n### Summary:\n\nDocument served as solid implementation guide. Actual implementation:\n- EXCEEDED test coverage expectations (4.3x lines)\n- IMPROVED test quality (BeautifulSoup validation)\n- ADDED features not anticipated (truncate_links, full MathJax preprocessing)\n- MISSING documentation deliverables (README, migration notes)\n- MISSING exit criteria artifacts (benchmarks, manual test docs, review docs)","created_at":"2026-01-10T21:02:14Z"}]}
{"id":"askbot-master-d71","title":"Editor help panel - UI infrastructure (Phase 1)","description":"Implement the foundational UI for a StackOverflow-style help panel in the markdown editor using Svelte 4.0.5.\n\n## Requirements\n- Help icon button right-aligned in the editor button bar\n- Clicking the help icon toggles a collapsible panel open/closed\n- Panel appears below the button bar and above the textarea\n- Use Svelte 4.0.5 (same as livesettings widget)\n\n## Styling Guidelines (MUST FOLLOW)\nReuse existing CSS variables and classes from askbot/media/sass/:\n\n**Button**: Use `--wmd-button-size` (1.5rem), `--wmd-button-color`, `--wmd-button-hover-bg`, `--wmd-button-hover-color`\n**Panel**: Use `--info-box-bg`, `--info-box-border`, `--info-box-padding` or `--editor-border`\n**Spacing**: Use `--wmd-button-margin` (0.125rem), standard `0.5rem`/`0.75rem` padding\n**Transitions**: Use `--transition-params` for animations\n\nReference files:\n- askbot/media/sass/variables.scss (all CSS variables)\n- askbot/media/sass/components/editors/wmd.scss (button patterns)\n- askbot/media/sass/components/info_box.scss (panel pattern)\n\n## Implementation\n- Create new directory: `askbot/media/wmd/help-panel/src/`\n- Set up Rollup build (copy pattern from `askbot_site/static/livesettings/js/src/`)\n- Create components: EditorHelpPanel.svelte, HelpButton.svelte, HelpPanel.svelte\n- Create stores: settings.js, panel.js\n- Modify `askbot/media/wmd/wmd.js` (~line 1206) to mount the Svelte component\n- Remove `{% include \"editors/wmd_help.html\" %}` from `askbot/jinja2/editors/rich_text.html`\n- Add script include in `askbot/jinja2/meta/markdown_javascript.html`\n\n## Acceptance Criteria\n- [ ] Help icon appears right-aligned in button bar\n- [ ] Click toggles panel visibility\n- [ ] Panel has placeholder content\n- [ ] Build produces `editor_help_panel.js`\n- [ ] Styling uses existing CSS variables (no hardcoded colors/sizes)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T19:09:32.23264-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-12T19:43:31.302458-03:00","closed_at":"2026-01-12T19:43:31.302458-03:00","close_reason":"Closed","comments":[{"id":79,"issue_id":"askbot-master-d71","author":"Evgeny Fadeev","text":"Implementation complete. Created Svelte-based help panel with:\n\n**New files:**\n- `askbot/media/wmd/help-panel/src/` - Svelte source files (package.json, rollup.config.mjs, panel.js, settings.js, HelpButton.svelte, HelpPanel.svelte, EditorHelpPanel.svelte)\n- `askbot/media/wmd/help-panel/editor_help_panel.js` - Compiled output\n\n**Modified files:**\n- `askbot/media/wmd/wmd.js` - Added Svelte component mounting after button bar\n- `askbot/media/js/editors/wmd.js` - Removed old wmd_help template usage\n- `askbot/jinja2/meta/markdown_javascript.html` - Added script include\n- `askbot/jinja2/editors/rich_text.html` - Removed old wmd_help.html include\n- `askbot/jinja2/question/index.html` - Removed old wmd_help.html from js_templates\n\n**Acceptance criteria met:**\n- Help icon right-aligned in button bar (margin-left: auto)\n- Click toggles panel visibility (Svelte store)\n- Panel has placeholder content\n- Build produces editor_help_panel.js\n- Uses CSS variables (--info-box-*, --wmd-button-*, --transition-params)","created_at":"2026-01-12T22:43:38Z"}]}
{"id":"askbot-master-e6b","title":"Create bd issue for frontend testing (rough outline)","description":"⚠️ LEAVE AS ROUGH OUTLINE - detail after frontend implementation.\n\nSplit from original Phase 3 - frontend testing only.\n\nRough scope:\n- Visual regression testing (BackstopJS or Playwright)\n- Preview vs saved content parity\n- JavaScript test suite\n- Cross-browser testing\n\nTo be planned in detail AFTER:\n1. Backend is complete and tested\n2. Frontend implementation is complete\n\n---\nThis is a placeholder to capture the scope. Do not detail until prerequisites met.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T20:36:58.331307-03:00","created_by":"devop","updated_at":"2026-01-10T22:08:37.778918-03:00","closed_at":"2026-01-10T22:08:37.778918-03:00","close_reason":"tbd later","dependencies":[{"issue_id":"askbot-master-e6b","depends_on_id":"askbot-master-ig7","type":"blocks","created_at":"2026-01-10T20:39:26.158653-03:00","created_by":"devop"}]}
{"id":"askbot-master-e9i","title":"Audit task file: MD-summary.md","description":"Analyze tasks/MD-summary.md - Status summary with open questions. Document unresolved questions.","notes":"## Audit Instructions\n\n**Before starting:**\n1. Read `tasks/markdown-upgrade-status.md` to understand the document structure and current state\n\n**When completing this audit:**\n1. **Add findings to this bd issue** using `bd comments add \u003cissue-id\u003e` with key observations\n2. **Edit ONLY your relevant section** in `tasks/markdown-upgrade-status.md` - do NOT overwrite the entire file\n3. **Reference this issue ID** (e.g., `askbot-master-xxx`) in the status file where you add findings\n4. **Update the Audit Trail table** at the bottom - change your row status from `pending` to `done`\n5. When complete, close this issue with `bd close \u003cissue-id\u003e`\n\n**Important:** Use the Edit tool to modify specific sections. Do not use Write to replace the whole file.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:16:53.289234-03:00","created_by":"devop","updated_at":"2026-01-10T20:02:39.767547-03:00","closed_at":"2026-01-10T20:02:39.767547-03:00","close_reason":"Closed","labels":["audit","task-file"],"dependencies":[{"issue_id":"askbot-master-e9i","depends_on_id":"askbot-master-8nq","type":"blocks","created_at":"2026-01-10T14:25:12.572239-03:00","created_by":"devop"}],"comments":[{"id":35,"issue_id":"askbot-master-e9i","author":"devop","text":"## Audit Findings for MD-summary.md\n\n### Document Purpose\nStatus summary document listing markdown features and open questions.\n\n### Feature List (lines 4-15) - VERIFIED ACCURATE\nAll listed features are confirmed working per status document:\n- ✅ tables, footnotes, task lists, fenced code blocks\n- ✅ video_embed plugin (YouTube/Vimeo/Dailymotion)\n- ✅ link_patterns plugin\n- ✅ code-friendly mode (though has known emphasis bug - askbot-master-6nm)\n- ✅ mathjax with $ delimiters (v2 implementation COMMIT-READY)\n\n### Open Questions Resolution\n\n**Q1: MathJax TODO / plugin ordering** (lines 17-22)\n**STATUS: ✅ RESOLVED**\n\nThe TODO mentioned is from v1 plugin approach. v2 preprocessing approach is implemented with explicit 7-phase ordering:\n1. protect_code_dollars() - Replace $ with ~D in code spans\n2. extract_math() - Extract math to @@N@@ tokens\n3. escape_dollars() - Convert \\$ → \u0026dollar;\n4. md.render() - Standard markdown\n5. restore_code_dollars() - ~D → $ in code spans\n6. restore_math() - @@N@@ → original math\n7. sanitize_html() - XSS protection\n\nTests: 35/35 pass, 2 skipped for documented edge cases.\n\n**Q2: Pygments vs frontend highlighting** (lines 24-25)\n**STATUS: ⚠️ UNRESOLVED - Phase 2 issue**\n\nStatus doc Section 3.1 identifies this as HIGH severity:\n| Backend (Pygments) | Frontend (highlight.js) |\n|--------------------|-------------------------|\n| `\u003cdiv class=\"highlight\"\u003e` | `\u003cpre\u003e\u003ccode class=\"hljs\"\u003e` |\n| CSS: `.highlight .k` | CSS: `.hljs-keyword` |\n\n**Impact:** Preview styling won't match saved content.\n**Resolution:** Requires Phase 2 decision - use compatible highlighter or accept difference.\n\n**Q3: Code blocks protected from markdown?** (lines 27-28)\n**STATUS: ✅ RESOLVED**\n\nConfirmed protected:\n- Code spans (backticks) - protect_code_dollars() handles\n- Fenced code blocks - markdown-it core behavior\n- Status doc Section 1.2: \"URLs in backticks and fenced blocks not linkified\"\n- Status doc Section 2.1: \"Code span AND fenced code blocks protected\"\n\n### Minor Issues\n- Line 8 typo: \"impolemented\" → \"implemented\"\n- Line 18: Empty bullet point (incomplete thought)\n- @mentions interference concern (lines 9, 12) not addressed in status doc\n\n### Recommendation\nDocument is HISTORICAL NOTES - can be archived. Open questions either resolved or captured in status doc Open Questions section (Q2 relates to Open Question #11).","created_at":"2026-01-10T22:54:47Z"},{"id":36,"issue_id":"askbot-master-e9i","author":"devop","text":"## UPDATED Audit Findings - Deep Analysis\n\n### CRITICAL FINDINGS ADDED:\n\n#### 1. STALE TODOs in markup.py (Previously Missed)\n\n| Line | TODO Text | Status |\n|------|-----------|--------|\n| 150 | \"TODO: Implement math delimiter protection plugin\" | STALE - implemented via preprocessing in `markdown_input_converter()` at lines 299-349, not as plugin |\n| 142 | \"TODO: Add custom rule to re-enable * only if needed\" | OPEN - known code-friendly bug (askbot-master-6nm) |\n\nThe get_md_converter() TODO at line 150 with `pass` statement is MISLEADING - suggests math protection not implemented, when it actually IS implemented in markdown_input_converter().\n\n**Recommended Action:** Remove/update stale TODO at line 150.\n\n#### 2. TEST ARCHITECTURE ISSUE - MathJax Tests Use Wrong Function\n\n**test_markdown_integration.py lines 162-215:**\n```python\nmd = get_md_converter()\nhtml = md.render(text)  # WRONG - bypasses MathJax preprocessing!\n```\n\n**Production flow (`markdown_input_converter`):**\n1. protect_code_dollars()\n2. extract_math() \n3. escape_dollars()\n4. md.render()  ← tests ONLY test this step\n5. restore_code_dollars()\n6. restore_math()\n7. sanitize_html()\n\n**Impact:** These tests pass because `md.disable('emphasis')` is a crude workaround, NOT because proper math extraction works. They're testing an INCOMPLETE pipeline.\n\n**test_markdown_mathjax.py correctly uses `markdown_input_converter()`** - so proper tests exist, but integration file has wrong tests.\n\n**Recommended Action:** Either remove misleading MathJax tests from test_markdown_integration.py OR change them to use `markdown_input_converter()`.\n\n#### 3. MISSING TESTS - Leading/Trailing Underscores\n\nMD-summary.md line 14 explicitly says: \"(test leading and trailing underscores)\"\n\n**Current test coverage:**\n| Test Case | Status |\n|-----------|--------|\n| `variable_name` (middle) | ✅ Tested |\n| `_leading` | ❌ NOT TESTED |\n| `trailing_` | ❌ NOT TESTED |\n| `_both_` | ❌ NOT TESTED |\n\n**Recommended Action:** Add tests for leading/trailing underscore cases.\n\n#### 4. @mentions vs Video Embed - Clarification\n\nMD-summary.md concern: \"@[youtube] might interfere with @mentions\"\n\n**Analysis:** NOT a problem because:\n1. Video embed converts `@[youtube](id)` → `\u003ciframe\u003e` during markdown conversion\n2. `mentionize_text()` runs AFTER on the HTML output (post.py:536)\n3. No `@` remains to trigger mention detection\n\n**BUT:** No explicit test verifies this behavior.\n\n**Recommended Action:** Add test confirming video embeds don't trigger @mention processing.\n\n#### 5. Incomplete Question in Document\n\nLine 18 has empty bullet point:\n```\n*\nIn the markdown converter...\n```\nThis appears to be an incomplete thought or formatting error.\n\n---\n\n### REVISED Question Resolution\n\n| Question | Status | Resolution |\n|----------|--------|------------|\n| Q1: MathJax TODO / ordering | ⚠️ PARTIALLY RESOLVED | Implementation complete in `markdown_input_converter()`, but STALE TODO remains in `get_md_converter()` causing confusion. Integration tests use wrong function. |\n| Q2: Pygments vs frontend | ⚠️ UNRESOLVED | Phase 2 issue - output format mismatch documented |\n| Q3: Code blocks protected? | ✅ RESOLVED | Verified working |\n\n### Recommended Work Issues\n\n1. **HIGH:** Remove/update stale TODO at markup.py:150\n2. **MEDIUM:** Fix or remove misleading MathJax tests in test_markdown_integration.py (lines 162-215)\n3. **LOW:** Add leading/trailing underscore tests for code-friendly mode\n4. **LOW:** Add test confirming video embeds don't interfere with @mentions","created_at":"2026-01-10T22:58:49Z"}]}
{"id":"askbot-master-eb1","title":"Markdown converter must support legacy indented code blocks along with the fenced code blocks: is it possible to do this without conflicts?","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-25T19:25:57.763384-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-31T19:15:50.912272-03:00","closed_at":"2026-01-31T19:15:50.912272-03:00","close_reason":"Closed","comments":[{"id":92,"issue_id":"askbot-master-eb1","author":"Evgeny Fadeev","text":"## Investigation Results: YES - It's Feasible\n\nThe current markdown-it-py configuration using the `commonmark` preset **already supports both** indented and fenced code blocks simultaneously. No code changes are needed.\n\n### Verified Behavior\n\nBoth code block types render correctly side by side:\n- Indented code (4 spaces): renders as `\u003cpre\u003e\u003ccode\u003e...`\n- Fenced code (```python): renders as `\u003cpre\u003e\u003ccode class=\"language-python\"\u003e...` with Pygments highlighting\n\n### Key Differences\n\n| Feature | Indented Blocks | Fenced Blocks |\n|---------|-----------------|---------------|\n| Syntax highlighting | No (plain text) | Yes (Pygments) |\n| Language specification | Not possible | Yes (```python) |\n\n### MathJax Interaction\n\nWhen `ENABLE_MATHJAX=True`, math-like content (`$x^2$`) inside indented code blocks gets extracted then restored. This is fine because MathJax 2.x default config skips `\u003cpre\u003e` and `\u003ccode\u003e` tags.\n\n### Option to Disable Indented Blocks\n\nIf needed, indented blocks can be disabled while keeping fenced blocks:\n```python\nmd.disable('code')  # In get_md_converter()\n```\n\n### Conclusion\n\nNo changes needed - legacy indented code blocks will continue working alongside fenced code blocks.\n\nTo be continued tomorrow.","created_at":"2026-01-26T00:55:53Z"},{"id":106,"issue_id":"askbot-master-eb1","author":"Evgeny Fadeev","text":"## Checkpoint: 2026-01-31 (Session 1)\n\n### Work Completed\n- Investigated why indented code blocks (4-space) don't get language auto-detection while fenced blocks do\n- Root cause identified: markdown-it-py's `code_block` renderer never calls the highlight callback (only `fence` renderer does)\n- Added test case `test_syntax_highlighting_indented_code_block_autodetect` in `askbot/tests/test_markdown_integration.py`\n- Implemented fix in `askbot/utils/markup.py`: custom renderer rule `render_code_block_with_highlight` that routes indented code blocks through the same `highlight_code` callback\n- All 24 markdown integration tests pass\n\n### Decisions Made\n- Chose custom renderer approach over alternatives (token transformation, post-processing HTML) as it's the lightest touch\n- The highlighting logic is already shared in `highlight_code()` - the fix just adds missing wiring for indented blocks\n\n### Next Steps\n- Transfer the solution to the frontend (JavaScript) - same issue exists in preview rendering\n- Frontend uses markdown-it.js which has the same behavior (highlight callback only for fenced blocks)\n","created_at":"2026-01-31T22:10:08Z"},{"id":107,"issue_id":"askbot-master-eb1","author":"Evgeny Fadeev","text":"## Completed: Syntax highlighting for indented code blocks\n\nAdded language auto-detection for indented (4-space) code blocks in both backend and frontend markdown rendering.\n\n### Problem\nmarkdown-it (JS) and markdown-it-py (Python) only call the highlight callback for fenced code blocks (```). Indented code blocks were rendered as plain text without syntax highlighting.\n\n### Solution\nOverride the `code_block` renderer rule to call the highlight callback, enabling auto-detection via highlight.js/Pygments.\n\n### Backend (Python)\n- `askbot/utils/markup.py`: Add `render_code_block_with_highlight()` custom renderer that routes indented blocks through `highlight_code()` callback\n\n### Frontend (JavaScript)\n- `askbot/media/wmd/askbot_converter.js`: Add `md.renderer.rules.code_block` custom renderer that calls `options.highlight()` for indented blocks\n\n### Tests\n- `askbot/tests/test_markdown_integration.py`: Add test case `test_syntax_highlighting_indented_code_block_autodetect`\n\nBoth fenced and indented code blocks now get consistent syntax highlighting with language auto-detection when no language is specified.\n\nAll 24 markdown integration tests pass.","created_at":"2026-01-31T22:15:44Z"}]}
{"id":"askbot-master-ect","title":"Upgrade highlight.js to the latest version","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-28T10:46:35.40064-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-28T15:40:37.966032-03:00","closed_at":"2026-01-28T15:40:37.966032-03:00","close_reason":"Closed","comments":[{"id":100,"issue_id":"askbot-master-ect","author":"Evgeny Fadeev","text":"Session summary:\n\n1. Copied highlight.js v11.11.1 default theme CSS to askbot/media/sass/components/highlight.min.css\n\n2. Updated askbot/media/sass/components/_pygments-compat.scss to match the new highlight.js v11.11.1 default theme colors for frontend/backend parity:\n   - Background: #f8f8f8 → #F3F3F3\n   - Base color: #333 → #444\n   - Comments: #888 → #697070\n   - Keywords: #008 blue bold → #444 bold\n   - Strings/Numbers: #b22 → #880000\n   - Functions: #00a bold → #880000 bold\n   - Operators: #666 → #ab5656\n   - Literals: #080 → #695\n   - Built-ins: #007070 → #397300\n   - Meta: #606 → #1f7199\n\n3. Added comment to dependent issue askbot-master-esx noting the upgrade and that language detection algorithm may have changed.","created_at":"2026-01-28T18:40:20Z"}]}
{"id":"askbot-master-esx","title":"Port highlight.js language detection algorithm to Python for backend syntax highlighting","description":"# Plan: Backend Syntax Highlighting with Ported highlight.js Detection\n\n## Goal\nAdd server-side syntax highlighting with language auto-detection that uses the **same algorithm as highlight.js**, ported to Python.\n\n## Approach: Port highlight.js Detection to Python\n\nPort the highlight.js `highlightAuto()` algorithm to Python, using Pygments for the actual highlighting. This gives us:\n- Same detection logic as client-side highlight.js\n- No Node.js dependency\n- Pure Python solution\n\n## Current State\n\n**Backend markdown processing:**\n- Library: **markdown-it-py** (recently upgraded from markdown2)\n- Location: `askbot/utils/markup.py`\n- Current: Pygments `guess_lexer()` as fallback (different algorithm than highlight.js)\n- Client-side uses highlight.js v11.3.1\n\n**Key files:**\n| File | Purpose |\n|------|---------|\n| `askbot/utils/markup.py` | Core markdown-to-HTML conversion |\n| `askbot/media/jslib/highlight/es/core.js` | Unobfuscated highlight.js source |\n| `askbot/media/jslib/highlight/es/languages/*.min.js` | Language definitions |\n\n## highlight.js Detection Algorithm (from core.js lines 2214-2251)\n\n```\nhighlightAuto(code, languageSubset):\n    1. For each language in languageSubset (or all languages):\n       - Run _highlight(language, code) to parse code\n       - Accumulate relevance score from:\n         * Keyword matches (each keyword has score, default 1)\n         * Mode matches (strings, comments, etc. have relevance)\n         * Cap at MAX_KEYWORD_HITS (7) per keyword\n       - If \"illegal\" pattern matches → disqualify language\n\n    2. Sort results by relevance (descending)\n\n    3. Handle superset relationships (e.g., C++ beats C on tie)\n\n    4. Return best match with language name and relevance score\n```\n\n## Implementation Plan\n\n### Step 1: Create Python Language Definitions Module\n\n**File:** `askbot/utils/hljs_languages.py` (new)\n\nConvert highlight.js language definitions to Python dictionaries. Focus on common languages first:\n- Python, JavaScript, Java, C/C++, SQL, Bash, HTML, CSS, JSON, XML\n\nStructure:\n```python\nLANGUAGES = {\n    'python': {\n        'name': 'Python',\n        'aliases': ['py', 'gyp'],\n        'keywords': {\n            'keyword': ['and', 'as', 'assert', 'async', 'await', 'break', ...],\n            'built_in': ['__import__', 'abs', 'all', 'any', ...],\n            'literal': ['True', 'False', 'None', ...],\n        },\n        'illegal': r'(\u003c\\/|-\u003e|\\?)|=\u003e',  # Patterns that disqualify\n        'case_insensitive': False,\n        # Modes define patterns with relevance scores\n        'modes': [\n            {'name': 'string', 'begin': r\"'''\", 'end': r\"'''\", 'relevance': 10},\n            {'name': 'string', 'begin': r'\"\"\"', 'end': r'\"\"\"', 'relevance': 10},\n            {'name': 'comment', 'begin': r'#', 'end': r'$', 'relevance': 0},\n            {'name': 'number', 'pattern': r'\\b\\d+(\\.\\d+)?\\b', 'relevance': 0},\n            ...\n        ],\n    },\n    'javascript': { ... },\n    ...\n}\n```\n\n### Step 2: Create Detection Engine\n\n**File:** `askbot/utils/hljs_detect.py` (new)\n\nPort the core detection algorithm:\n\n```python\nimport re\nfrom typing import Dict, List, Optional, Tuple\n\nMAX_KEYWORD_HITS = 7\n\ndef detect_language(code: str, languages: List[str] = None) -\u003e Tuple[str, int]:\n    \"\"\"\n    Detect language using highlight.js algorithm.\n\n    Returns: (language_name, relevance_score)\n    \"\"\"\n    from .hljs_languages import LANGUAGES\n\n    if languages is None:\n        languages = list(LANGUAGES.keys())\n\n    results = []\n    for lang_name in languages:\n        if lang_name not in LANGUAGES:\n            continue\n        lang_def = LANGUAGES[lang_name]\n\n        # Check illegal patterns first\n        if 'illegal' in lang_def:\n            if re.search(lang_def['illegal'], code):\n                continue  # Disqualified\n\n        # Calculate relevance\n        relevance = calculate_relevance(code, lang_def)\n        results.append((lang_name, relevance))\n\n    if not results:\n        return (None, 0)\n\n    # Sort by relevance (descending)\n    results.sort(key=lambda x: x[1], reverse=True)\n    return results[0]\n\n\ndef calculate_relevance(code: str, lang_def: Dict) -\u003e int:\n    \"\"\"Calculate relevance score for code against a language definition.\"\"\"\n    relevance = 0\n    keyword_hits = {}\n\n    # Score keywords\n    keywords = lang_def.get('keywords', {})\n    case_insensitive = lang_def.get('case_insensitive', False)\n\n    # Extract words from code\n    words = re.findall(r'\\b\\w+\\b', code)\n    if case_insensitive:\n        words = [w.lower() for w in words]\n\n    for category, kw_list in keywords.items():\n        kw_set = set(kw.lower() if case_insensitive else kw for kw in kw_list)\n        for word in words:\n            if word in kw_set:\n                keyword_hits[word] = keyword_hits.get(word, 0) + 1\n                if keyword_hits[word] \u003c= MAX_KEYWORD_HITS:\n                    # Default relevance is 1 per keyword match\n                    relevance += 1\n\n    # Score modes (patterns)\n    for mode in lang_def.get('modes', []):\n        mode_relevance = mode.get('relevance', 1)\n        if mode_relevance == 0:\n            continue  # Skip zero-relevance modes\n\n        if 'pattern' in mode:\n            matches = re.findall(mode['pattern'], code)\n            relevance += len(matches) * mode_relevance\n        elif 'begin' in mode and 'end' in mode:\n            # Count paired patterns (strings, comments)\n            pattern = f\"{mode['begin']}.*?{mode['end']}\"\n            matches = re.findall(pattern, code, re.DOTALL)\n            relevance += len(matches) * mode_relevance\n\n    return relevance\n```\n\n### Step 3: Integrate with Existing highlight_code Function\n\n**File:** `askbot/utils/markup.py`\n\nModify `highlight_code()` to use the new detection:\n\n```python\nfrom askbot.utils.hljs_detect import detect_language\n\ndef highlight_code(code, lang, attrs):\n    \"\"\"Syntax highlighting with highlight.js-style auto-detection.\"\"\"\n    from html import escape\n\n    if not lang:\n        # Auto-detect using highlight.js algorithm\n        detected_lang, relevance = detect_language(code)\n        if detected_lang and relevance \u003e 0:\n            lang = detected_lang\n\n    if not lang:\n        return escape(code)\n\n    # Use Pygments for actual highlighting\n    try:\n        lexer = get_lexer_by_name(lang)\n        formatter = HtmlFormatter(nowrap=True, noclasses=False)\n        return pygments_highlight(code, lexer, formatter)\n    except ClassNotFound:\n        return escape(code)\n```\n\n### Step 4: Extract Language Definitions from highlight.js\n\nCreate a script to extract language definitions from the JS files:\n\n**File:** `scripts/extract_hljs_languages.py` (one-time use)\n\n```python\n\"\"\"Extract language definitions from highlight.js minified files.\"\"\"\nimport re\nimport json\nfrom pathlib import Path\n\ndef extract_keywords(js_content):\n    \"\"\"Extract keyword arrays from minified JS.\"\"\"\n    # Pattern to find keyword arrays\n    keyword_pattern = r'keyword:\\s*\\[(.*?)\\]'\n    # ... parsing logic\n```\n\nOr manually create definitions for the most common 10-15 languages.\n\n## Files to Create/Modify\n\n1. `askbot/utils/hljs_languages.py` - **New**: Language definitions (~500 lines for 15 languages)\n2. `askbot/utils/hljs_detect.py` - **New**: Detection engine (~100 lines)\n3. `askbot/utils/markup.py` - Modify `highlight_code()` (~10 lines changed)\n\n## Language Priority List\n\nFocus on these common languages first:\n1. Python\n2. JavaScript/TypeScript\n3. Java\n4. C/C++\n5. SQL\n6. Bash/Shell\n7. HTML\n8. CSS\n9. JSON\n10. XML\n11. PHP\n12. Ruby\n13. Go\n14. Rust\n15. YAML\n\n## Verification\n\n1. Create test cases with code samples from each supported language\n2. Compare detection results with client-side highlight.js\n3. Test edge cases:\n   - Mixed language snippets\n   - Short code samples (few lines)\n   - Code without distinctive keywords\n\n## Considerations\n\n- **Accuracy**: Should match JS version closely - regex syntax is nearly identical between JS and Python\n- **Maintenance**: Need to update Python definitions when highlight.js updates\n- **Performance**: Python detection should be fast (no subprocess)\n- **Fallback**: Use Pygments `guess_lexer()` for unsupported languages","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-28T10:43:56.858785-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-28T16:53:57.28402-03:00","closed_at":"2026-01-28T16:53:57.28402-03:00","close_reason":"Closed","dependencies":[{"issue_id":"askbot-master-esx","depends_on_id":"askbot-master-ect","type":"blocks","created_at":"2026-01-28T10:46:50.184764-03:00","created_by":"Evgeny Fadeev"}],"comments":[{"id":97,"issue_id":"askbot-master-esx","author":"Evgeny Fadeev","text":"## Checkpoint: 2026-01-28 10:44\n\n### Work Completed\n- Explored askbot codebase to understand current markdown/highlighting setup\n- Found unobfuscated highlight.js source in `askbot/media/jslib/highlight/es/core.js`\n- Analyzed highlight.js `highlightAuto()` detection algorithm (lines 2214-2251)\n- Created implementation plan for porting detection to Python\n\n### Algorithm Analysis\nThe highlight.js detection algorithm works as follows:\n1. For each candidate language, run `_highlight(language, code)` to parse code\n2. Accumulate relevance score from:\n   - Keyword matches (each keyword has score, default 1)\n   - Mode matches (strings, comments, etc. have relevance)\n   - Cap at MAX_KEYWORD_HITS (7) per keyword\n3. If \"illegal\" pattern matches → disqualify language\n4. Sort by relevance (descending), handle superset relationships\n5. Return best match\n\n### Decisions Made\n- **Approach**: Port highlight.js detection to Python (not use Node.js subprocess)\n- **Highlighting**: Use Pygments for actual syntax highlighting after detection\n- **Regex**: JS regex can be ported directly to Python with minor syntax adjustments\n\n### Implementation Plan\n1. Create `askbot/utils/hljs_languages.py` - Language definitions (~500 lines for 15 languages)\n2. Create `askbot/utils/hljs_detect.py` - Detection engine (~100 lines)\n3. Modify `askbot/utils/markup.py` - Use new detection in `highlight_code()`\n\n### Language Priority\nPython, JavaScript, Java, C/C++, SQL, Bash, HTML, CSS, JSON, XML, PHP, Ruby, Go, Rust, YAML\n\n### Next Steps\n- Extract/convert language definitions from highlight.js JS files to Python dicts\n- Implement `detect_language()` function with relevance scoring\n- Integrate with existing `highlight_code()` in markup.py\n- Create test cases comparing Python detection with JS highlight.js results\n\n### References\n- Plan file: `~/.claude/plans/quirky-imagining-lantern.md`\n- highlight.js source: `askbot/media/jslib/highlight/es/core.js`\n","created_at":"2026-01-28T13:44:43Z"},{"id":98,"issue_id":"askbot-master-esx","author":"Evgeny Fadeev","text":"Re-plan this work as highlight.js was upgraded - and the lang detection algorithm might be different","created_at":"2026-01-28T13:46:22Z"},{"id":99,"issue_id":"askbot-master-esx","author":"Evgeny Fadeev","text":"highlight.js has been upgraded from v11.3.1 to v11.11.1 (issue askbot-master-ect). The Pygments compatibility styles (_pygments-compat.scss) were also updated to match the new default theme colors for frontend/backend parity.\n\nNote: The language auto-detection algorithm may have changed between these versions. The plan for this issue may need to be revisited to account for any differences in how highlight.js detects languages in v11.11.1.","created_at":"2026-01-28T18:12:44Z"},{"id":101,"issue_id":"askbot-master-esx","author":"Evgeny Fadeev","text":"## Algorithm Analysis: v11.3.1 vs v11.11.1\n\nAnalyzed the upgraded highlight.js source (v11.11.1) in `askbot/media/jslib/highlight/es/core.js`. **No significant differences** found in the language detection algorithm compared to the documented v11.3.1 algorithm.\n\nThe core `highlightAuto()` mechanism remains unchanged:\n\n| Aspect | Status |\n|--------|--------|\n| Relevance scoring | Same - keywords contribute +1 each |\n| MAX_KEYWORD_HITS cap | Same - 7 hits per keyword |\n| COMMON_KEYWORDS (zero score) | Same list: 'of', 'and', 'for', 'in', 'not', 'or', 'if', 'then', 'parent', 'list', 'value' |\n| Superset tie-breaking | Same - base language wins on tie |\n| Plaintext fallback | Same - always included |\n| Illegal pattern disqualification | Same - NOT used during auto-detection |\n\nAlgorithm location shifted slightly (now lines 2235-2272 vs previously 2214-2251), but the logic is identical. The original implementation plan remains valid.","created_at":"2026-01-28T18:47:46Z"},{"id":102,"issue_id":"askbot-master-esx","author":"Evgeny Fadeev","text":"## Final Implementation Plan\n\n### Goal\nPort highlight.js language detection algorithm to Python for consistent backend/frontend syntax highlighting.\n\n### Algorithm (from core.js v11.11.1 analysis)\n1. For each language, accumulate relevance score\n2. Keyword matches: +1 each (capped at MAX_KEYWORD_HITS=7)\n3. COMMON_KEYWORDS ('of', 'and', 'for', etc.): score = 0\n4. Mode matches (strings, comments): add mode's relevance\n5. Sort by relevance, tie-break with superset relationships\n\n### Implementation Steps\n\n**Step 1: Create JS-to-Python Extraction Script**\n- File: `scripts/extract_hljs_languages.py` (~200 lines)\n- Parses `askbot/media/jslib/highlight/es/languages/*.min.js`\n- Extracts: keywords, aliases, case sensitivity, superset relationships, mode patterns\n- Generates `askbot/utils/hljs_languages.py`\n\n**Step 2: Generated Language Definitions**\n- File: `askbot/utils/hljs_languages.py` (generated, ~600+ lines)\n- Contains LANGUAGES dict, COMMON_KEYWORDS set, SUPERSETS dict\n\n**Step 3: Create Detection Engine**\n- File: `askbot/utils/hljs_detect.py` (~150 lines)\n- `detect_language(code)` returns (language, relevance_score)\n\n**Step 4: Integrate with markup.py**\n- Modify `highlight_code()` to use new detection\n- Remove Pygments `guess_lexer()` fallback\n\n**Step 5: Add Tests**\n- File: `askbot/tests/test_hljs_detect.py`\n- Test Python, JS, SQL, Bash, HTML detection + superset tie-breaking\n\n### Priority Languages\nPython, JavaScript, Java, C/C++, SQL, Bash, HTML/XML, CSS, JSON, Go, Ruby, PHP, Rust, TypeScript, YAML\n\n### Files Summary\n| File | Action |\n|------|--------|\n| `scripts/extract_hljs_languages.py` | Create |\n| `askbot/utils/hljs_languages.py` | Generated |\n| `askbot/utils/hljs_detect.py` | Create |\n| `askbot/utils/markup.py` | Modify |\n| `askbot/tests/test_hljs_detect.py` | Create |\n\n### Notes\n- Extraction script ensures accuracy and easy updates when highlight.js upgrades\n- No illegal pattern disqualification in v11.11.1 (confirmed)","created_at":"2026-01-28T18:54:01Z"},{"id":103,"issue_id":"askbot-master-esx","author":"Evgeny Fadeev","text":"## Checkpoint: 2026-01-28\n\n### Work Completed\n- Created `scripts/extract_hljs_languages.py` - extraction script to parse highlight.js language definitions\n- Generated `askbot/utils/hljs_languages.py` - Python module with language definitions (16 priority languages)\n- Created `askbot/utils/hljs_detect.py` - detection engine implementing highlight.js relevance scoring algorithm\n- Integrated detection into `askbot/utils/markup.py` - auto-detects language when none specified\n- Created `askbot/tests/test_hljs_detect.py` - 26 unit tests (all passing)\n- Removed Pygments `guess_lexer()` fallback for consistent frontend/backend detection\n\n### Questions Raised\n- The extraction script was parsing **minified** `.min.js` files, which didn't work well for all languages\n- Had to manually patch `hljs_languages.py` to fill in missing keywords (JavaScript, JSON, YAML, XML, Java)\n- This breaks the plan's intent of having a fully auto-generated file\n\n### Decisions Made\n- Cloned highlight.js source repo to `~/other-prog/highlightjs` for access to clean, unminified source files\n- Will rewrite extraction script to parse clean source from `~/other-prog/highlightjs/src/languages/*.js`\n- Version confirmed: highlight.js 11.11.1 (matches what's in askbot)\n\n### Next Steps\n1. **Rewrite** `scripts/extract_hljs_languages.py` to parse clean source files (not minified)\n2. **Regenerate** `askbot/utils/hljs_languages.py` (fully auto-generated, no manual edits)\n3. The detection engine, integration, and tests remain unchanged - only the language spec generation needs fixing\n","created_at":"2026-01-28T19:22:54Z"},{"id":104,"issue_id":"askbot-master-esx","author":"Evgeny Fadeev","text":"## Implementation Complete\n\n### Summary\nPorted highlight.js language detection algorithm to Python for consistent backend/frontend syntax highlighting.\n\n### Files Created/Modified\n\n| File | Action | Description |\n|------|--------|-------------|\n| `scripts/extract_hljs_languages.py` | Created | Extraction script that parses clean highlight.js source files from `~/other-prog/highlightjs/src/languages/*.js` |\n| `askbot/utils/hljs_languages.py` | Generated | Python module with 16 language definitions (fully auto-generated, no manual edits) |\n| `askbot/utils/hljs_detect.py` | Created | Detection engine implementing highlight.js relevance scoring algorithm |\n| `askbot/utils/markup.py` | Modified | Integrated auto-detection when no language specified |\n| `askbot/tests/test_hljs_detect.py` | Created | 26 unit tests (all passing) |\n| `askbot/media/wmd/askbot_converter.js` | Modified | Added `hljs.highlightAuto()` for frontend parity |\n\n### Languages Supported (16)\nPython, JavaScript, Java, C, C++, SQL, Bash, XML/HTML, CSS, JSON, Go, Ruby, PHP, Rust, TypeScript, YAML\n\n### Algorithm\n- Keyword matches: +1 each (capped at MAX_KEYWORD_HITS=7)\n- COMMON_KEYWORDS ('of', 'and', 'for', etc.): score = 0\n- Superset tie-breaking (e.g., TypeScript vs JavaScript)\n\n### Verification\n- All 26 unit tests pass\n- Manual testing confirms detection works for Python, JavaScript, SQL, Rust, Go\n- Frontend and backend now both auto-detect languages","created_at":"2026-01-28T19:53:45Z"}]}
{"id":"askbot-master-frb","title":"Editor help panel - Tabbed interface and content (Phase 2)","description":"Add tabbed navigation and help content to the editor help panel.\n\n## Requirements\n- Tab bar with sections: Links, Images, Styling, Lists, Blockquotes, Code, HTML, Tables\n- Conditional tabs based on settings:\n  - Video tab (when ENABLE_VIDEO_EMBEDDING)\n  - Math tab (when ENABLE_MATHJAX)\n  - Auto-link tab (when ENABLE_AUTO_LINKING)\n  - Images tab (when userCanUploadImage)\n- Clicking a tab shows its help content\n- Content must document our actual markdown syntax\n\n## Styling Guidelines (MUST FOLLOW)\nReuse existing CSS variables and classes from askbot/media/sass/:\n\n**Tab buttons**: Use `.action-link` pattern with `--action-link-color`, `--action-link-hover-color`\n**Active tab**: Use `--link-color` or `--clr-blue-65` for underline/highlight\n**Tab bar border**: Use `--border-width`, `--border-style`, `--editor-border-color`\n**Content area**: Use `--info-box-padding` (0.5rem 0.75rem)\n**Typography**: Use `--small-font-size` (0.875rem), `--font-weight-bold` for headings\n**Code examples**: Use monospace font, `--clr-neutral-95` background\n**Spacing**: Use standard `0.25rem`/`0.5rem`/`0.75rem` increments\n\nReference files:\n- askbot/media/sass/variables.scss\n- askbot/media/sass/components/action_link.scss (tab button pattern)\n- askbot/media/sass/colors.scss (color palette)\n\n## Implementation\n- Create components: TabBar.svelte, TabButton.svelte, HelpContent.svelte\n- Create tab content files: LinksHelp.svelte, ImagesHelp.svelte, StylingHelp.svelte, ListsHelp.svelte, BlockquotesHelp.svelte, CodeHelp.svelte, HtmlHelp.svelte, TablesHelp.svelte, VideoHelp.svelte, MathHelp.svelte, AutoLinkHelp.svelte\n- Settings store derives visible tabs from askbot.settings\n\n## Acceptance Criteria\n- [ ] All tabs render with correct content\n- [ ] Tab switching works\n- [ ] Conditional tabs appear/disappear based on settings\n- [ ] Help content accurately documents our markdown syntax\n- [ ] Styling uses existing CSS variables (no hardcoded colors/sizes)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T19:10:09.835796-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-12T20:16:17.43918-03:00","closed_at":"2026-01-12T20:16:17.43918-03:00","close_reason":"Closed","dependencies":[{"issue_id":"askbot-master-frb","depends_on_id":"askbot-master-d71","type":"blocks","created_at":"2026-01-12T19:11:02.586394-03:00","created_by":"Evgeny Fadeev"}]}
{"id":"askbot-master-frm","title":"re-enable setting ENABLE_VIDEO_EMBEDDING - I might have misspelled it though - this setting is commented out in askbot/conf, apply it in the backend and frontend markdown rendering to html/dom","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T13:45:56.984334-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-12T17:36:55.997089-03:00","closed_at":"2026-01-12T17:36:55.997089-03:00","close_reason":"Closed"}
{"id":"askbot-master-hpj","title":"Add integration test: verify math content protected from link patterns","description":"## Context\nThe MathJax v2 preprocessing implementation extracts math content to `@@N@@` tokens BEFORE markdown processing, then restores them after. This should protect math content from being processed by link patterns (e.g., `#bug123` auto-linking).\n\n## Task\nAdd an integration test to `askbot/tests/test_markdown_mathjax.py` that verifies link patterns inside math delimiters are NOT converted to links.\n\n## Test Requirements\n- Must use `markdown_input_converter()` (full pipeline), not `md.render()`\n- Must have `ENABLE_MATHJAX=True` and `ENABLE_AUTO_LINKING=True` settings active\n- Requires configured link patterns (e.g., `#(\\d+)` → issue link)\n\n## Test Cases\n```python\n@override_settings(...)  # Enable auto-linking with pattern\ndef test_link_pattern_inside_math_not_processed(self):\n    \"\"\"Link patterns inside math should not become links\"\"\"\n    # Assuming #123 is configured as a link pattern\n    text = \"Formula $x #123 y$ here\"\n    html = markdown_input_converter(text)\n    # #123 inside math should NOT become a link\n    assert '\u003ca ' not in html or '#123' not in html.split('\u003ca')[1].split('\u003c/a\u003e')[0]\n```\n\n## Acceptance Criteria\n- [ ] Test passes with current implementation (verifies protection works)\n- [ ] Test uses `markdown_input_converter()` for full pipeline coverage\n- [ ] Test properly configures link pattern settings\n- [ ] Test is added to `test_markdown_mathjax.py`\n\n## Related\n- Source: tasks/markdown-upgrade-status.md section 7\n- Link patterns plugin: askbot/utils/markdown_plugins/link_patterns.py\n- Pipeline: askbot/utils/markup.py `markdown_input_converter()`","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T21:38:49.117151-03:00","created_by":"devop","updated_at":"2026-01-11T13:47:25.350101-03:00","closed_at":"2026-01-11T13:47:25.350101-03:00","close_reason":"Closed","dependencies":[{"issue_id":"askbot-master-hpj","depends_on_id":"askbot-master-q54","type":"blocks","created_at":"2026-01-10T22:01:24.763466-03:00","created_by":"devop"}]}
{"id":"askbot-master-hsr","title":"All human readable text in the editor help panel must use django translation functions (gettext) and must be accessible for i18n pipeline","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T10:54:36.684187-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-19T19:28:34.873366-03:00","closed_at":"2026-01-19T19:28:34.873366-03:00","close_reason":"Closed","comments":[{"id":80,"issue_id":"askbot-master-hsr","author":"Evgeny Fadeev","text":"## Checkpoint: 2026-01-18 18:45\n\n### Work Completed\n- Modified `askbot/bin/rebuildlocales.py` to add `-e js,svelte` flag for djangojs extraction\n- Updated `askbot/media/wmd/help-panel/src/settings.js` - wrapped all 11 tab labels with `gettext()`\n- Updated all 11 Svelte tab components with `gettext()` for human-readable strings:\n  - LinksHelp.svelte, ImagesHelp.svelte, StylingHelp.svelte\n  - ListsHelp.svelte, BlockquotesHelp.svelte, CodeHelp.svelte\n  - HtmlHelp.svelte, TablesHelp.svelte, VideoHelp.svelte\n  - MathHelp.svelte, AutoLinkHelp.svelte\n- Updated `HelpButton.svelte` - wrapped `title` and `aria-label` attributes with `gettext()`\n- Rebuilt the help panel bundle (`editor_help_panel.js`)\n- Verified extraction works: 85 strings successfully extracted from Svelte files\n\n### Decisions Made\n- Use `gettext()` directly in Svelte files (same pattern as regular JS files) rather than injecting translations via Django templates\n- Configure Django's makemessages to scan `.svelte` files by adding `-e js,svelte` extension flag\n- The `xgettext` tool successfully extracts from Svelte when treated as JavaScript (warnings about HTML parsing are harmless)\n\n### Next Steps\n- Run full extraction with `rebuildlocales.py` to update all locale files\n- Manual testing: verify help panel displays correctly in browser\n- Translation test: add test translations and verify they appear in UI\n","created_at":"2026-01-18T21:59:06Z"},{"id":81,"issue_id":"askbot-master-hsr","author":"Evgeny Fadeev","text":"## Completed\n\n- Wrapped all human-readable strings in 11 Svelte tab components and HelpButton.svelte with `gettext()`\n- Updated `askbot/bin/rebuildlocales.py` to scan `.svelte` files with `-e js,svelte` flag\n- Added build scripts to `askbot/media/package.json`:\n  - `npm run build` - compiles sass and all Svelte components\n  - `npm run build:help-panel` - builds help panel bundle\n- Rebuilt `editor_help_panel.js` with translatable strings\n- Verified extraction works: 85 strings successfully extracted from Svelte files\n\nCommit: 8eca7317f","created_at":"2026-01-19T22:29:04Z"}]}
{"id":"askbot-master-ig7","title":"Create bd epic for frontend migration (rough outline)","description":"⚠️ REQUIRES INTERACTIVE SESSION: Review outline before creating.\n\nCreate a rough epic for Phase 2 frontend work. NOT detailed planning - just capture the scope.\n\nFrom tasks/markdown-upgrade-status.md section 3.1, critical gaps identified:\n- CRITICAL: Sanitization missing from proposed frontend code (XSS risk)\n- CRITICAL: MathJax processing mismatch (preview ≠ saved content)\n- CRITICAL: Missing truncate_links.js plugin\n- CRITICAL: Rollback strategy contradiction\n- HIGH: Syntax highlighting output mismatch (Pygments vs highlight.js)\n- HIGH: Escaped dollar handling missing (FOUC issue)\n\nThis epic should be LEFT ROUGH - detailed planning happens after backend is complete and tested.\n\n---\nBEFORE STARTING: Confirm rough scope with user.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T20:36:17.844979-03:00","created_by":"devop","updated_at":"2026-01-10T22:07:16.830136-03:00","closed_at":"2026-01-10T22:07:16.830136-03:00","close_reason":"Closed","dependencies":[{"issue_id":"askbot-master-ig7","depends_on_id":"askbot-master-zog","type":"blocks","created_at":"2026-01-10T20:39:00.275987-03:00","created_by":"devop"}]}
{"id":"askbot-master-jij","title":"Make embedded videos responsive in post view and preview","description":"## Problem\n\nEmbedded YouTube videos in posts are not responsive - they overflow their container on smaller screens and don't scale properly with the page layout.\n\nThis affects two areas:\n1. **Post view** - Videos in saved/rendered posts overflow their container\n2. **JS preview** - Videos in the live markdown preview (while editing) also overflow\n\n## Screenshots\n\nSee attached screenshots showing the video overflowing in both the post view and the preview pane.\n\n## Acceptance Criteria\n\n- [ ] Embedded videos maintain 16:9 aspect ratio\n- [ ] Videos scale down on smaller screens without overflowing\n- [ ] Videos have a max-width that fits within the content area\n- [ ] Works in both server-rendered post view and client-side JS preview\n- [ ] Solution works for YouTube embeds (primary use case)\n\n## Technical Notes\n\n- Video embeds are generated by the `video_embed.js` markdown-it plugin\n- CSS changes needed in `askbot/media/sass/style.scss` or related stylesheets\n- May need to wrap iframe in a responsive container div\n- Standard responsive video technique: wrapper with padding-bottom percentage + absolute positioned iframe\n\n## Files to Modify\n\n- `askbot/media/sass/style.scss` - Add responsive video CSS\n- `askbot/media/wmd/markdown-it/plugins/video_embed.js` - May need wrapper div in output\n- `askbot/media/wmd/askbot_converter.js` - Check if preview needs special handling","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T13:28:17.608584-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-12T17:50:25.929191-03:00","closed_at":"2026-01-12T17:50:25.929191-03:00","close_reason":"Closed"}
{"id":"askbot-master-jrw","title":"Audit commit 3: Added mathjax plans, updated markdown-upgrade plans","description":"Analyze commit 1e01ee226 - added plan tasks/upgrade-mathjax.md; updated the markdown-upgrade plans for latex support.","notes":"## Audit Instructions\n\n**Before starting:**\n1. Read `tasks/markdown-upgrade-status.md` to understand the document structure and current state\n\n**When completing this audit:**\n1. **Add findings to this bd issue** using `bd comments add \u003cissue-id\u003e` with key observations\n2. **Edit ONLY your relevant section** in `tasks/markdown-upgrade-status.md` - do NOT overwrite the entire file\n3. **Reference this issue ID** (e.g., `askbot-master-xxx`) in the status file where you add findings\n4. **Update the Audit Trail table** at the bottom - change your row status from `pending` to `done`\n5. When complete, close this issue with `bd close \u003cissue-id\u003e`\n\n**Important:** Use the Edit tool to modify specific sections. Do not use Write to replace the whole file.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:15:31.820389-03:00","created_by":"devop","updated_at":"2026-01-10T15:24:58.087709-03:00","closed_at":"2026-01-10T15:24:58.087709-03:00","close_reason":"Closed","labels":["audit","commit"],"dependencies":[{"issue_id":"askbot-master-jrw","depends_on_id":"askbot-master-u9s","type":"blocks","created_at":"2026-01-10T14:15:31.821131-03:00","created_by":"devop"},{"issue_id":"askbot-master-jrw","depends_on_id":"askbot-master-6zh","type":"blocks","created_at":"2026-01-10T14:22:30.913925-03:00","created_by":"devop"}],"comments":[{"id":37,"issue_id":"askbot-master-jrw","author":"devop","text":"## Audit Findings for Commit 1e01ee226\n\n### Summary\nDocumentation/planning commit adding MathJax upgrade plans and updating existing phase documents for LaTeX support integration.\n\n### Files Changed\n\n| File | Change Type | Description |\n|------|-------------|-------------|\n| `tasks/upgrade-mathjax.md` | **NEW** (357 lines) | MathJax v2 → v4 upgrade plan |\n| `tasks/markdown-mathjax-integration.md` | **NEW** (396 lines) | How markdown-it integrates with MathJax |\n| `tasks/markdown-upgrade-phase1-backend.md` | Modified | Added math delimiter protection task |\n| `tasks/markdown-upgrade-phase2-frontend.md` | Modified | Added frontend MathJax integration tasks |\n| `tasks/markdown-upgrade-phase3-testing.md` | Modified | Added MathJax testing requirements |\n\n### Key Planning Content\n\n**upgrade-mathjax.md:**\n- Upgrade from MathJax v2 (2012 Hub API) → v4 (2024)\n- Add CDN option (currently self-hosted only)\n- New settings: `MATHJAX_VERSION`, `MATHJAX_USE_CDN`, `MATHJAX_CDN_URL`\n- Backward compatibility with existing `MATHJAX_BASE_URL`\n\n**markdown-mathjax-integration.md:**\n- Documents \"separation of concerns\" - markdown parser preserves `$...$`, MathJax renders client-side\n- Problem: markdown processing breaks LaTeX (underscores → emphasis, asterisks → bold)\n- Solution: Two-part approach:\n  1. Code-friendly mode (disable emphasis)\n  2. Math delimiter protection plugin (treat `$...$` as verbatim)\n\n**Phase file updates:**\n- Added checkbox: \"Implement math delimiter protection (for MathJax)\"\n- Added code example for `get_md_converter()` math protection\n- Changed test examples from pytest to Django TestCase format\n\n### Observations\n\n1. **No code changes** - purely documentation/planning\n2. **Identifies the core problem** - markdown parsers mangle LaTeX syntax inside `$...$`\n3. **Two-prong solution planned** - code-friendly mode + math delimiter plugin\n4. **Test style change** - phase1 doc changed from pytest to Django TestCase (consistency with askbot's test framework)\n","created_at":"2026-01-10T18:23:50Z"}]}
{"id":"askbot-master-jvt","title":"Only suggest _ ... _ for italic only if code-friendly is disabled - for the styling section in the markdown editor help panel","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-25T16:53:37.039878-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-25T17:43:31.866777-03:00","closed_at":"2026-01-25T17:43:31.866777-03:00","close_reason":"Closed","comments":[{"id":84,"issue_id":"askbot-master-jvt","author":"Evgeny Fadeev","text":"Implemented conditional underscore hints in editor help panel:\n\n1. Updated settings.js - Added codeFriendlyEnabled: settings.markupCodeFriendly || false to read the code-friendly setting from askbot.settings namespace\n\n2. Updated StylingHelp.svelte - Imported settings store and wrapped both underscore hints in {#if \\!$settings.codeFriendlyEnabled} blocks\n\n3. Rebuilt editor_help_panel.js with the Svelte changes\n\nWhen code-friendly markdown is enabled, the 'Or use __bold text__' and 'Or use _italic text_' hints are hidden. When disabled (default), they are shown.","created_at":"2026-01-25T20:32:19Z"}]}
{"id":"askbot-master-l9a","title":"Upgrade highlight.js from 11.3.1 to 11.11.1","description":"## Goal\nUpgrade highlight.js syntax highlighter to the latest version.\n\n## Current State\n- Version: 11.3.1 (2021)\n- Location: `askbot/media/jslib/highlight.min.js`\n\n## Target\n- Version: 11.11.1 (Dec 2025)\n\n## Benefits\n- **Memory leak fixes** (11.11.0) - important for long editor sessions\n- **WCAG AA compliance** (11.4.0) - improved accessibility for syntax colors\n- **Grammar updates** - better highlighting for modern language features\n- **Performance improvements**\n\n## No Breaking Changes\nAll breaking changes in 11.x are Node.js version drops which don't affect browser usage.\n\n## Tasks\n1. Download highlight.min.js v11.11.1 from https://highlightjs.org/download\n2. Replace `askbot/media/jslib/highlight.min.js`\n3. Verify syntax highlighting works in question pages and editor preview\n4. Check no console errors\n\n## Acceptance Criteria\n- [ ] highlight.js upgraded to 11.11.1\n- [ ] Syntax highlighting works on question/answer pages\n- [ ] Editor preview highlighting works\n- [ ] No JavaScript console errors\n\n## Notes\nCan be done independently of the markdown-it migration (askbot-master-37j).","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-11T17:56:46.200913-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-11T20:28:11.602952-03:00","closed_at":"2026-01-11T20:28:11.602952-03:00","close_reason":"Closed","comments":[{"id":74,"issue_id":"askbot-master-l9a","author":"Evgeny Fadeev","text":"Upgraded highlight.js from 11.3.1 to 11.11.1. Downloaded from cdnjs CDN, replaced askbot/media/jslib/highlight.min.js, updated package.json version. All 23 markdown integration tests pass. Ready for manual verification of syntax highlighting in editor preview.","created_at":"2026-01-11T23:21:24Z"}]}
{"id":"askbot-master-lai","title":"Verify if help covers all the functionalities of the current markdown -\u003e html converter","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-13T11:03:15.827234-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-13T11:03:15.827234-03:00"}
{"id":"askbot-master-mdo","title":"Remove stale TODO comment at markup.py:150","description":"## Context\nAt `askbot/utils/markup.py:150` there is a TODO comment:\n\n```python\n# TODO: Implement math delimiter protection plugin\npass\n```\n\nThis is stale because math delimiter protection IS implemented, but via preprocessing in `markdown_input_converter()` (lines 299-349), not as a plugin.\n\n## Task\nRemove or update the stale TODO comment.\n\n## Options\n1. **Remove entirely**: Delete lines 146-151 (the if block with TODO and pass)\n2. **Update comment**: Change to explain that math protection is handled in `markdown_input_converter()` via preprocessing\n\n## Recommendation\nOption 1 (remove) is cleaner. The comment block at lines 144-145 can stay as documentation, but the TODO and empty `if` block should go.\n\n## File\n`askbot/utils/markup.py` lines 144-151\n\n## Acceptance Criteria\n- [ ] Stale TODO removed or updated\n- [ ] Code still functions correctly\n- [ ] Tests pass\n\n## Related\n- Source: tasks/markdown-upgrade-status.md section 5 (MD-summary.md audit)\n- Actual implementation: `markdown_input_converter()` lines 299-349","status":"closed","priority":4,"issue_type":"task","created_at":"2026-01-10T21:41:37.42902-03:00","created_by":"devop","updated_at":"2026-01-11T15:41:23.509175-03:00","closed_at":"2026-01-11T15:41:23.509175-03:00","close_reason":"Closed","dependencies":[{"issue_id":"askbot-master-mdo","depends_on_id":"askbot-master-q54","type":"blocks","created_at":"2026-01-10T22:01:25.219129-03:00","created_by":"devop"}],"comments":[{"id":63,"issue_id":"askbot-master-mdo","author":"Evgeny Fadeev","text":"Issue already resolved. The TODO at line 150 was removed in commit a52768f2e (Fix emphasis handling: asterisk-only for code-friendly mode). The math delimiter protection is now implemented via preprocessing in markdown_input_converter() as documented.","created_at":"2026-01-11T18:41:29Z"}]}
{"id":"askbot-master-mps","title":"Audit commit 10: Revert mathjax v1 implementation","description":"Analyze commit a40000d1c - Revert mathjax implementation (Python files only). Understand why v1 was reverted and what approach replaced it.","notes":"## Audit Instructions\n\n**Before starting:**\n1. Read `tasks/markdown-upgrade-status.md` to understand the document structure and current state\n\n**When completing this audit:**\n1. **Add findings to this bd issue** using `bd comments add \u003cissue-id\u003e` with key observations\n2. **Edit ONLY your relevant section** in `tasks/markdown-upgrade-status.md` - do NOT overwrite the entire file\n3. **Reference this issue ID** (e.g., `askbot-master-xxx`) in the status file where you add findings\n4. **Update the Audit Trail table** at the bottom - change your row status from `pending` to `done`\n5. When complete, close this issue with `bd close \u003cissue-id\u003e`\n\n**Important:** Use the Edit tool to modify specific sections. Do not use Write to replace the whole file.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:15:43.134394-03:00","created_by":"devop","updated_at":"2026-01-10T16:56:38.999954-03:00","closed_at":"2026-01-10T16:56:38.999954-03:00","close_reason":"Closed","labels":["audit","commit"],"dependencies":[{"issue_id":"askbot-master-mps","depends_on_id":"askbot-master-u9s","type":"blocks","created_at":"2026-01-10T14:15:43.135219-03:00","created_by":"devop"},{"issue_id":"askbot-master-mps","depends_on_id":"askbot-master-tk7","type":"blocks","created_at":"2026-01-10T14:22:31.442821-03:00","created_by":"devop"}],"comments":[{"id":38,"issue_id":"askbot-master-mps","author":"devop","text":"## Audit Findings - Commit a40000d1c\n\n### Summary\nClean revert of MathJax v1 plugin implementation (Python files only). The v2 plan document was preserved.\n\n### Files Changed\n| File | Change | Lines |\n|------|--------|-------|\n| `math_protect.py` | Deleted | -251 |\n| `test_markdown_math_plugin.py` | Deleted | -590 |\n| `markup.py` | Reverted | +13/-27 |\n\n**Total:** -855 lines removed\n\n### What Was Reverted in markup.py\n1. Removed `math_protect_plugin` import\n2. Removed `md.use(math_protect_plugin)` call\n3. Reverted comments (removed \"math tokens\" references)\n4. Restored TODO stub: `# TODO: Implement math delimiter protection plugin`\n\n### What Was Preserved\n- `tasks/markdown-mathjax-implementation-v2.md` (630 lines) - kept for reference\n- This is significant: the commit deliberately keeps the v2 plan while removing the v1 code\n\n### Why Reverted\nBased on the v2 document included in commit 9, the v1 plugin approach was abandoned because:\n1. **Complexity:** Plugin-based context tracking is complex\n2. **Edge cases:** Mid-paragraph `$$`, multiple backslash handling, content after `$$` lost\n3. **Test invalidity:** Tests expected emphasis with MATHJAX=True but code disabled it\n4. **FOUC problem:** \\$100 shows backslash until MathJax loads client-side\n5. **Proven alternative:** Stack Exchange's preprocessing approach is simpler\n\n### What Replaced v1\nUncommitted work shows v2 implementation in progress:\n- `askbot/utils/markdown_plugins/math_extract.py` - Stack Exchange style token extraction\n- `askbot/utils/markdown_plugins/dollar_escape.py` - Server-side \\$ → \u0026dollar; conversion  \n- `askbot/tests/test_markdown_mathjax.py` - v2 test suite\n\n### Commit Quality\n- ✅ Clean, focused revert\n- ✅ Clear commit message listing exactly what was removed\n- ✅ Explains preservation of v2 doc\n- ✅ Proper partial revert (code only, not docs)","created_at":"2026-01-10T19:48:24Z"},{"id":39,"issue_id":"askbot-master-mps","author":"devop","text":"## Additional Findings - Critical Context\n\n### 1. TIMING: Only 25 Minutes Between v1 and Revert\n\n| Commit | Time | Action |\n|--------|------|--------|\n| d625f5507 | 17:12:11 | Committed v1 implementation |\n| a40000d1c | 17:37:17 | Reverted v1 implementation |\n\n**25 minutes apart.** This rapid turnaround suggests the developer:\n- Committed v1\n- Immediately discovered critical issues (possibly by running tests)\n- Reverted almost immediately\n\n### 2. State After Revert\n\nThe codebase now has a `pass` stub with TODO:\n```python\nif askbot_settings.ENABLE_MATHJAX:\n    # TODO: Implement math delimiter protection plugin\n    pass\n```\n\n**MathJax delimiter protection is NOT implemented** in committed code. Only the crude `md.disable('emphasis')` workaround exists.\n\n### 3. V2 Implementation Details (Uncommitted)\n\nThe uncommitted v2 files implement Stack Exchange's proven approach:\n\n**`math_extract.py`:**\n- Token-based extraction using `@@N@@` placeholders\n- Based on Stack Exchange's `mathjax-editing.js` (Geoff Dalgas)\n- `MATH_SPLIT` regex handles: `$$`, `$`, `\\begin{}`, `\\end{}`, `\\[`, `\\]`\n- `protect_code_dollars()` - replaces `$` with `~D` in backtick spans\n\n**`dollar_escape.py`:**\n- Simple `\\$` → `\u0026dollar;` conversion\n- Runs AFTER math extraction (tokens are safe)\n- **Solves FOUC problem** - server-side conversion, no backslash flicker\n\n### 4. V2 Handles MORE Delimiters Than V1\n\n| Delimiter | v1 Plugin | v2 Preprocessing |\n|-----------|-----------|------------------|\n| `$...$` | ✓ | ✓ |\n| `$$...$$` | ✓ | ✓ |\n| `\\[...\\]` | ✗ | ✓ |\n| `\\begin{}...\\end{}` | ✗ | ✓ |\n\n### 5. Architectural Difference\n\n**v1 (plugin):** Runs DURING markdown parsing, must compete with other rules\n**v2 (preprocessing):** Runs BEFORE markdown parsing, math already protected\n\nThe revert makes way for the simpler, more capable v2 approach.","created_at":"2026-01-10T19:50:12Z"},{"id":40,"issue_id":"askbot-master-mps","author":"devop","text":"## CORRECTION to First Comment\n\n### Line Count Error\n\nIn my first comment, I stated:\n\u003e | `markup.py` | Reverted | +13/-27 |\n\n**This is INCORRECT.**\n\nThe actual change is **+13/-14** (27 total lines changed, not 27 deletions).\n\nVerified via `git show a40000d1c --numstat`:\n```\n13    14    askbot/utils/markup.py\n```\n\n### Corrected Files Table\n\n| File | Change | Lines |\n|------|--------|-------|\n| `math_protect.py` | Deleted | -251 |\n| `test_markdown_math_plugin.py` | Deleted | -590 |\n| `markup.py` | Reverted | +13/-14 |\n\n**Total:** 841 deleted + 14 removed from markup = 855 lines removed (net: -842)","created_at":"2026-01-10T19:51:59Z"},{"id":41,"issue_id":"askbot-master-mps","author":"devop","text":"## Final Observations\n\n### 1. Full Development Timeline (from file timestamps)\n\n| Time | Event |\n|------|-------|\n| 16:45 | v2 plan document created locally |\n| 17:12 | Commit v1 + v2 doc (d625f5507) |\n| 17:37 | Revert v1 (a40000d1c) - 25 min later |\n| 17:38 | __init__.py touched (1 min after revert) |\n| 17:43 | dollar_escape.py created (6 min after revert) |\n| 18:07 | math_extract.py created (30 min after revert) |\n\n**Key insight:** V2 implementation started just 6 minutes after the revert. The developer immediately pivoted to implementing the preprocessing approach.\n\n### 2. Revert Restores Non-Functional Stub\n\nAfter the revert, this code exists in markup.py:\n```python\nif askbot_settings.ENABLE_MATHJAX:\n    # TODO: Implement math delimiter protection plugin\n    pass\n```\n\n**This does NOTHING.** The `ENABLE_MATHJAX` setting check exists, but the body is just `pass`. Users with MathJax enabled have NO math delimiter protection - only the crude `md.disable('emphasis')` workaround.\n\n### 3. Comment Changes Reflect Loss of Protection\n\n**v1 comment said:**\n\u003e \"math content is already protected as special tokens\"\n\n**Reverted comment says:**\n\u003e \"disable underscore emphasis for MathJax compatibility\"\n\nThe v1 comment acknowledged math was protected. The reverted comment implies the crude workaround is still necessary (which it is, since protection was removed).\n\n### 4. Corrected Statistics Summary\n\n| Metric | Value |\n|--------|-------|\n| Files deleted | 2 (math_protect.py, test file) |\n| Files modified | 1 (markup.py) |\n| Lines in deleted files | 841 (590 + 251) |\n| Lines removed from markup.py | 14 |\n| Lines added to markup.py | 13 |\n| **Total deletions** | **855** |\n| **Total insertions** | **13** |\n| **Net change** | **-842 lines** |","created_at":"2026-01-10T19:54:14Z"}]}
{"id":"askbot-master-mxa","title":"Implement token-based video extraction for safe post-sanitization embedding","description":"## Goal\nMove video embed iframe creation to AFTER sanitization using a token-based extraction pattern (like MathJax).\n\n## Problem\nCurrently, video embeds create iframes during markdown rendering, which are then subject to sanitization. This requires whitelisting iframes in the sanitizer, which is a security risk.\n\n## Solution: Token-Based Extraction\nFollow the proven MathJax pattern (`math_extract.py`):\n\n### Pipeline Change\n**Before:**\n1. Markdown rendering (iframes created)\n2. Sanitization (iframes potentially stripped)\n\n**After:**\n1. Extract video syntax to tokens: `@[youtube](id)` → `@@VIDEO0@@`\n2. Markdown rendering (tokens remain as text)\n3. Sanitization (tokens pass through safely)\n4. Restore tokens to iframes: `@@VIDEO0@@` → `\u003ciframe...\u003e`\n\n## Files to Create\n\n### Backend: `askbot/utils/markdown_plugins/video_extract.py`\n```python\ndef extract_video_embeds(text):\n    \"\"\"Replace @[service](id) with @@VIDEON@@ tokens.\n    Returns: (tokenized_text, video_blocks)\n    \"\"\"\n    \ndef restore_video_embeds(html, video_blocks):\n    \"\"\"Replace @@VIDEON@@ tokens with iframe HTML.\n    Only creates iframes for whitelisted services.\n    \"\"\"\n```\n\n### Frontend: `askbot/media/wmd/markdown-it/plugins/video_extract.js`\n```javascript\nwindow.videoExtract = {\n    extractVideoEmbeds: function(text) { ... },\n    restoreVideoEmbeds: function(html, videoBlocks) { ... }\n};\n```\n\n## Files to Modify\n\n### Backend: `askbot/utils/markup.py`\nIn `markdown_input_converter()`, add extraction before rendering and restoration after sanitization:\n```python\n# Before markdown rendering\ntext, video_blocks = extract_video_embeds(text)\n\n# ... existing markdown + sanitization ...\n\n# After sanitization\nhtml = restore_video_embeds(html, video_blocks)\n```\n\n### Frontend: `askbot/media/wmd/askbot_converter.js`\nIn `makeHtml()`, add same pattern around DOMPurify.sanitize().\n\n## Security Benefits\n- Iframes are NEVER subject to sanitization\n- Video URLs are constructed from whitelisted services only (YouTube, Vimeo, Dailymotion)\n- No need to whitelist iframe in sanitizer (can remove from allowlist)\n- Malicious iframe injection impossible\n\n## Pattern Reference\nSee `askbot/utils/markdown_plugins/math_extract.py` for the extraction pattern:\n- Token format: `@@N@@`\n- Extraction returns `(text, blocks_array)`\n- Restoration replaces tokens with content\n\n## Acceptance Criteria\n- [ ] Video embeds work in backend rendering\n- [ ] Video embeds work in frontend preview\n- [ ] Iframes created AFTER sanitization\n- [ ] Can remove iframe from ALLOWED_HTML_ELEMENTS\n- [ ] Only whitelisted video services work\n- [ ] Existing video embed tests pass","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T12:10:26.737478-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-12T15:32:20.449875-03:00","closed_at":"2026-01-12T15:32:20.449875-03:00","close_reason":"Closed"}
{"id":"askbot-master-n1c","title":"Audit commit 5: Improving tests for backend markdown","description":"Analyze commit 1a736db26 - WIP: improving tests for the backend markdown support.","notes":"## Audit Instructions\n\n**Before starting:**\n1. Read `tasks/markdown-upgrade-status.md` to understand the document structure and current state\n\n**When completing this audit:**\n1. **Add findings to this bd issue** using `bd comments add \u003cissue-id\u003e` with key observations\n2. **Edit ONLY your relevant section** in `tasks/markdown-upgrade-status.md` - do NOT overwrite the entire file\n3. **Reference this issue ID** (e.g., `askbot-master-xxx`) in the status file where you add findings\n4. **Update the Audit Trail table** at the bottom - change your row status from `pending` to `done`\n5. When complete, close this issue with `bd close \u003cissue-id\u003e`\n\n**Important:** Use the Edit tool to modify specific sections. Do not use Write to replace the whole file.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:15:35.640564-03:00","created_by":"devop","updated_at":"2026-01-10T15:45:11.626373-03:00","closed_at":"2026-01-10T15:45:11.626373-03:00","close_reason":"Closed","labels":["audit","commit"],"dependencies":[{"issue_id":"askbot-master-n1c","depends_on_id":"askbot-master-u9s","type":"blocks","created_at":"2026-01-10T14:15:35.641351-03:00","created_by":"devop"},{"issue_id":"askbot-master-n1c","depends_on_id":"askbot-master-6nm","type":"blocks","created_at":"2026-01-10T14:22:31.062969-03:00","created_by":"devop"}],"comments":[{"id":42,"issue_id":"askbot-master-n1c","author":"devop","text":"## Key Findings: Commit 1a736db26\n\n**Title:** \"WIP: improving tests for the backend markdown support\"\n\n### Test Improvements (Main Focus)\nAll test files converted from string assertions to BeautifulSoup-based structural validation:\n- test_markdown_integration.py: +168 lines\n- test_markdown_link_patterns_plugin.py: +53 lines\n- test_markdown_video_plugin.py: +74 lines\n\nPattern used: `BeautifulSoup(html, 'html5lib')` to parse and validate:\n- Element existence (`soup.find()`, `soup.find_all()`)\n- Element counts\n- Attribute values (`element['href']`, `element['src']`)\n- CSS classes (`class_='footnote-ref'`)\n- Text content\n\n### Functional Changes in markup.py (NOT just tests!)\n**Important:** Despite the title, this commit changes production behavior:\n\n1. **Preset change:**\n   - Before: `MarkdownIt('gfm-like')`\n   - After: `MarkdownIt('commonmark', {'linkify': False, 'typographer': False})`\n   - Manually enabled: `md.enable(['table', 'strikethrough'])`\n\n2. **URL linkification change:**\n   - Before: handled by markdown-it's built-in linkify\n   - After: disabled in markdown-it, handled by `urlize_html(text, trim_url_limit=40)`\n\n3. **Sanitization change:**\n   - Before: explicit `sanitize_html(text)` call\n   - After: relies on urlize_html's built-in sanitization\n\n### Documentation Added\n- tasks/improve-markdown-it-plugin-tests.md (848 lines) - detailed test improvement guide\n- CLAUDE.md updated: note about task-specific virtual environments\n\n### Cleanup\n- Deleted the_diff (923 lines) - working file from commit 4","created_at":"2026-01-10T18:38:02Z"},{"id":43,"issue_id":"askbot-master-n1c","author":"devop","text":"## Additional Findings (Double-Check)\n\n### 1. PARTIAL REVERT of Linkify Approach\nThis commit REVERTS the linkify strategy back to urlize_html:\n- Commit 1: Removed urlize_html from markdown_input_converter\n- Commit 4: Used gfm-like preset with built-in linkify (no urlize_html)\n- **Commit 5: Restores urlize_html, disables markdown-it linkify**\n\nThis is a significant architectural decision reversal.\n\n### 2. Typographer Disabled\n`{'typographer': False}` means:\n- No smart quotes conversion (`\"text\"` stays as-is, not converted to text)\n- No other typographic replacements\n\n### 3. URL Truncation UX Change\n`urlize_html(text, trim_url_limit=40)` truncates displayed URLs to 40 characters.\n- Long URLs will show as `https://example.com/very/long/p...`\n- This is a UX change that wasn't present in commit 4's approach\n\n### 4. Security Consideration\nSanitization change:\n- Before: explicit `return sanitize_html(text)`\n- After: `return text  # urlize_html already sanitizes`\n\nRelies on urlize_html's internal sanitization. Should verify urlize_html provides equivalent protection.\n\n### 5. Features Potentially Lost\nBy switching from `gfm-like` to `commonmark` + manual enables:\n- Only table and strikethrough manually enabled\n- Autolink (bare URLs, email addresses) now handled by urlize_html instead of markdown-it\n- May have different behavior for edge cases","created_at":"2026-01-10T18:40:20Z"}]}
{"id":"askbot-master-nfb","title":"Commit MathJax v2 implementation","description":"Commit the uncommitted MathJax v2 implementation files:\n\nFiles to commit:\n- askbot/utils/markdown_plugins/math_extract.py (337 lines)\n- askbot/utils/markdown_plugins/dollar_escape.py (42 lines)\n- askbot/tests/test_markdown_mathjax.py (386 lines)\n- askbot/utils/markup.py (modifications)\n\nStatus: COMMIT-READY per audit (askbot-master-35c)\n- All 35 tests pass (2 skipped for documented edge cases)\n- No regressions in existing tests\n\nAfter commit:\n- Update tasks/markdown-upgrade-status.md section 2.1 to mark as committed\n- Move section 2.1 content to section 1 (Completed Work)\n\nArchitecture (Stack Exchange approach):\n1. protect_code_dollars() - Replace $ with ~D in code spans\n2. extract_math() - Extract math to @@N@@ tokens\n3. escape_dollars() - Convert \\$ → \u0026dollar;\n4. md.render() - Standard markdown\n5. restore_code_dollars() - ~D → $ in output\n6. restore_math() - @@N@@ → original math\n7. sanitize_html() - XSS protection","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T20:33:07.926997-03:00","created_by":"devop","updated_at":"2026-01-10T20:45:37.216992-03:00","closed_at":"2026-01-10T20:45:37.216992-03:00","close_reason":"Closed"}
{"id":"askbot-master-p48","title":"Audit task file: markdown-upgrade-phase3-testing.md","description":"Analyze tasks/markdown-upgrade-phase3-testing.md - Testing and deployment plan. Extract all test requirements and deployment steps.","notes":"## Audit Instructions\n\n**Before starting:**\n1. Read `tasks/markdown-upgrade-status.md` to understand the document structure and current state\n\n**When completing this audit:**\n1. **Add findings to this bd issue** using `bd comments add \u003cissue-id\u003e` with key observations\n2. **Edit ONLY your relevant section** in `tasks/markdown-upgrade-status.md` - do NOT overwrite the entire file\n3. **Reference this issue ID** (e.g., `askbot-master-xxx`) in the status file where you add findings\n4. **Update the Audit Trail table** at the bottom - change your row status from `pending` to `done`\n5. When complete, close this issue with `bd close \u003cissue-id\u003e`\n\n**Important:** Use the Edit tool to modify specific sections. Do not use Write to replace the whole file.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:16:41.494219-03:00","created_by":"devop","updated_at":"2026-01-10T19:19:58.129891-03:00","closed_at":"2026-01-10T19:19:58.129891-03:00","close_reason":"Closed","labels":["audit","task-file"],"dependencies":[{"issue_id":"askbot-master-p48","depends_on_id":"askbot-master-5i7","type":"blocks","created_at":"2026-01-10T14:25:12.421165-03:00","created_by":"devop"}],"comments":[{"id":44,"issue_id":"askbot-master-p48","author":"devop","text":"## Phase 3 Audit Findings\n\n### CRITICAL Issues (3)\n\n1. **MathJax tests use wrong function (lines 755-812)**: Tests call get_md_converter().render() directly but MathJax preprocessing happens in markdown_input_converter(). The 7-phase pipeline is bypassed - tests will fail.\n\n2. **Rollback assumes markdown2 exists (lines 969-1004)**: Document proposes MARKDOWN_BACKEND=markdown2 but markdown2 removed from requirements. No feature flag implemented.\n\n3. **Missing sanitize_html consideration**: Migration script compares old vs new HTML but old content may have different sanitization.\n\n### HIGH Issues (3)\n\n1. **Wrong directory references (lines 27-46)**: Says env/ but env312/ exists. askbot_site/ should be verified.\n\n2. **Exit criteria 99%+ unrealistic**: No migration script or visual tools exist yet (status file Open Questions 7, 8).\n\n3. **Benchmark location wrong (line 568)**: Not a proper pytest test file.\n\n### MEDIUM Issues (4)\n\n1. Time estimates should be removed\n2. Test imports missing markdown_input_converter\n3. Visual regression tool not chosen\n4. docs/ directory may not exist\n\n### What's Valid\n\n- Task 3.1 management command structure good\n- Task 3.3 benchmark thresholds reasonable\n- Task 3.6 feature flag approach correct (needs implementation)\n- Exit criteria well-defined\n\n### Recommended Actions\n\n1. CRITICAL: Fix MathJax tests to use markdown_input_converter()\n2. CRITICAL: Implement MARKDOWN_BACKEND feature flag\n3. HIGH: Verify/fix directory references\n4. HIGH: Choose visual regression tool","created_at":"2026-01-10T22:17:42Z"}]}
{"id":"askbot-master-q54","title":"Beads migration cleanup: migrate markdown upgrade tracking from tasks/ to bd","description":"Epic to transition markdown upgrade project tracking from legacy tasks/*.md files to bd issue tracking.\n\nGoals:\n1. Commit all pending work (MathJax v2 implementation)\n2. Create properly-chained bd issues for remaining backend work\n3. Create rough frontend epic (to be detailed after backend complete)\n4. Split Phase 3 testing into backend and frontend stages\n5. Archive legacy task files (commit for reference)\n6. Remove tasks/ directory entirely\n\nThis completes the migration to bd-based project management.","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-01-10T20:32:00.114276-03:00","created_by":"devop","updated_at":"2026-01-10T22:14:57.248396-03:00","closed_at":"2026-01-10T22:14:57.248396-03:00","close_reason":"migration completed"}
{"id":"askbot-master-qtj","title":"Fix: HTML-escape highlight_code fallback output","description":"## Context\nThe `highlight_code()` function in `askbot/utils/markup.py` has fallback paths (lines 52, 71, 76) that don't HTML-escape output:\n\n```python\n# Line 52 - no language specified\nreturn f'\u003cpre\u003e\u003ccode\u003e{code}\u003c/code\u003e\u003c/pre\u003e'\n\n# Lines 71, 76 - unknown/failed language  \nreturn f'\u003cpre\u003e\u003ccode class=\"language-{lang}\"\u003e{code}\u003c/code\u003e\u003c/pre\u003e'\n```\n\n## Blocker\n**Only implement if askbot-master-6za (XSS test) FAILS.**\n\nIf `sanitize_html()` already catches this, this fix is unnecessary.\n\n## Task\nAdd HTML escaping to fallback returns:\n\n```python\nfrom html import escape\n\n# Line 52\nreturn f'\u003cpre\u003e\u003ccode\u003e{escape(code)}\u003c/code\u003e\u003c/pre\u003e'\n\n# Lines 71, 76\nreturn f'\u003cpre\u003e\u003ccode class=\"language-{escape(lang)}\"\u003e{escape(code)}\u003c/code\u003e\u003c/pre\u003e'\n```\n\n## Files\n- `askbot/utils/markup.py` lines 50-76\n\n## Acceptance Criteria\n- [ ] Only implement if XSS test (askbot-master-6za) fails\n- [ ] Add `from html import escape` import\n- [ ] Escape `code` and `lang` in all fallback paths\n- [ ] XSS test now passes\n- [ ] All existing tests still pass\n\n## Related\n- Blocker: askbot-master-6za (XSS integration test)\n- Source: tasks/markdown-upgrade-status.md line 694","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T21:48:14.127656-03:00","created_by":"devop","updated_at":"2026-01-11T14:21:01.995928-03:00","closed_at":"2026-01-11T14:21:01.995928-03:00","close_reason":"Tests pass - sanitize_html() already handles escaping. Fix not needed.","dependencies":[{"issue_id":"askbot-master-qtj","depends_on_id":"askbot-master-6za","type":"blocks","created_at":"2026-01-10T21:48:31.644461-03:00","created_by":"devop"},{"issue_id":"askbot-master-qtj","depends_on_id":"askbot-master-q54","type":"blocks","created_at":"2026-01-10T21:59:18.352854-03:00","created_by":"devop"}]}
{"id":"askbot-master-r89","title":"markdown editor toolbar button 'code' should create a fenced code block, not indented code block","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-25T19:27:04.334977-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-31T18:31:32.805682-03:00","closed_at":"2026-01-31T18:31:32.805682-03:00","close_reason":"Closed","comments":[{"id":93,"issue_id":"askbot-master-r89","author":"Evgeny Fadeev","text":"Implemented indented-to-fenced code block conversion in wmd.js:\n\nWhen user selects an indented block and clicks the code button:\n1. Detects if all non-empty lines start with whitespace (spaces/tabs)\n2. Finds the minimum common indentation across all lines\n3. Removes that indentation from all lines\n4. Wraps the dedented text with fenced code blocks\n\nChanges made to askbot/media/wmd/wmd.js lines 2298-2323 in the doCode function's else branch that handles fenced code blocks.","created_at":"2026-01-26T01:11:40Z"}]}
{"id":"askbot-master-tk7","title":"Audit commit 9: MathJax v1 implementation (later reverted)","description":"Analyze commit d625f5507 - mathjax implementation: version 1 - as a markdown-it plugin. NOTE: This was later reverted in commit 10.","notes":"## Audit Instructions\n\n**Before starting:**\n1. Read `tasks/markdown-upgrade-status.md` to understand the document structure and current state\n\n**When completing this audit:**\n1. **Add findings to this bd issue** using `bd comments add \u003cissue-id\u003e` with key observations\n2. **Edit ONLY your relevant section** in `tasks/markdown-upgrade-status.md` - do NOT overwrite the entire file\n3. **Reference this issue ID** (e.g., `askbot-master-xxx`) in the status file where you add findings\n4. **Update the Audit Trail table** at the bottom - change your row status from `pending` to `done`\n5. When complete, close this issue with `bd close \u003cissue-id\u003e`\n\n**Important:** Use the Edit tool to modify specific sections. Do not use Write to replace the whole file.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:15:41.707051-03:00","created_by":"devop","updated_at":"2026-01-10T16:44:34.393111-03:00","closed_at":"2026-01-10T16:44:34.393111-03:00","close_reason":"Closed","labels":["audit","commit"],"dependencies":[{"issue_id":"askbot-master-tk7","depends_on_id":"askbot-master-u9s","type":"blocks","created_at":"2026-01-10T14:15:41.707976-03:00","created_by":"devop"},{"issue_id":"askbot-master-tk7","depends_on_id":"askbot-master-2bt","type":"blocks","created_at":"2026-01-10T14:22:31.367679-03:00","created_by":"devop"}],"comments":[{"id":45,"issue_id":"askbot-master-tk7","author":"devop","text":"## Audit Findings - Commit d625f5507\n\n### Summary\nFirst attempt at MathJax delimiter protection using a markdown-it-py plugin approach. This was later reverted in commit 10 (a40000d1c).\n\n### Files Added/Modified\n1. **askbot/utils/markdown_plugins/math_protect.py** (251 lines) - New plugin\n2. **askbot/tests/test_markdown_math_plugin.py** (590 lines) - Test suite\n3. **askbot/utils/markup.py** (+14/-13 lines) - Integration\n4. **tasks/markdown-mathjax-implementation-v2.md** (630 lines) - v2 plan document\n\n### Technical Approach\n\n**Plugin Architecture:**\n- `math_inline_rule()` - Detects `$...$` inline math at inline parser level\n- `math_block_rule()` - Detects `$$...$$` display math at block parser level\n- Registered BEFORE other inline/block rules to intercept math first\n- Creates `math_inline` and `math_block` tokens that other plugins skip\n\n**Key Design Decisions:**\n- Plugin runs before backticks/fence rules in markdown-it parser chain\n- Escaped `\\$` detection - checks for preceding backslash\n- Single `$` followed by space (like \"$100\") is NOT treated as math\n- Inline math cannot span newlines\n- Display math can span multiple lines\n\n**Integration:**\n- Conditional activation: `if askbot_settings.ENABLE_MATHJAX: md.use(math_protect_plugin)`\n- Math protection runs FIRST, before footnotes/tasklists/video/patterns/truncation\n\n### Test Coverage (590 lines, 30+ test cases)\n- Basic inline/display math rendering\n- **Critical:** URLs inside math NOT linkified\n- **Critical:** Link patterns inside math NOT processed\n- Underscore/asterisk emphasis protection\n- Edge cases: empty math, single dollar, mismatched delimiters\n- Escaped dollar handling (`\\$`)\n- Integration with code blocks, links, patterns\n\n### Notable: v2 Plan Included\nThe commit ALSO added `tasks/markdown-mathjax-implementation-v2.md` which proposes ABANDONING this plugin approach in favor of:\n- Stack Exchange's token extraction preprocessing\n- Server-side `\\$` to `\u0026dollar;` conversion\n- Reasons cited: simpler, proven at scale, fewer edge cases\n\nThis suggests the developer was already uncertain about the v1 approach when committing it.\n\n### Why This Was Reverted (context for next audit)\nThe v2 plan document explains concerns:\n- Plugin-based context tracking is complex\n- Token extraction (Stack Exchange approach) is simpler\n- Server-side dollar escape avoids FOUC (Flash of Unescaped Content)\n- Math inside math tokens is inherently protected vs. relying on parser order\n","created_at":"2026-01-10T19:22:31Z"},{"id":46,"issue_id":"askbot-master-tk7","author":"devop","text":"## Additional Findings - Critical Details\n\n### 1. UNUSUAL: Commit Documents Its Own Obsolescence\n\nThe commit includes `markdown-mathjax-implementation-v2.md` (630 lines) which:\n- Is titled \"Hybrid Approach: Stack Exchange Preprocessing + Server-Side Dollar Escape\"\n- Says \"Supersedes: Background document approach\"\n- Argues AGAINST the plugin approach that was just committed\n- Proposes a completely different architecture\n\n**Comparison table from v2 doc (criticizing v1):**\n\n| Aspect | v1 Plugin | v2 Preprocessing | Winner |\n|--------|-----------|------------------|--------|\n| Complexity | Medium | Low | v2 |\n| Edge cases | Many | Few | v2 |\n| Proven approach | Novel | Stack Exchange | v2 |\n| State tracking | Required | Not needed | v2 |\n| Plugin architecture | Used | Not used | v1 |\n| Elegance | High | Medium | v1 |\n\nv1 only \"wins\" on aesthetics (elegance, plugin purity) - not functionality.\n\n### 2. FOUC Problem NOT Solved by v1\n\nThe v2 document identifies a critical issue v1 doesn't address:\n\n**Flash of Unescaped Content:**\n```\nServer HTML:     \u003cp\u003eThe price is \\$100\u003c/p\u003e\nBrowser initial: \"The price is \\$100\"  ← Backslash visible!\nMathJax loads:   \"The price is $100\"   ← Fixed (but after flicker)\n```\n\nv1 relies on MathJax's `processEscapes: true` client-side. This causes:\n- Backslash flicker during page load\n- Broken if MathJax disabled/blocked\n- Not SEO-friendly (crawlers see `\\$`)\n- Accessibility issues (screen readers read \"backslash dollar\")\n\nv2 solves this with server-side `\\$` → `\u0026dollar;` conversion.\n\n### 3. Missing LaTeX Delimiter Support\n\nv2 document shows Stack Exchange handles:\n- `$...$` (inline) ✓ v1 supports\n- `$$...$$` (display) ✓ v1 supports\n- `\\[...\\]` (display LaTeX) ✗ NOT in v1\n- `\\begin{...}\\end{...}` ✗ NOT in v1\n\n### 4. Code-Friendly Mode TODO Not Implemented\n\n```python\nif askbot_settings.MARKUP_CODE_FRIENDLY or askbot_settings.ENABLE_MATHJAX:\n    md.disable('emphasis')  # Disables BOTH * and _\n    # Note: With math protection, asterisk emphasis could be re-enabled safely\n    # TODO: Add custom rule to re-enable * only if needed\n```\n\nWhen MathJax is enabled, users lose `*italic*` and `**bold**` despite math protection making this unnecessary. The TODO was never implemented.\n\n### 5. Block Math Parsing Edge Cases\n\n```python\nif '$$' in line_content:\n    closing_idx = line_content.find('$$')\n```\n\nSimple string search issues:\n- `$$` anywhere in line closes math (even if not at start)\n- No handling for escaped `\\$$` in block context\n- The v2 preprocessing approach avoids these parsing edge cases entirely\n\n### 6. Plugin Ordering Comment Reveals Uncertainty\n\n```python\n# Register inline rule FIRST (before 'escape' to catch math early)\n# Note: We want escape to run first, but escape is already built-in\n# So we insert after escape but before everything else\nmd.inline.ruler.before('backticks', 'math_inline', math_inline_rule)\n```\n\nThe comment says \"FIRST\" but also \"after escape\" - this contradiction suggests uncertainty about correct ordering. The v2 approach sidesteps this by extracting math BEFORE markdown-it runs at all.\n\n### 7. Architectural Verdict from v2 Document\n\nThe v2 document concludes:\n\u003e \"Decision: New approach is simpler, proven, and more robust despite being less 'pure' in design.\"\n\nThis is essentially the developer saying \"the code I just committed should be replaced.\"\n\n### Why Was This Committed?\n\nPossible reasons:\n1. Testing v1 to verify its limitations empirically\n2. Providing a working baseline for comparison\n3. Time pressure - ship something, improve later\n4. v2 document written AFTER discovering v1's issues during implementation\n\n**Bottom line:** This commit is as much a demonstration of why NOT to use the plugin approach as it is an implementation. The included v2 document is effectively a post-mortem written preemptively.\n","created_at":"2026-01-10T19:27:27Z"},{"id":47,"issue_id":"askbot-master-tk7","author":"devop","text":"## Final Audit - Critical Implementation Issues Found\n\n### 1. CRITICAL BUG: Inline Display Math Not Handled\n\nThe inline rule explicitly rejects `$$`:\n```python\n# Check if followed by another $ (might be display math $$)\n# Let the display math rule handle it\nif pos + 1 \u003c maximum and state.src[pos + 1] == '$':\n    return False\n```\n\nBut the block rule ONLY matches `$$` at the START of a line:\n```python\n# Check for $$ at start of line\nif state.src[pos:pos + 2] != '$$':\n    return False\n```\n\n**Result:** `$$math$$` in the middle of text is NOT handled at all!\n\nExample that would fail:\n```\nSome text $$E = mc^2$$ more text\n```\n\nThe docstring claims \"Adjacent: $$x$$ → Display math (block has priority)\" but this is FALSE for mid-paragraph display math.\n\n### 2. Test/Implementation Contradiction on Emphasis\n\nTests expect emphasis to work with ENABLE_MATHJAX=True:\n```python\n@with_settings(ENABLE_MATHJAX=True)\ndef test_escaped_dollar_not_opening_delimiter(self):\n    text_with_emphasis = r\"\\\\$x = *y*$\"\n    html = md.render(text_with_emphasis)\n    em_tags = soup.find_all('em')\n    self.assertEqual(len(em_tags), 1, \"Emphasis should be processed when \\\\$ prevents math\")\n```\n\nBut markup.py DISABLES emphasis when MathJax enabled:\n```python\nif askbot_settings.MARKUP_CODE_FRIENDLY or askbot_settings.ENABLE_MATHJAX:\n    md.disable('emphasis')  # Disables BOTH * and _\n```\n\n**Either the tests never passed, or there's a singleton/settings interaction bug that masks this issue.**\n\n### 3. Multi-line Block Math: Content After Closing `$$` is Lost\n\n```python\nif '$$' in line_content:\n    closing_idx = line_content.find('$$')\n    if closing_idx \u003e 0:\n        lines.append(line_content[:closing_idx])\n    auto_closed = True\n    nextLine += 1\n    break\n```\n\nExample:\n```\n$$\nx = 5\n$$ this text is LOST\nnext paragraph\n```\n\nThe \"this text is LOST\" is never processed - the rule just breaks and advances state.line.\n\n### 4. Multi-line Block Math: `$$` Anywhere in Line Closes Math\n\nThe check `'$$' in line_content` matches `$$` ANYWHERE, not just at line start:\n\nExample that would be mishandled:\n```\n$$\nsome math content\n   text before $$ text after\n$$\n```\n\nThe indented `$$` would incorrectly close the math block.\n\n### 5. Escape Handling is Oversimplified\n\n```python\nif pos \u003e 0 and state.src[pos - 1] == '\\\\':\n    return False\n```\n\nThis can't correctly handle multiple backslashes:\n- `\\\\$x$` (escaped backslash + dollar) should render as `\\` followed by math\n- `\\\\\\$x$` should render as `\\$x$` literal\n\nThe single-character lookback can't distinguish these cases.\n\n### 6. Contradictory Comment About Rule Ordering\n\n```python\n# Register inline rule FIRST (before 'escape' to catch math early)\n# Note: We want escape to run first, but escape is already built-in\n# So we insert after escape but before everything else\nmd.inline.ruler.before('backticks', 'math_inline', math_inline_rule)\n```\n\nSays \"FIRST\" and \"after escape\" in the same comment - reveals author uncertainty about correct ordering.\n\n### 7. Missing Test Coverage\n\nNo tests for:\n- Mid-paragraph display math: `text $$math$$ text`\n- Adjacent math without spaces: `$x$$y$`\n- Content after closing `$$` preservation\n- Multiple backslash + dollar combinations\n- `$$` appearing mid-line in multiline mode\n\n### Summary Assessment\n\nThis implementation has fundamental architectural issues:\n1. **Display math gap:** No handling for `$$..$$` mid-paragraph\n2. **Test quality concerns:** Tests may contradict actual code behavior\n3. **Edge case failures:** Multiple documented scenarios that would fail\n\nThis explains why the v2 document was included - the developer discovered these issues during implementation and recognized the plugin approach was fundamentally flawed. The preprocessing approach (v2) avoids all these problems by extracting math BEFORE markdown-it runs.\n","created_at":"2026-01-10T19:31:44Z"},{"id":48,"issue_id":"askbot-master-tk7","author":"devop","text":"## Deep Analysis - Test Validity \u0026 Additional Bugs\n\n### 1. CRITICAL: Test Suite Cannot Pass As Written\n\nMultiple tests with `@with_settings(ENABLE_MATHJAX=True)` expect asterisk emphasis to work:\n\n**test_escaped_dollar_not_opening_delimiter (line 340-365):**\n```python\n@with_settings(ENABLE_MATHJAX=True)\ndef test_escaped_dollar_not_opening_delimiter(self):\n    ...\n    text_with_emphasis = r\"\\\\$x = *y*$\"\n    html = md.render(text_with_emphasis)\n    em_tags = soup.find_all('em')\n    self.assertEqual(len(em_tags), 1, \"Emphasis should be processed...\")\n```\n\n**test_escaped_dollar_literal_text (line 384-408):**\n```python\n@with_settings(ENABLE_MATHJAX=True)\ndef test_escaped_dollar_literal_text(self):\n    ...\n    text_with_emphasis = r\"The price is \\\\$100 for *this*\"\n    em_tags = soup.find_all('em')\n    self.assertEqual(len(em_tags), 1, \"Emphasis should be processed...\")\n```\n\n**test_escaped_dollars_both_sides (line 410+):**\nSimilar pattern - expects emphasis with MATHJAX=True.\n\n**BUT the implementation does:**\n```python\nif askbot_settings.MARKUP_CODE_FRIENDLY or askbot_settings.ENABLE_MATHJAX:\n    md.disable('emphasis')  # Disables ALL emphasis including *\n```\n\n**Conclusion:** These tests CANNOT pass. Either:\n- Tests were written but never run successfully\n- `@with_settings` decorator has a bug/doesn't affect the singleton correctly\n- Tests document INTENDED behavior that was never implemented (the TODO to re-enable asterisk)\n\nThis casts doubt on the entire test suite's validity.\n\n### 2. BUG: Double-Escaped Backslash Breaks Math Detection\n\nThe escape check only looks at single preceding character:\n```python\nif closing_pos \u003e 0 and state.src[closing_pos - 1] == '\\\\':\n    closing_pos += 1\n    continue\n```\n\n**Failure case:** `$x\\\\$` (math with content `x\\`, closing `$`)\n- Position 4: `$` found\n- Position 3: `\\` - code thinks this escapes the `$`!\n- But `\\\\` is an escaped backslash, not a dollar escape\n- Result: Valid math not recognized\n\n**Missing test:** No coverage for content ending in escaped backslash.\n\n### 3. BUG: Multiple `$$` Pairs on Same Line\n\nInput: `$$x$$y$$`\n\nBlock rule (same-line branch):\n```python\nclosing_pos = state.src.find('$$', pos)  # Finds first $$\ncontent = state.src[pos:closing_pos]      # Gets 'x'\nstate.line = startLine + 1                 # Advances to next line\n```\n\nResult: `y$$` is consumed but never processed.\n\n### 4. Potential HTML Injection\n\nRenderers output content directly:\n```python\ndef render_math_inline(self, tokens, idx, options, env):\n    return f\"${tokens[idx].content}$\"\n```\n\nInput `$x\u003cscript\u003ealert(1)\u003c/script\u003e$` outputs:\n```html\n$x\u003cscript\u003ealert(1)\u003c/script\u003e$\n```\n\nLikely mitigated by `sanitize_html()` in full pipeline, but:\n- Tests use `md.render()` directly, not full pipeline\n- Sanitizer might mangle math content unexpectedly\n\n### 5. Singleton Settings Invalidation\n\n```python\ndef get_md_converter():\n    global _MD_CONVERTER\n    if _MD_CONVERTER is not None:\n        return _MD_CONVERTER  # Returns cached even if settings changed\n```\n\nIf admin changes ENABLE_MATHJAX at runtime, old converter persists until restart.\n\n### 6. Missing Test Coverage\n\n- `$content\\\\$` - content ending in escaped backslash\n- `$$x$$y$$` - multiple display math on same line  \n- `` `$x$` `` - inline code span protection (only fenced blocks tested)\n- HTML special chars in math content\n- Mid-paragraph `$$math$$` (the major gap)\n\n### Summary\n\nThe test suite appears to test INTENDED behavior that was never fully implemented. The TODO in markup.py (\"Add custom rule to re-enable * only if needed\") was never completed, but tests assume it was. This, combined with the implementation bugs and missing coverage, suggests v1 was abandoned before reaching production quality.\n","created_at":"2026-01-10T19:39:27Z"}]}
{"id":"askbot-master-tkt","title":"Add test: javascript: URLs rejected by linkify (security)","description":"## Context\nThe linkify plugin should NOT create links from `javascript:` pseudo-URLs as this is an XSS attack vector. linkify-it-py is supposed to reject these by default, but we have no test verifying this security behavior.\n\n## Task\nAdd a security test to verify `javascript:` URLs are NOT auto-linked.\n\n## Test Location\n`askbot/tests/test_markdown_integration.py` or `askbot/tests/test_markup.py`\n\n## Test Cases\n```python\ndef test_javascript_url_not_linked(self):\n    \"\"\"javascript: URLs should NOT be auto-linked (XSS prevention)\"\"\"\n    text = \"Click javascript:alert('xss') here\"\n    html = markdown_input_converter(text)\n    # Should NOT create a link with javascript: href\n    assert 'href=\"javascript:' not in html\n    # The text might still appear, just not as a link\n    \ndef test_javascript_url_variations(self):\n    \"\"\"Various javascript: URL forms should all be rejected\"\"\"\n    variants = [\n        \"javascript:alert(1)\",\n        \"JAVASCRIPT:alert(1)\",\n        \"javascript:void(0)\",\n    ]\n    for variant in variants:\n        text = f\"Test {variant} here\"\n        html = markdown_input_converter(text)\n        assert 'href=\"javascript:' not in html.lower()\n```\n\n## Acceptance Criteria\n- [ ] Test verifies javascript: URLs do NOT become links\n- [ ] Test uses `markdown_input_converter()` for full pipeline coverage\n- [ ] Test passes with current implementation\n- [ ] Test covers case variations (javascript:, JAVASCRIPT:, etc.)\n\n## Security Note\nThis is a security test. If it fails, there is an XSS vulnerability that must be fixed.\n\n## Related\n- Source: tasks/markdown-upgrade-status.md section 1.2 (Coverage Gaps)\n- linkify-it-py should reject javascript: by default","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T21:40:42.038355-03:00","created_by":"devop","updated_at":"2026-01-11T13:30:33.39464-03:00","closed_at":"2026-01-11T13:30:33.39464-03:00","close_reason":"Closed","dependencies":[{"issue_id":"askbot-master-tkt","depends_on_id":"askbot-master-q54","type":"blocks","created_at":"2026-01-10T22:01:24.412775-03:00","created_by":"devop"}]}
{"id":"askbot-master-u9s","title":"Audit commit 1: Initial markdown2 → markdown-it migration","description":"Analyze commit 8105e56de - WIP: markdown2 -\u003e markdown_it. Extract what was changed, what features were added, any TODOs left.","notes":"## Audit Instructions\n\n**Before starting:**\n1. Read `tasks/markdown-upgrade-status.md` to understand the document structure and current state\n\n**When completing this audit:**\n1. **Add findings to this bd issue** using `bd comments add \u003cissue-id\u003e` with key observations\n2. **Edit ONLY your relevant section** in `tasks/markdown-upgrade-status.md` - do NOT overwrite the entire file\n3. **Reference this issue ID** (e.g., `askbot-master-xxx`) in the status file where you add findings\n4. **Update the Audit Trail table** at the bottom - change your row status from `pending` to `done`\n5. When complete, close this issue with `bd close \u003cissue-id\u003e`\n\n**Important:** Use the Edit tool to modify specific sections. Do not use Write to replace the whole file.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:15:01.967603-03:00","created_by":"devop","updated_at":"2026-01-10T15:18:48.114484-03:00","closed_at":"2026-01-10T15:18:48.114484-03:00","close_reason":"Closed","labels":["audit","commit"],"comments":[{"id":49,"issue_id":"askbot-master-u9s","author":"devop","text":"## Audit Findings for Commit 8105e56de\n\n### Summary\nInitial WIP commit that begins migration from markdown2 to markdown-it-py. Sets up foundation but leaves many features incomplete.\n\n### Changes Made\n\n**1. Dependencies Added** (`askbot/__init__.py`):\n- `linkify-it-py==2.0.2`\n- `markdown-it-py==2.2.0`\n- `mdit-py-plugins==0.3.5`\n- Note: `markdown2` NOT removed (still listed)\n\n**2. User Permission Changes** (`askbot/models/__init__.py`):\n- Refactored `user_assert_can_post_text` with early return pattern\n- Added explicit error message for anonymous users posting links\n- No functional change, just code reorganization\n\n**3. PostRevision.html** (`askbot/models/post.py`):\n- Changed from `markup.get_parser()` to `markup.markdown_input_converter()`\n- Simplified code structure\n\n**4. Tests Removed** (`askbot/tests/test_utils.py`):\n- Removed `GetParserTest` class (markdown2-specific loader tests)\n\n**5. Markup Module Rewrite** (`askbot/utils/markup.py`):\n- Replaced `get_parser()` with `get_md_converter()`\n- Created `MD_CONVERTER` singleton at module level\n- Uses 'gfm-like' preset\n- Removed `urlize_html` call from `markdown_input_converter()`\n\n### TODOs / Not Yet Implemented:\n1. Video embedding (commented but not implemented)\n2. Code-friendly mode (commented but not implemented)\n3. Link patterns/auto-linking (commented but not implemented)\n4. markdown2 dependency not yet removed\n\n### Potential Issues:\n- Singleton pattern means runtime config changes won't apply\n- urlize_html was removed without markdown-it linkify enabled\n","created_at":"2026-01-10T17:53:47Z"},{"id":50,"issue_id":"askbot-master-u9s","author":"devop","text":"## CORRECTION to Section 2 (User Permission Changes)\n\nThe original comment incorrectly stated \"No functional change, just code reorganization\". This is **wrong**.\n\n**Actual behavior change:**\n\n- **Before**: `if self.is_authenticated and self.reputation \u003c min_rep` - Only blocked authenticated users with low rep. Anonymous users (`is_authenticated=False`) could post links.\n\n- **After**: `if self.is_anonymous or self.reputation \u003c min_rep` - Blocks both anonymous users AND low-rep authenticated users.\n\nThis is a **security/policy change**: anonymous users can no longer post links. The commit message confirms this was intentional (\"anon users cant post links\").\n\nThis behavioral change was bundled with the markdown library migration.\n","created_at":"2026-01-10T17:58:23Z"},{"id":51,"issue_id":"askbot-master-u9s","author":"devop","text":"## Additional Corrections/Findings\n\n**1. Commit message is misleading:**\nThe commit message says \"removes markdown2 dependency\" but markdown2 is still in REQUIREMENTS dict. Only new dependencies were added; markdown2 was NOT removed in this commit.\n\n**2. Lost features more extensive than originally noted:**\nThe old `get_parser()` also supported:\n- Custom markdown class via `ASKBOT_MARKDOWN_CLASS` Django setting\n- `html4tags=True` option passed to markdown2\n\n**3. urlize_html removal is a functional regression:**\nOld code flow:\n```python\ntext = get_parser().convert(text)\ntext = sanitize_html(text)\ntext = urlize_html(text)  # Convert plain URLs to clickable links\nreturn sanitize_html(text)\n```\n\nNew code flow:\n```python\ntext = MD_CONVERTER.render(text)\nreturn sanitize_html(text)\n```\n\nSince `urlize_html` was removed AND linkify is not enabled in markdown-it, **plain text URLs no longer become clickable links**. This is a functional regression that later commits would need to address.\n\n**4. Double sanitization was intentional:**\nThe old code sanitized twice - once after markdown conversion, once after urlize_html added new `\u003ca\u003e` tags. The new code only sanitizes once, which is correct since urlize_html is gone.\n","created_at":"2026-01-10T18:06:28Z"},{"id":52,"issue_id":"askbot-master-u9s","author":"devop","text":"## Additional Correction: PostRevision.html changes\n\n**Structural change missed in original analysis:**\n\nPostRevision.html changed from calling `get_parser().convert()` directly to calling `markdown_input_converter()`.\n\n**Before:**\n```python\nmarkdowner = markup.get_parser()  # Full-featured: video, code-friendly, link-patterns\nsanitized_html = sanitize_html(markdowner.convert(self.text))\n```\n\n**After:**\n```python\nsanitized_html = markup.markdown_input_converter(self.text)  # Stripped-down MD_CONVERTER\n```\n\n**Implications:**\n\n1. **PostRevision lost features**: Before this commit, PostRevision had video embedding, code-friendly mode, and link-patterns (from `get_parser()`). After, it has none of these because `MD_CONVERTER` is just `MarkdownIt('gfm-like')`.\n\n2. **urlize_html clarification**: PostRevision NEVER had urlize_html - that was only in `markdown_input_converter()`, not in the direct `get_parser().convert()` call. The urlize_html regression affects other code that called `markdown_input_converter()` directly, not PostRevision.\n\n3. **Code coupling**: PostRevision is now tied to the `markdown_input_converter()` pipeline instead of having its own direct parser access.\n","created_at":"2026-01-10T18:15:16Z"}]}
{"id":"askbot-master-uga","title":"Audit task file: markdown-upgrade-overview.md","description":"Analyze tasks/markdown-upgrade-overview.md - Master plan with 3 phases, goals, success criteria. Extract all actionable items and checkboxes.","notes":"## Audit Instructions\n\n**Before starting:**\n1. Read `tasks/markdown-upgrade-status.md` to understand the document structure and current state\n\n**When completing this audit:**\n1. **Add findings to this bd issue** using `bd comments add \u003cissue-id\u003e` with key observations\n2. **Edit ONLY your relevant section** in `tasks/markdown-upgrade-status.md` - do NOT overwrite the entire file\n3. **Reference this issue ID** (e.g., `askbot-master-xxx`) in the status file where you add findings\n4. **Update the Audit Trail table** at the bottom - change your row status from `pending` to `done`\n5. When complete, close this issue with `bd close \u003cissue-id\u003e`\n\n**Important:** Use the Edit tool to modify specific sections. Do not use Write to replace the whole file.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:16:21.17003-03:00","created_by":"devop","updated_at":"2026-01-10T17:34:07.865649-03:00","closed_at":"2026-01-10T17:34:07.865649-03:00","close_reason":"Closed","labels":["audit","task-file"],"dependencies":[{"issue_id":"askbot-master-uga","depends_on_id":"askbot-master-35c","type":"blocks","created_at":"2026-01-10T14:40:27.524895-03:00","created_by":"devop"}],"comments":[{"id":53,"issue_id":"askbot-master-uga","author":"devop","text":"## Audit Findings: markdown-upgrade-overview.md\n\n**Document Type:** Master planning document with 3-phase migration strategy\n\n### Extracted Actionable Items (21 checkboxes total)\n\n**Phase 1 Success Criteria (8 items):**\n- [ ] markdown-it-py upgraded to 4.0.0\n- [ ] Video embedding plugin working\n- [ ] Link patterns plugin working\n- [ ] Code-friendly mode disables underscore emphasis\n- [ ] Pygments syntax highlighting integrated\n- [ ] 95%+ code coverage for new plugins\n- [ ] All existing backend tests passing\n- [ ] Manual testing shows correct rendering\n\n**Phase 2 Success Criteria (6 items):**\n- [ ] markdown-it.js loaded and configured\n- [ ] askbot_converter.js rewritten and tested\n- [ ] Live preview matches backend exactly\n- [ ] All JavaScript tests passing\n- [ ] WMD editor integration working\n- [ ] MathJax integration preserved\n\n**Phase 3 Success Criteria (6 items):**\n- [ ] Migration script validates all existing posts\n- [ ] \u003c1% visual differences detected\n- [ ] Performance benchmarks meet targets\n- [ ] Documentation updated\n- [ ] Stakeholder approval for deployment\n- [ ] Rollback procedure tested\n\n### Status Assessment (Overview vs Reality)\n\n**DOCUMENT IS OUTDATED** - Does not reflect actual commit progress\n\n| Criteria | Document Claims | Actual State (from commits) |\n|----------|----------------|----------------------------|\n| markdown-it-py version | \"needs upgrade to 4.0.0\" | ✅ DONE in commit 4 |\n| Phase 1 Status | \"🟡 Planning\" | 80%+ complete |\n| Video plugin | Not started | ✅ DONE: video_embed.py (commit 4) |\n| Link patterns | Not started | ✅ DONE: link_patterns.py (commit 4) |\n| Code-friendly mode | Not started | ⚠️ DONE but buggy (disables ALL emphasis) |\n| Pygments | Not started | ✅ DONE (commit 4) |\n| Linkify | Not mentioned | ✅ DONE: truncate_links.py (commit 6) |\n\n### Missing From Overview\n\n1. **MathJax integration** - Not in Phase 1 checklist, but significant work done (v1 attempted/reverted, v2 uncommitted)\n2. **Linkify/truncate_links plugin** - Major feature added in commits 5-6\n3. **Test infrastructure** - BeautifulSoup-based structural tests added (commit 5)\n\n### Risks Still Valid\n\nAll 5 risks in the Risk Assessment table remain relevant:\n- Existing content renders differently (mitigated by tests added)\n- Custom plugins break edge cases (some edge cases found in MathJax v1)\n- Frontend/backend mismatch (Phase 2 not started)\n- Performance regression (not benchmarked yet)\n- User confusion (Phase 3 item)\n\n### Recommendations\n\n1. **Update Phase 1 status** from \"Planning\" to \"Near Complete\"\n2. **Add MathJax/math delimiter tasks** to Phase 1 checklist\n3. **Add linkify plugin** to Phase 1 completed work\n4. **Fix code-friendly mode** bug before marking Phase 1 complete","created_at":"2026-01-10T20:20:23Z"},{"id":54,"issue_id":"askbot-master-uga","author":"devop","text":"## Additional Findings (Deep Analysis)\n\n### Items Missed in First Pass\n\n**1. Known Limitations (lines 149-154) - Status vs Reality:**\n\n| Documented Limitation | Actual Status |\n|----------------------|---------------|\n| Video plugin: No Python port | ✅ RESOLVED: video_embed.py in commit 4 |\n| Link patterns: Complex regex | ✅ RESOLVED: link_patterns.py in commit 4 |\n| HTML differences: code blocks | ⚠️ UNVERIFIED: No tests comparing output |\n| Performance: 10-20% slower | ⚠️ UNVERIFIED: No benchmarks run |\n\n**2. MAJOR GAP: Linkify/URL auto-linking completely absent from overview**\n- Commits 5-6 implemented significant linkify functionality\n- truncate_links.py plugin (134 lines) not mentioned\n- This is a Phase 1 deliverable that should be in the checklist\n\n**3. MAJOR GAP: Math delimiter protection not in Phase 1 checklist**\n- Overview only mentions \"MathJax integration preserved\" in Phase 2 (frontend)\n- Backend math protection work (v1 attempted, v2 uncommitted) not captured\n- This is a Phase 1 backend deliverable that's missing\n\n**4. Post-Deployment Success Metrics (lines 217-221):**\n- Zero critical bugs in first week\n- \u003c5% increase in conversion time\n- \u003c10 user complaints about rendering changes\n- Zero data loss incidents\n\n**5. Infrastructure Requirements NOT YET MET (lines 132-135):**\n- [ ] Test database with production data copy\n- [ ] Staging environment for phase 2 testing\n- [ ] Visual comparison tools (Percy, BackstopJS)\n\n**6. Communication Plan milestones (lines 162-168):**\n- Before Phase 1: Internal team notification\n- After Phase 1: Backend to staging\n- After Phase 2: Beta testers invited\n- Before Phase 3: User notification\n- After Deployment: Release notes\n\n**7. Feature Flag not implemented:**\n- Overview specifies: `MARKDOWN_BACKEND = env('MARKDOWN_BACKEND', default='markdown_it')`\n- Not found in current codebase - rollback strategy not yet in place\n\n**8. Sign-off section empty (lines 223-227):**\n- Technical Lead: unsigned\n- QA Lead: unsigned\n- Product Owner: unsigned\n\n### Document Assessment\n\n**Document Role:** Master planning document - still relevant as overall roadmap\n**Document Status:** OUTDATED but NOT OBSOLETE\n\n**Accuracy Issues:**\n1. \"Current State\" section wrong - says 2.2.0, actually 4.0.0\n2. Phase 1 status \"Planning\" but 80%+ complete\n3. \"Custom Features Missing\" - all now implemented\n4. Missing: linkify, math delimiter protection, truncate_links plugin\n\n**Should Be Updated To Reflect:**\n- Actual completed work from commits 1-10\n- Add linkify to Phase 1 deliverables\n- Add math delimiter protection to Phase 1\n- Update \"Known Limitations\" with resolved items\n- Mark Phase 1 near-complete, not \"Planning\"","created_at":"2026-01-10T20:24:33Z"},{"id":55,"issue_id":"askbot-master-uga","author":"devop","text":"## Verification Results (Code Inspection)\n\n### Claims VERIFIED Against Actual Code\n\n| Overview Claim | Verification | Status |\n|---------------|--------------|--------|\n| markdown-it-py 4.0.0 | askbot_requirements.txt line 24 | ✅ VERIFIED |\n| Video syntax `@[youtube](id)` | video_embed.py line 5: `@[youtube](video_id)` | ✅ MATCHES |\n| Link patterns `#bug123` | link_patterns.py line 8: `#bug(\\\\d+)` | ✅ MATCHES |\n| Showdown still in frontend | askbot/media/wmd/showdown-min.js exists | ✅ VERIFIED |\n| markdown2 not in requirements | No markdown2 in askbot_requirements.txt | ✅ VERIFIED |\n\n### Claims NOT VERIFIED / MISSING\n\n| Overview Claim | Status | Notes |\n|---------------|--------|-------|\n| `MARKDOWN_BACKEND` feature flag | ❌ NOT IMPLEMENTED | Grep found 0 results in conf/*.py |\n| 95%+ test coverage | ❓ UNVERIFIED | No coverage report exists |\n| 10-20% performance slower | ❓ UNVERIFIED | No benchmarks run |\n| Infrastructure ready | ❌ NOT SET UP | No staging env, no test DB copy, no visual tools |\n\n### Risk Mitigation Tracking (from Risk Assessment table)\n\n| Risk | Mitigations | Implementation Status |\n|------|------------|----------------------|\n| Content renders differently | Migration script, visual comparison, gradual rollout | ❌ None implemented |\n| Plugins break edge cases | Unit tests, QA on prod data | ⚠️ Unit tests exist, QA NOT done |\n| Frontend/backend mismatch | Integration tests comparing renderers | ❌ Not implemented (Phase 2) |\n| Performance regression | Benchmark testing, caching strategy | ❌ Neither implemented |\n| User confusion | Documentation, in-app help | ❌ Not relevant yet |\n\n### Phase 1 Gate Criteria Assessment\n\n**Gate: \"100% backend tests passing, custom plugins working\"**\n\n| Criterion | Status | Evidence |\n|-----------|--------|----------|\n| Backend tests passing | ✅ YES | askbot-master-35c audit: 35/35 pass |\n| Video plugin working | ✅ YES | video_embed.py verified |\n| Link patterns working | ✅ YES | link_patterns.py verified |\n| Code-friendly mode | ⚠️ BUGGY | Disables ALL emphasis, not just `_` |\n| Math delimiter protection | ✅ YES | math_extract.py commit-ready |\n\n**Gate Status: MOSTLY PASSED** - Code-friendly emphasis bug is only blocker\n\n### Communication Plan Status\n\n| Milestone | Status |\n|-----------|--------|\n| Before Phase 1: Internal notification | ❓ Unknown |\n| After Phase 1: Backend to staging | ❌ Not done |\n| After Phase 2: Beta testers invited | ❌ N/A yet |\n| Before Phase 3: User notification | ❌ N/A yet |\n| After Deployment: Release notes | ❌ N/A yet |\n\n### Sign-off Status\n\nAll 3 required signatures are BLANK:\n- Technical Lead: unsigned\n- QA Lead: unsigned\n- Product Owner: unsigned","created_at":"2026-01-10T20:29:23Z"},{"id":56,"issue_id":"askbot-master-uga","author":"devop","text":"## CRITICAL Findings (Third Pass Analysis)\n\n### 1. markdown2 Removal Status (Rollback Implications)\n\n| Location | Status |\n|----------|--------|\n| askbot_requirements.txt | ❌ REMOVED (not listed) |\n| load_stackexchange.py line 34 | COMMENTED OUT (`#from markdown2`) |\n| jive.py | Reference in docstring only, not imported |\n| Virtual env (env312/) | Still installed (leftover) |\n\n**Rollback Plan Issue:** Overview says \"markdown2 still available as fallback\" but markdown2 is NO LONGER A DEPENDENCY. Rollback requires:\n1. Revert commits\n2. Reinstall markdown2\n\n### 2. CRITICAL: Goal 4 Has ZERO Verification\n\n**Goal 4:** \"Ensure existing content renders identically after migration\"\n\n| Required | Status |\n|----------|--------|\n| Migration script to test existing posts | ❌ NOT CREATED |\n| Comparison tests (markdown2 vs markdown-it output) | ❌ NONE EXIST |\n| Visual regression tests | ❌ NOT SET UP |\n| Production data testing | ❌ NOT DONE |\n\n**This is the HIGH probability, HIGH impact risk in the Risk Assessment table - and NONE of its mitigations are implemented.**\n\n### 3. 95%+ Coverage Criteria Unverifiable\n\n| Required | Status |\n|----------|--------|\n| Coverage tooling (pytest-cov, coverage.py) | ❌ Not configured |\n| Coverage reports | ❌ Not generated |\n| Coverage thresholds | ❌ Not defined |\n\n**The \"95%+ code coverage for new plugins\" success criterion CANNOT be verified.**\n\n### 4. Pygments Integration VERIFIED ✅\n\n```\nmarkup.py:19: from pygments import highlight as pygments_highlight\nmarkup.py:20: from pygments.lexers import get_lexer_by_name, guess_lexer\nmarkup.py:21: from pygments.formatters import HtmlFormatter\naskbot/__init__.py:42: 'pygments': 'pygments\u003e=2.15.0'\n```\n\nPygments is properly imported, used, and in requirements.\n\n### 5. Project Goals Progress Assessment\n\n| # | Goal | Status |\n|---|------|--------|\n| 1 | Upgrade backend to markdown-it-py 4.0.0 | ✅ DONE |\n| 2 | Migrate frontend from Showdown to markdown-it.js | ❌ NOT STARTED |\n| 3 | Implement custom plugins | ⚠️ 80% DONE (emphasis bug) |\n| 4 | Existing content renders identically | ❌ NOT VERIFIED |\n| 5 | Zero downtime deployment | ❓ N/A (Phase 3) |\n\n### 6. Phase 1 Success Criteria - Final Assessment\n\n| Criterion | Status | Evidence |\n|-----------|--------|----------|\n| markdown-it-py 4.0.0 | ✅ DONE | askbot_requirements.txt line 24 |\n| Video embedding plugin | ✅ DONE | video_embed.py verified |\n| Link patterns plugin | ✅ DONE | link_patterns.py verified |\n| Code-friendly mode | ⚠️ BUGGY | Disables ALL emphasis |\n| Pygments highlighting | ✅ DONE | markup.py imports verified |\n| 95%+ code coverage | ❌ UNVERIFIABLE | No tooling configured |\n| All backend tests passing | ✅ DONE | 35/35 pass (askbot-master-35c) |\n| Manual testing | ❓ NOT DOCUMENTED | No records |\n\n**Phase 1 Completion: 5/8 criteria fully met, 1 buggy, 2 unverifiable/undocumented**","created_at":"2026-01-10T20:32:29Z"}]}
{"id":"askbot-master-ulk","title":"Improve looks of the html renderings of all supported markdown constructs","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-13T11:00:50.156515-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-13T11:00:50.156515-03:00","comments":[{"id":82,"issue_id":"askbot-master-ulk","author":"Evgeny Fadeev","text":"Suggestion: Create dedicated file for markdown-rendered content styles\n\nCurrently `components/editors/wmd.scss` contains shared styling for both `.wmd-preview` and `.js-editable-content` (lines 93-107). \n\nRecommendation: Create `askbot/media/sass/components/markdown_content.scss` to hold styles for rendered markdown/HTML content.\n\nReasons:\n- Separation of concerns: `wmd.scss` is for editor UI (buttons, textarea), not content rendering\n- Applies to multiple contexts: saved posts, live preview, comments\n- Easier to find and maintain\n- Move applicable styles from wmd.scss to this new file","created_at":"2026-01-25T19:42:42Z"}]}
{"id":"askbot-master-uq7","title":"Create a python and js plugins for markdown-it for mermaid diagrams; add help support for mermaid MD (define scope for this)","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-18T18:16:48.259835-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-18T18:33:36.320574-03:00","comments":[{"id":94,"issue_id":"askbot-master-uq7","author":"Evgeny Fadeev","text":"## Mermaid Diagram Support - Investigation Findings\n\n### Goal\nAdd support for ```mermaid fenced blocks to render diagrams in both Python backend and JavaScript preview, without conflicting with regular code blocks.\n\n### Architecture Decision\nUse the **@@...@@ protection pattern** (like video/math): extract mermaid blocks before markdown processing, replace with placeholders, restore after sanitization. This avoids adding SVG elements to the HTML sanitizer allowlist.\n\n### Rendering Approaches Investigated\n\n**Dual rendering (ideal):**\n- Server-side: Render SVG on save (no flash of unrendered content)\n- Client-side: Mermaid.js for live preview while editing\n\n### Python Rendering Options\n\nUnfortunately, **no pure Python implementation** of Mermaid exists that's identical to the JS library:\n\n| Library | Approach | Dependency |\n|---------|----------|------------|\n| mmdc (Python) | PhantomJS via phasma | PhantomJS binary |\n| mermaid-cli-python | Ported from mermaid-cli | JS engine |\n| mermaid-py | mermaid.ink API | Web service or Docker |\n| mermaid-cli (Node) | Official tool | Node.js + npm |\n\n**Why no native Python port:**\n- Mermaid is ~50k lines of JavaScript\n- Uses browser DOM/SVG APIs for rendering\n- Constantly updated with new diagram types\n- Porting would create perpetual maintenance burden\n\n### Available Options\n\n1. **mermaid.ink API** - HTTP call to `https://mermaid.ink/svg/{base64}` - simple but requires internet\n2. **mermaid-cli (Node)** - Install via npm, call via subprocess - most complete but Node dependency\n3. **mmdc (PhantomJS)** - Python package with bundled PhantomJS - self-contained binary\n4. **Client-side only** - Use @@...@@ pattern, render in browser with loading placeholder\n\n### Files to Modify (when implemented)\n\n1. `askbot/utils/markup.py` - Add mermaid protect/render/restore functions\n2. `askbot/media/wmd/askbot_converter.js` - Add mermaid handling for live preview\n3. `askbot/jinja2/meta/markdown_javascript.html` - Load Mermaid.js\n4. `askbot/media/css/style.css` - Add mermaid styles\n\n### Decision Needed\nChoose rendering approach based on acceptable dependencies and whether FOUC (flash of unrendered content) is acceptable.","created_at":"2026-01-27T18:52:59Z"},{"id":95,"issue_id":"askbot-master-uq7","author":"Evgeny Fadeev","text":"## Checkpoint: 2026-01-27 21:15\n\n### Work Completed\n- Deep analysis of Mermaid.js codebase architecture (~68k lines TS/JS, 450 files)\n- Analyzed D3 dependencies used by Mermaid:\n  - d3-selection: 1,057 lines (DOM wrapper - NOT needed for Rust port)\n  - d3-shape: 2,193 lines (pure math - portable)\n  - d3-scale: 1,302 lines (simple math)\n  - dagre: 2,968 lines (graph layout algorithm)\n  - graphlib: 1,465 lines (replaceable with petgraph)\n- Identified actual D3 usage in Mermaid: ~5,000 calls, mostly `attr()` (3,134), `append()` (684), `select()` (169)\n- Cloned repos for analysis: mermaid, d3, d3-selection, d3-shape, d3-scale, dagre, graphlib\n\n### Research Findings\n\n**Python Native Mermaid Options:**\n- No pure Python Mermaid implementation exists\n- Available options: mermaid-cli (Node), mermaid.ink API, mmdc (PhantomJS)\n- All require external dependencies\n\n**Rust/WASM Port Feasibility:**\n- d3-selection (DOM manipulation) → NOT needed, replace with SVG builder\n- d3-shape (curves, arcs) → ~1,000 lines pure math, easily portable\n- dagre layout → ~3,000 lines, or use petgraph crate\n- Mermaid parser/renderer → ~5,000 lines for flowcharts only\n\n**Estimated WASM Sizes:**\n- Full Mermaid: ~600KB-1.2MB optimized, ~200-500KB gzipped\n- Flowcharts only: ~150-250KB optimized, ~60-100KB gzipped\n- Current mermaid.min.js: 3.3MB (so WASM would be smaller)\n\n### Decisions Made\n- Use @@...@@ protection pattern for mermaid blocks (avoids sanitizer changes)\n- Server-side rendering preferred (no FOUC) but requires external dependency\n- Client-side rendering acceptable for live preview\n\n### Questions Raised\n- Is a Rust/WASM port of Mermaid flowcharts worth pursuing?\n- Could Claude Code mechanically port it using test-driven approach?\n\n### Next Steps\n- Decide on rendering approach: client-only, mermaid.ink API, or external tool\n- Consider creating separate project for Rust/WASM Mermaid subset\n- For immediate needs: implement client-side only with @@...@@ pattern\n","created_at":"2026-01-28T00:09:33Z"},{"id":96,"issue_id":"askbot-master-uq7","author":"Evgeny Fadeev","text":"## Checkpoint: 2026-01-28 Session 2\n\n### Work Completed\n- Resumed work by reviewing previous checkpoint findings\n- Discussed rendering approach options in detail:\n  - Client-side only (Mermaid.js with @@...@@ pattern)\n  - mermaid.ink API (external service)\n  - mermaid-cli (Node.js dependency)\n  - Hybrid approach (client for preview, server for final)\n\n### Questions Raised\n- Would WASM port be fast enough for live preview?\n- What diagram types does Mermaid support beyond flowcharts?\n\n### Research Findings\n\n**WASM Performance for Live Preview:**\n- Yes, WASM would be fast enough - likely faster than Mermaid.js\n- Simple flowcharts: 5-20ms (vs 10-50ms JS)\n- Medium diagrams: 20-60ms (vs 50-150ms JS)\n- Benefits: faster parsing, no GC pauses, smaller bundle (60-100KB vs 3.3MB)\n\n**Mermaid Diagram Types (17 total):**\n- Flowchart, Sequence, Class, State, ER Diagram, Gantt, Pie Chart\n- Quadrant, Git Graph, Mindmap, Timeline, User Journey\n- Sankey, XY Chart, Block, Requirement, C4\n\n**Why flowcharts-only is smaller:**\n- Each type needs: parser + layout engine + renderer\n- Flowcharts alone: ~5,000 lines\n- Full Mermaid: ~50,000+ lines\n\n**Most commonly used:** Flowcharts, Sequence, Class, ER diagrams\n\n### Decisions Made\n- None finalized yet - still discussing approach\n\n### Next Steps\n- Decide on rendering approach (client-only vs hybrid)\n- Decide on scope (all types vs flowcharts-only vs top 3-4 types)\n- Implement chosen approach\n","created_at":"2026-01-28T13:02:33Z"}]}
{"id":"askbot-master-xeq","title":"Add test: email auto-linking converts to mailto links","description":"## Context\nThe linkify plugin (via linkify-it-py) should auto-detect email addresses and convert them to `mailto:` links. This is default behavior but has no test coverage.\n\n## Task\nAdd a test to verify email addresses are correctly auto-linked.\n\n## Test Location\n`askbot/tests/test_markdown_integration.py` or `askbot/tests/test_markup.py`\n\n## Test Cases\n```python\ndef test_email_autolink(self):\n    \"\"\"Email addresses should be converted to mailto links\"\"\"\n    text = \"Contact user@example.com for help\"\n    html = markdown_input_converter(text)\n    assert 'href=\"mailto:user@example.com\"' in html\n    assert '\u003euser@example.com\u003c/a\u003e' in html\n\ndef test_email_autolink_multiple(self):\n    \"\"\"Multiple email addresses should all be linked\"\"\"\n    text = \"Email alice@example.com or bob@test.org\"\n    html = markdown_input_converter(text)\n    assert 'mailto:alice@example.com' in html\n    assert 'mailto:bob@test.org' in html\n```\n\n## Acceptance Criteria\n- [ ] Test verifies email addresses become mailto: links\n- [ ] Test uses `markdown_input_converter()` for full pipeline coverage\n- [ ] Test passes with current implementation\n\n## Related\n- Source: tasks/markdown-upgrade-status.md section 1.2 (Coverage Gaps)\n- linkify-it-py handles email detection by default","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T21:39:59.752903-03:00","created_by":"devop","updated_at":"2026-01-11T14:09:42.631714-03:00","closed_at":"2026-01-11T14:09:42.631714-03:00","close_reason":"Closed","dependencies":[{"issue_id":"askbot-master-xeq","depends_on_id":"askbot-master-q54","type":"blocks","created_at":"2026-01-10T22:01:24.54205-03:00","created_by":"devop"}]}
{"id":"askbot-master-xmd","title":"Test all the recommendations in the editor help panel manually and verify that they are accurate","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-13T10:56:09.99384-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-13T10:56:09.99384-03:00"}
{"id":"askbot-master-yhg","title":"HTML help tab causes parent width to change when selected","description":"## Problem\n\nWhen switching to the HTML tab in the editor help panel, the width of a parent element changes, causing a visual jump/shift.\n\n## Investigation Done\n\n- The HTML tab renders many inline `\u003ccode\u003e` tags (~30 in 'Formatting tags' category)\n- Attempted fixes that didn't work:\n  - `flex-wrap: wrap` on tag container\n  - `overflow: hidden` on `.help-panel-content` and `.help-content`\n  - `max-width: 100%` on `.help-content`\n  - `word-wrap: break-word` on `.help-note`\n\n## Next Steps\n\n- Use browser dev tools to identify exactly which element is changing width\n- The issue may be higher up in the DOM tree (editor container, not just help panel)\n- May need to constrain width at a higher level or use different layout approach\n\n## Files Involved\n\n- `askbot/media/wmd/help-panel/src/HelpPanel.svelte`\n- `askbot/media/wmd/help-panel/src/tabs/HtmlHelp.svelte`\n- Possibly editor container CSS","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-22T14:04:46.260324-03:00","created_by":"Evgeny Fadeev","updated_at":"2026-01-25T16:29:59.511147-03:00","closed_at":"2026-01-25T16:29:59.511147-03:00","close_reason":"fixed: needed to add overflow-hidden to one of the up-che-chain parents"}
{"id":"askbot-master-z64","title":"Delete tasks/markdown-upgrade-status.md and tasks/ directory","description":"## Context\nAfter both backend and frontend markdown migration is complete, the status tracking file is no longer needed.\n\n## Task\n1. Delete `tasks/markdown-upgrade-status.md`\n2. Check if `tasks/` directory has any other files\n3. If empty, delete the `tasks/` directory\n\n## Acceptance Criteria\n- [ ] tasks/markdown-upgrade-status.md is deleted\n- [ ] tasks/ directory is deleted if no other files remain\n- [ ] Changes committed","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-10T22:42:15.453137-03:00","created_by":"devop","updated_at":"2026-01-10T22:42:15.453137-03:00","dependencies":[{"issue_id":"askbot-master-z64","depends_on_id":"askbot-master-37j","type":"blocks","created_at":"2026-01-10T22:42:43.461178-03:00","created_by":"devop"}]}
{"id":"askbot-master-zog","title":"Create bd issues for markdown backend completion","description":"⚠️ REQUIRES INTERACTIVE SESSION: Review and approve issue plan before creating.\n\nCreate bd issues from tasks/markdown-upgrade-status.md section 7 'Recommended Work Issues'.\n\nBackend issues to create (from status document):\nHIGH PRIORITY:\n1. Fix code-friendly mode emphasis handling (only disable _ not *)\n2. Add math protection integration tests (linkify/patterns/emphasis in math)\n3. Add missing test coverage (email auto-link, javascript: URLs)\n\nMEDIUM PRIORITY:\n4. Add test for asterisk emphasis in code-friendly mode\n\nLOW PRIORITY:\n5. Remove stale code comments (TODO at markup.py:150, test_markup.py:76-80)\n6. Update documentation references\n\nIssues should be properly chained with dependencies where applicable.\nReference the status document for full context on each issue.\n\n---\nBEFORE STARTING: Walk through proposed issues with user for approval.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T20:35:52.388233-03:00","created_by":"devop","updated_at":"2026-01-10T22:02:51.917945-03:00","closed_at":"2026-01-10T22:02:51.917945-03:00","close_reason":"Closed"}
